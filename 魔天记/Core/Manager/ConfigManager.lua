--  配置管理  
ConfigManager = {};
ConfigManager.CONFIGNAME_PRODUCT = "product";
ConfigManager.CONFIGNAME_PRODUCT_ATTR = "product_attr"
ConfigManager.CONFIGNAME_PRODUCT_ATLAS = "iconAtlas"
ConfigManager.CONFIGNAME_CAREER = "career"
ConfigManager.CONFIGNAME_CAREER_ATTR = "career_attr"
ConfigManager.CONFIGNAME_CAREER_EXP = "career_exp"
ConfigManager.CONFIGNAME_MONSTER = "monster"
ConfigManager.CONFIGNAME_MONSTER_ATTR = "monster_attr"
ConfigManager.CONFIGNAME_MONSTER_ATTR_RATIO = "monster_attr_ratio"

ConfigManager.CONFIGNAME_SKILL = "skill"
ConfigManager.CONFIGNAME_SKILLSTAGE = "skillstage"
ConfigManager.CONFIGNAME_SKILL_EFFECT = "skill_effect"
ConfigManager.CONFIGNAME_SKILL_EXIST_EFFECT = "skill_exist_effect"
ConfigManager.CONFIGNAME_SKILL_RECOMMEND = "skill_recommend";
ConfigManager.CONFIGNAME_SKILL_CD = "skill_cd";
ConfigManager.CONFIGNAME_TIPBUTTONCONTAINER = "tipButtonContainer";
ConfigManager.CONFIGNAME_MAP = "map";
ConfigManager.CONFIGNAME_MAP_PORTAL = "map_portal";
ConfigManager.CONFIGNAME_MAP_EFFECT = "map_effect";
ConfigManager.CONFIGNAME_BUFF = "buff";
ConfigManager.CONFIGNAME_MOUNT = "mount";
ConfigManager.CONFIGNAME_MOUNT_ATT_MOD = "mount_att_mod";

ConfigManager.CONFIGNAME_INSTANCE = "instance"
ConfigManager.CONFIGNAME_NPC = "npc"
ConfigManager.CONFIGNAME_DIALOG = "dialog"
ConfigManager.CONFIGNAME_TASK = "task"
ConfigManager.CONFIGNAME_SYSTEM = "system_unlock"
ConfigManager.CONFIGNAME_RIDE = "ride"
ConfigManager.CONFIGNAME_RIDE_FEED = "ride_feed"
ConfigManager.CONFIGNAME_RIDE_FEED_EXP = "ride_feed_exp"

ConfigManager.CONFIGNAME_STRONG_EXP = "strong_exp"
ConfigManager.CONFIGNAME_POSTURE = "posture"
ConfigManager.CONFIGNAME_REFINE = "refine"
ConfigManager.CONFIGNAME_REFINE_ITEM = "refine_item"
ConfigManager.CONFIGNAME_EQUIPMENT_REFINE = "equipment_refine"
ConfigManager.CONFIGNAME_WING_ATTR = "wing_attr"
ConfigManager.CONFIGNAME_WING_FASHION = "wing_fashion"
ConfigManager.CONFIGNAME_GEM_PRICE = "gem_up"

ConfigManager.CONFIGNAME_ARENA_REWARD = "arena_reward"
ConfigManager.CONFIGNAME_SHOP = "shop"
ConfigManager.CONFIGNAME_STAR_LEVEL_ATTR = "star_level_attr"
ConfigManager.CONFIGNAME_MOULDING_ITEM = "moulding_item"
ConfigManager.CONFIGNAME_TREASURETYPE = "suit"
ConfigManager.CONFIGNAME_VIP = "vip"
ConfigManager.CONFIGNAME_VIP_CARD = "vip_card"
ConfigManager.CONFIGNAME_CHARGEP = "recharge"
ConfigManager.CONFIGNAME_CHARGEREFECTID = "platform_spid"

ConfigManager.CONFIGNAME_BUYPVPTIME = "need_money"
ConfigManager.CONFIGNAME_TRUMP = "trump"
ConfigManager.CONFIGNAME_TRUMPEXP = "trump_exp"
ConfigManager.CONFIGNAME_TRUMPREFINED = "trump_refined"
ConfigManager.CONFIGNAME_TRUMPSKILL = "trump_skill"
ConfigManager.CONFIGNAME_KNOCKBACK = "knockback"
ConfigManager.CONFIGNAME_LOTTERY = "lottery"
ConfigManager.CONFIGNAME_OBSTACLE = "obstacle"
ConfigManager.CONFIGNAME_SCENES_POS = "scenes_pos"
ConfigManager.CONFIGNAME_TALENT = "talent"
ConfigManager.CONFIGNAME_TALENT_MAIN = "talent_main"
ConfigManager.CONFIGNAME_GUILDLEVEL = "tong_information";
ConfigManager.CONFIGNAME_GUILDGRANT = "tong_power";
ConfigManager.CONFIGNAME_GUILDEXTEND = "tong_extend";
ConfigManager.CONFIGNAME_GUILDSKILL = "tong_skill";
ConfigManager.CONFIGNAME_GUILDWAR = "tongbattle_config";
ConfigManager.CONFIGNAME_GUILDWAR_POS = "tongbattle_pos";
ConfigManager.CONFIGNAME_MESSAGE = "message";
ConfigManager.CONFIGNAME_QUESTION = "question";
ConfigManager.CONFIGNAME_OFFLINE_REWARD = "offline_reward";
ConfigManager.CONFIGNAME_FORMULA = "formula";
ConfigManager.CONFIGNAME_DAYSRANK = "service_activity";
ConfigManager.CONFIGNAME_MAP_POINT_CHECK = "map_checkpoint";
ConfigManager.CONFIGNAME_OBJECT = "object";
ConfigManager.CONFIGNAME_MOVE_PATH_PREFAB = "move_path_prefab";
ConfigManager.CONFIGNAME_ONLINE_REWARD = "online_reward";
ConfigManager.CONFIGNAME_EQUIPMENT_STRONG = "equipment_strong"
ConfigManager.CONFIGNAME_EQUIPMENT_STRONG_RATIO = "equipment_strong_ratio"
ConfigManager.CONFIGNAME_EQUIPMENT_PROMOTE_RATIO = "equipment_promote_ratio"

ConfigManager.CONFIGNAME_ACHIEVEMENT = "achievement"
ConfigManager.CONFIGNAME_ACHIEVEMENT_TYPE = "achievement_type"
ConfigManager.CONFIGNAME_TITLE = "title"
ConfigManager.CONFIGNAME_TITLE_TYPE = "title_type"
ConfigManager.CONFIGNAME_PLOT_EVENTS = "plotevents"
ConfigManager.CONFIGNAME_NEW_TRUMP = "new_trump"
ConfigManager.CONFIGNAME_NEW_TRUMP_REFINE = "new_trump_refined"
ConfigManager.CONFIGNAME_FIELD_MONSTER = "field_monster"
ConfigManager.CONFIGNAME_FIELD_MONSTER_EXTEND = "field_monster_extend"
ConfigManager.CONFIGNAME_EXPERIENCE_LEV = "team_match"
ConfigManager.CONFIGNAME_MALLLABEL = "store_label"
ConfigManager.CONFIGNAME_NOTICE = "notice"
ConfigManager.CONFIGNAME_BOSS_BASE = "boss_base"
ConfigManager.CONFIGNAME_BOSS_TIME = "boss_time"
ConfigManager.CONFIGNAME_RELIVE = "relive"
ConfigManager.CONFIGNAME_SALE = "consign_type"
ConfigManager.CONFIGNAME_REALM = "realm"
ConfigManager.CONFIGNAME_REALM_COMPACT = "realm_compact"
ConfigManager.CONFIGNAME_FIGHAT_CAPACITY = "fighting_capacity"
ConfigManager.CONFIGNAME_SIGNIN = "sign_in"
ConfigManager.CONFIGNAME_WEAL = "weal"
ConfigManager.CONFIGNAME_RESIGNSPEND = "sign_in_expend"
ConfigManager.CONFIGNAME_AUTO_FIGHT_PATH = "auto_fight_path"
ConfigManager.CONFIGNAME_RECHARGE_REWARD = "recharge_reward"
ConfigManager.CONFIGNAME_LOGIN_REWARD = "login_reward"
ConfigManager.CONFIGNAME_STRONG_LEVEL = "strong_lev"
ConfigManager.CONFIGNAME_STRONG_FIGHT = "strong_fight"
ConfigManager.CONFIGNAME_STRONG_BASE = "strong_base"
ConfigManager.CONFIGNAME_RECHARGE_GIFT = "recharge_gift"
ConfigManager.CONFIGNAME_GUIDE = "guide";
ConfigManager.CONFIGNAME_LOADING_INFO = "loading_info";
ConfigManager.CONFIGNAME_FARM_EXTEND = "farm_extend";
ConfigManager.CONFIGNAME_GROWTH_GIFT = "growth_gift";
ConfigManager.CONFIGNAME_BATTLEGROUND_AWARD = "battleground_award";
ConfigManager.CONFIGNAME_BATTLEGROUND_CONFIG = "battleground_config";
ConfigManager.CONFIGNAME_BATTLEGROUND_POINT = "battleground_point";
ConfigManager.CONFIGNAME_BATTLEGROUND_TIME = "battleground_time";
ConfigManager.CONFIGNAME_SERVICE_LEVELING = "service_leveling";
ConfigManager.CONFIGNAME_APP_SPLIT = "minipack";

ConfigManager.CONFIGNAME_MONSTER_WEAPON = "monsterweapon";
ConfigManager.CONFIGNAME_ALERT_TEXT = "txt";
ConfigManager.CONFIGNAME_PROMOTE_PLUS = "promote_plus";
ConfigManager.CONFIGNAME_PROMOTE_RATE = "promote_rate";
ConfigManager.CONFIGNAME_RED_PACKET = "red_packet"
ConfigManager.CONFIGNAME_STORE = "store"
ConfigManager.CONFIGNAME_PROMOTE_POSITION = "promote_position"
ConfigManager.CONFIGNAME_ACTIVITY = "activity"
ConfigManager.CONFIGNAME_ACTIVITY_REWARD = "activity_reward"
ConfigManager.CONFIGNAME_CONDITION = "condition"
ConfigManager.CONFIGNAME_FARM_PLANT = "farm_plant"
ConfigManager.CONFIGNAME_FARM_BASE = "farm_base"
ConfigManager.CONFIGNAME_FARM_GUARD = "farm_guard"
ConfigManager.CONFIGNAME_FARM_STEAL = "farm_steal"
ConfigManager.CONFIGNAME_FARM_LEVEL = "farm_level"
ConfigManager.CONFIGNAME_FIGHTING_CAPACITY = "fighting_capacity"
ConfigManager.CONFIGNAME_ELIXIR = "elixir"
ConfigManager.CONFIGNAME_PRODUCT_TIPS = "product_tips"
ConfigManager.CONFIGNAME_TONG_MONSTER = "tong_monster"
ConfigManager.CONFIGNAME_TONG_ACTIVITY_AWARD = "tong_activity_award"
ConfigManager.CONFIGNAME_LANGUAGE = "language"
ConfigManager.CONFIGNAME_AUTO_SET = "auto_set"
ConfigManager.CONFIGNAME_BATTLEGROUND_CONFIG = "battleground_config"
ConfigManager.CONFIGNAME_GETEQUIPTIP = "getEquipTip"
ConfigManager.CONFIGNAME_LOT = "pray"
ConfigManager.CONFIGNAME_WILDBOSS = "field_boss"
ConfigManager.CONFIGNAME_VIP_WILDBOSS = "vip_field_boss"
ConfigManager.CONFIGNAME_ENDLESSTRY = "endless"
ConfigManager.CONFIGNAME_PROMOTE_EFFECT = "promote_effect"
ConfigManager.CONFIGNAME_PROMOTE_COLOR = "promote_color"
ConfigManager.CONFIGNAME_HARDWARE_QUALITY = "hardware"
ConfigManager.CONFIGNAME_TABOO = "tabooland"
ConfigManager.CONFIGNAME_TIME_LIMIT_ACT = "yunying_time";
ConfigManager.CONFIGNAME_TACT_SEVENDAY = "yunying_sevenreward";
ConfigManager.CONFIGNAME_TACT_SEVENDAY_DETAIL = "yunying_sevenday";

ConfigManager.CONFIGNAME_SCENCE_PROP = "scene_prop"
ConfigManager.CONFIGNAME_XUANBAOTYPE = "treasure_reward"
ConfigManager.CONFIGNAME_XUANBAO = "treasure"

ConfigManager.CONFIGNAME_SUIT_MATERIALS = "suit_materials"
ConfigManager.CONFIGNAME_SUIT_POSITION = "suit_position"
ConfigManager.CONFIGNAME_FAIRY = "fairy"
ConfigManager.CONFIGNAME_AUTO_FIELD = "auto_activity"
ConfigManager.CONFIGNAME_FAIRY_GROOVE_POS = "fairy_groove_pos"
ConfigManager.CONFIGNAME_FAIRY_GROOVE_VALUE = "fairy_groove_value"

ConfigManager.CONFIGNAME_FAIRY_ATTRIBUTE = "fairy_attribute"
ConfigManager.CONFIGNAME_FAIRY_FORGING = "fairy_forging"


ConfigManager.CONFIGNAME_EXP_ADD = "exp_grade"
ConfigManager.CONFIGNAME_PRIZE = "prize"
ConfigManager.CONFIGNAME_MOBAO = "magic_cimelia"
ConfigManager.CONFIGNAME_MOBAO_EFFECT = "magic_effect"

ConfigManager.CONFIGNAME_ROLE_BONE = "role_bone"

ConfigManager.CONFIGNAME_IMMORTAL_SHOP_LIST = "festival_buy"
ConfigManager.CONFIGNAME_IMMORTAL_SHOP_CONSUME = "festival_consume"
ConfigManager.CONFIGNAME_IMMORTAL_SHOP_ALL = "festival_all"
ConfigManager.CONFIGNAME_IMMORTAL_SHOP_POINT = "festival_point"
ConfigManager.CONFIGNAME_FORMATION = "graphic"
ConfigManager.CONFIGNAME_FORMATION_ATT = "graphic_attr"
ConfigManager.CONFIGNAME_FORMATION_SKILL = "graphic_skill"

ConfigManager.CONFIGNAME_EFFORT = "effort"
ConfigManager.CONFIGNAME_PUBLIC_NOTICE = "public_notice"
ConfigManager.CONFIGNAME_ITEM_MOVE = "item_move"
ConfigManager.CONFIGNAME_WEEK_LIST = "week_list"
ConfigManager.CONFIGNAME_GRADE = "grade"

ConfigManager.CONFIGNAME_STAR = "star"
ConfigManager.CONFIGNAME_STAR_ATT = "star_exp"
ConfigManager.CONFIGNAME_STAR_EXPEND = "star_expend"
ConfigManager.CONFIGNAME_STAR_OPEN = "star_open"

ConfigManager.CONFIG_PET = "partner"
ConfigManager.CONFIG_PET_LEVELUP = "partner_levelup"
ConfigManager.CONFIG_PET_ADVANCE = "partner_advance"
ConfigManager.CONFIG_PET_TRANSFORM = "partner_transform"
ConfigManager.CONFIG_PET_EFFECTCONFIG = "partner_ui_effect"

ConfigManager.CONFIG_LEVEL_LIMIT = "level_cap"

ConfigManager.CONFIG_MODEL_EFFECT = "model_effect"
ConfigManager.CONFIG_TREASURE_BOX = "treasure_box"

ConfigManager.CONFIG_MID_AUTUMN = "mid_autumn"
ConfigManager.CONFIG_MID_RECHARGE = "recharge_reward"
ConfigManager.CONFIG_MID_EXCHANGE = "item_exchange"
ConfigManager.CONFIGNAME_CLOUDPURCHASE = "purchasing"
ConfigManager.CONFIGNAME_CASHGIFTS = "xianjin"

ConfigManager.CONFIG_YAOSHOU_BOSS = "legend_boss"



--[[ConfigManager.configKey = "taaa"
local tt = os.clock()
for k,v in pairs(ConfigManager) do
    if type(v) == "table" then
        --Warning(tostring(k) .. "___" ..tostring(v).. "___" ..tostring(table.getCount(v)))
        local ks = v.keys
        table.remove(v)
        v.keys = nil
        --Warning(tostring(v.keys) .. "___" ..tostring(v).. "___" ..tostring(table.getCount(v)))
        for kk,vv in pairs(v) do
            if type(vv) == "table" then
                local aa = { taaa = vv, ks = ks }
                setmetatable(aa, { 
                    __index = function(t, k)
                        --Warning(tostring(t) .. tostring(k) .. tostring(t.ks))
                        local ind = t.ks[k]
                        --Warning(k  .. "___" .. tostring(t.taaa) .. "___" .. tostring(ind) .. "___" .. tostring(t.ks))
                        return t.taaa[ind]
                    end
--                     ,__newindex = function(t, k, v)
--                        --Warning(tostring(t) .. tostring(k) .. tostring(v))
--                        local ind = t.ks[k]
--                        t.taaa[ind] = v
--                    end
                })
                v[kk] = aa
            end
        end
    end
end
print("________", ( os.clock() - tt))
--]]
local tinsert = table.insert
local pairs = pairs
local CONFIG_KEY_NAME = "cks"
local tcopy = table.copy
--单条配置内容复制到目标(必须用), 传入单条配置config,目标对象des 
function ConfigManager.copyTo(config, des)
	if not config or not des then return end
	local ks = config[CONFIG_KEY_NAME]
	if not ks then table.copyTo(config, des) return end
	for k, v in pairs(ks) do
		v = config[v]
		if type(v) ~= "table" then
			des[k] = v
		else
			des[k] = tcopy(v)
		end
	end
end
--转换为标准的键值对配置, 传入单条配置config, 在循环单条配置时,如pairs, ipairs(必须用)
function ConfigManager.TransformConfig(config)
	if not config then return nil end
	local ks = config[CONFIG_KEY_NAME]
	if not ks then return config end
	local des = {}
	for k, v in pairs(ks) do
		v = config[v]
		if type(v) ~= "table" then
			des[k] = v
		else
			des[k] = tcopy(v)
		end
	end
	return des
end
--所有对象克隆(必须用)这个方法, 克隆对象object, 处理对象的配置属性(必须用)
function ConfigManager.Clone(object)	
	local lookup_table = {}
	local function _copy(object)
		if type(object) ~= "table" then
			return object
		elseif lookup_table[object] then
			return lookup_table[object]
		end
		local new_table = {}
		lookup_table[object] = new_table
		local ks = object[CONFIG_KEY_NAME]
		if not ks then
			for key, value in pairs(object) do
				new_table[_copy(key)] = _copy(value)
			end
			return setmetatable(new_table, getmetatable(object))
		else --配置克隆
			for k, v in pairs(ks) do
				v = object[v]
				if type(v) ~= "table" then
					new_table[k] = v
				else
					new_table[k] = tcopy(v)
				end
			end
			return new_table
		end
	end
	return _copy(object)
end


local _config = {}

function ConfigManager.GetConfig(configName)
	if(_config[configName] == nil) then		
		_config[configName] = require(string.format("Core.Config.%s", configName))	
	end
	return _config[configName]
end

function ConfigManager.GetEffort(id)
	local cf = ConfigManager.GetConfig(ConfigManager.CONFIGNAME_EFFORT)
	return cf[tonumber(id)];
end


--[[local c  = ConfigManager.GetConfig(ConfigManager.CONFIGNAME_SKILL)
log(table.getCount(c))
tt = os.clock()
for i=1,10000000 do
    local cc = c['212064_1']
    local t,tt,ttt = cc.name,cc.id,cc.shot_down
end
print("________", ( os.clock() - tt))
local copyt = {}
ConfigManager.copyTo(c['212064_1'], copyt)
for i,v in pairs(copyt) do print(i .. "__" .. tostring(v)) end
--]]
function ConfigManager.GetMonsterWeapon(id)
	local config = ConfigManager.GetConfig(ConfigManager.CONFIGNAME_MONSTER_WEAPON)
	return config[id]
end

function ConfigManager.GetMount(id)
	id = id + 0;
	local config = ConfigManager.GetConfig(ConfigManager.CONFIGNAME_MOUNT);
	return config[id];
end

function ConfigManager.GetMovePath(id)
	id = id + 0;
	local config = ConfigManager.GetConfig(ConfigManager.CONFIGNAME_MOVE_PATH_PREFAB);
	return config[id];
end


function ConfigManager.GetMountAtt(key)
	local config = ConfigManager.GetConfig(ConfigManager.CONFIGNAME_MOUNT_ATT_MOD);
	return config[key];
end

function ConfigManager.GetReliveConfig(t)
	return ConfigManager.GetConfig(ConfigManager.CONFIGNAME_RELIVE) [t]
end

function ConfigManager.Get_experience_lev()
	return ConfigManager.GetConfig(ConfigManager.CONFIGNAME_EXPERIENCE_LEV);
end

function ConfigManager.GetSkillById(id, level)
	local index = id .. "_" .. level
	local config = ConfigManager.GetConfig(ConfigManager.CONFIGNAME_SKILL)
	return config[index]
end

function ConfigManager.GetMapById(map_id)
	local config = ConfigManager.GetConfig(ConfigManager.CONFIGNAME_MAP)
	map_id = map_id + 0;
	return config[map_id];
end

local career = {}
function ConfigManager.GetCareerByKind(kind)
	if(career[kind] == nil) then
		career[kind] = ConfigManager.GetConfig(ConfigManager.CONFIGNAME_CAREER) [kind]
	end
	return career[kind]
end

function ConfigManager.GetNpcById(id)
	local config = ConfigManager.GetConfig(ConfigManager.CONFIGNAME_NPC);
	return config[id];
end

function ConfigManager.GetMonById(id)
	local config = ConfigManager.GetConfig(ConfigManager.CONFIGNAME_MONSTER);
	return config[id];
end

local _monsterAttr = {}
function ConfigManager.GetMonAtt(attr_calc, lv)
	local index = attr_calc .. "_" .. lv
	if(_monsterAttr[index] == nil) then
		local attr = ConfigManager.GetConfig(ConfigManager.CONFIGNAME_MONSTER_ATTR);
		local attrLev = attr[lv]
		local attr_radio = ConfigManager.GetConfig(ConfigManager.CONFIGNAME_MONSTER_ATTR_RATIO);
		local attr_radioLev = attr_radio[attr_calc]
		
		local result = BaseAttrInfo:New()
		result:Init(attrLev)
		result:MulByTable(attr_radioLev)
		result:Mul(0.001)
		if(attr_radio.is_ratio) then
			result.hp_max = result.hp_max * attrLev.ratio * 0.001
			result.phy_att = result.phy_att * attrLev.ratio * 0.001
			-- result.mag_att = result.mag_att * attrLev.ratio * 0.001
		end
		_monsterAttr[index] = result
	end
	
	return _monsterAttr[index]
	-- hp_max
	-- phy_att
	-- mag_att
end

function ConfigManager.GetProductById(id)
	local config = ConfigManager.GetConfig(ConfigManager.CONFIGNAME_PRODUCT);
	return config[tonumber(id)];
end

function ConfigManager.GetTrumpSkillByIdAndLevel(id, level)
	local index = id .. "_" .. level
	local config = ConfigManager.GetConfig(ConfigManager.CONFIGNAME_TRUMPSKILL)
	return config[index]
end

function ConfigManager.GetGuildLevelConfig(level)
	local config = ConfigManager.GetConfig(ConfigManager.CONFIGNAME_GUILDLEVEL)
	return config[level]
end

function ConfigManager.GetGuildGrantConfig(id)
	local config = ConfigManager.GetConfig(ConfigManager.CONFIGNAME_GUILDGRANT)
	return config[id]
end

local buffer = {}
--传入已经拼接好的id
function ConfigManager.GetBuffById(id)
	if(buffer[id] == nil) then
		local config = ConfigManager.GetConfig(ConfigManager.CONFIGNAME_BUFF)
		buffer[id] = config[id]
	end
	return buffer[id]
end
--返回按字段sortField,sortField2,升序的配置表
function ConfigManager.SortForField(source, sortField, sortField2)
	local t = {}
	for k, v in pairs(source) do tinsert(t, v) end
	if not sortField2 then
		table.sort(t, function(x, y) return x[sortField] < y[sortField] end)
	else
		table.sort(t, function(x, y)
			local xx = x[sortField]
			local yy = y[sortField]
			if xx ~= yy then return xx < yy
			else return x[sortField2] < y[sortField2] end
		end)
	end
	return t
end

function ConfigManager.GetLevelLimit(key)
	local config = ConfigManager.GetConfig(ConfigManager.CONFIG_LEVEL_LIMIT)
	return config[key].lev_max
end
