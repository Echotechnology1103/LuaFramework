---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by win 10.
--- DateTime: 2018/10/10 10:53
---
DungeonGoldEndPanel = DungeonGoldEndPanel or class("DungeonGoldEndPanel", BasePanel)
local this = DungeonGoldEndPanel

function DungeonGoldEndPanel:ctor()
    self.abName = "dungeon";
    self.image_ab = "dungeon_image";
    self.assetName = "DungeonGoldEndPanel"
    self.layer = "UI"

    self.model = DungeonModel.GetInstance()
    self.events = {};
    self.schedules = {};


    --DungeonCtrl:GetInstance().DungeonGoldEndPanel = self;
end

function DungeonGoldEndPanel:dctor()
    GlobalEvent:RemoveTabListener(self.events);
    if self.event_id_1 then
        self.model:RemoveListener(self.event_id_1)
        self.event_id_1 = nil
    end
    self:StopAllSchedules()
    self.model = nil;
    if self.enditem then
        self.enditem:destroy();
    end

    self.staritems = nil;
end

function DungeonGoldEndPanel:Open(data)
    self.data = data;
    WindowPanel.Open(self)
end

function DungeonGoldEndPanel:LoadCallBack()
    self.nodes = {
        "endCon",
        "win/passTime", "win/awardCon",
        "lose", "win", "win/winLabels/label3", "win/winLabels",
        "win/jingyan", "win/jingyanlogo", "win/huodejingyan",

        "win/prop/stars", "win/prop/stars/star_1", "win/prop/stars/star_2", "win/prop/stars/star_3",
        "win/prop", "win/prop/txt", "win/prop/txt/text_1", "win/prop/txt/text_2", "win/prop/txt/text_3",

        "lose/equip_1", "lose/equip_2", "lose/mount",
        "lose/jingyan_defeat", "lose/zhandoujiangli_defeat", "lose/jingyanlogo_defeat", "lose/huodejingyan_defeat",
    }
    self:GetChildren(self.nodes)
    local orderIndex = LayerManager:GetInstance():GetLayerOrderByName(self.layer)
    self:SetOrderIndex(orderIndex + 5)

    SetLocalPosition(self.transform, 0, 0, 0)
    --AddBgMask(self.gameObject, 0, 0, 0, 230);
    self:Init();

    self:AddEvent();

    if AutoFightManager:GetInstance():GetAutoFightState() then
        GlobalEvent:Brocast(FightEvent.AutoFight)
    end
end

--[[
{
	["coin"]=0,
	["star"]=0,
	["floor"]=1,
	["isClear"]=false
}



--]]
function DungeonGoldEndPanel:Init()
    print2(Table2String(self.data));
    self.enditem = DungeonEndItem(self.transform, self.data);

    self.passTime = GetText(self.passTime);
    self.label3 = GetText(self.label3);
    self.jingyan = GetText(self.jingyan);
    self.huodejingyan = GetText(self.huodejingyan);
    self.jingyanlogo = GetImage(self.jingyanlogo);

    self.jingyan_defeat = GetText(self.jingyan_defeat);
    self.huodejingyan_defeat = GetText(self.huodejingyan_defeat);
    self.jingyanlogo_defeat = GetImage(self.jingyanlogo_defeat);

    self.text_1 = GetText(self.text_1);
    self.text_2 = GetText(self.text_2);
    self.text_3 = GetText(self.text_3);

    self.staritems = {};--三颗星
    for i = 1, 3, 1 do
        self.staritems[i] = GetToggle(self["star_" .. i]);
        self.staritems[i].isOn = false;
    end

    if self.data then
        -- 成功界面
        if self.data.isClear == true then
            self.win.gameObject:SetActive(true);
            self.lose.gameObject:SetActive(false);

            if self.data.stype == enum.SCENE_STYPE.SCENE_STYPE_DUNGE_COIN then
                self.huodejingyan.text = "Gold obtained:";
                lua_resMgr:SetImageTexture(self, self.jingyanlogo, "system_image", "img_money_coin", true);
                self.passTime.gameObject:SetActive(false);
                self.winLabels.gameObject:SetActive(false);

                if self.data.star then
                    --啪啪啪三颗星
                    self.enditem:ShowStars(true);
                    local bs = BitState(self.data.star);
                    for i = 1, 3, 1 do
                        local isOn = toBool(bs:Contain(BitState.State[i]));
                        self.staritems[i].isOn = isOn;
                    end
                end

                if self.data.floor then
                    local data = Config.db_dunge_coin[self.data.floor];
                    if data then
                        local tab = String2Table(data.rating);
                        self.text_1.text = "Clear Dungeon";
                        if tab and #tab > 1 then
                            self.text_2.text = "Defeat<color=#13C110>" .. tostring(tab[1]) .. "</color>Vault guards";
                            self.text_3.text = "Defeat<color=#13C110>" .. tostring(tab[2]) .. "</color>Vault guards";

                            local localPos = self.text_1.transform.localPosition;
                            localPos.x = localPos.x + 500;
                            self.text_1.transform.localPosition = localPos;
                            local moveAction = cc.MoveTo(0.2, localPos.x - 500, localPos.y, localPos.z);
                            cc.ActionManager:GetInstance():addAction(moveAction, self.text_1.transform);

                            localPos = self.text_2.transform.localPosition;
                            localPos.x = localPos.x + 500;
                            self.text_2.transform.localPosition = localPos;
                            moveAction = cc.MoveTo(0.2, localPos.x - 500, localPos.y, localPos.z);

                            local delayAction = cc.DelayTime(0.1);
                            local moveAction1 = cc.Sequence(delayAction, moveAction);
                            cc.ActionManager:GetInstance():addAction(moveAction1, self.text_2.transform);
                            localPos = self.text_3.transform.localPosition;
                            localPos.x = localPos.x + 500;
                            self.text_3.transform.localPosition = localPos;
                            delayAction = cc.DelayTime(0.2);
                            moveAction = cc.MoveTo(0.2, localPos.x - 500, localPos.y, localPos.z);
                            moveAction1 = cc.Sequence(delayAction, moveAction);
                            cc.ActionManager:GetInstance():addAction(moveAction1, self.text_3.transform);
                        end
                    end
                end
                self.jingyan.text = GetShowNumber(self.data.coin);

            end
            -- 失败界面
        else
            self.win.gameObject:SetActive(false);
            self.lose.gameObject:SetActive(true);
            if self.data.stype == enum.SCENE_STYPE.SCENE_STYPE_DUNGE_COIN then
                self.huodejingyan_defeat.text = "Gold obtained:";
                lua_resMgr:SetImageTexture(self, self.jingyanlogo_defeat, "system_image", "img_money_coin", true);

                if self.data.floor then
                    local data = Config.db_dunge_coin[self.data.floor];
                    if data then
                        local tab = String2Table(data.rating);
                        if tab and #tab > 1 then
                            self.text_1.text = "Defeat<color=#13C110>" .. tostring(tab[1]) .. "</color>Vault guards";
                            self.text_2.text = "Defeat<color=#13C110>" .. tostring(tab[2]) .. "</color>Vault guards";
                        end
                    end
                end

                self.passTime.gameObject:SetActive(false);
                self.winLabels.gameObject:SetActive(false);
                self.jingyan_defeat.text = tostring(self.data.coin);

            end
        end
    end
end

local closeTime = 5;
function DungeonGoldEndPanel:AddEvent()

    local function closeCallBack()
        SceneControler:GetInstance():RequestSceneLeave();
        self:Close();
    end
    self.enditem:SetAutoCloseCallBack(closeCallBack);
    self.enditem:StartAutoClose(5);
    local function call_back()
        SceneControler:GetInstance():RequestSceneLeave();
        self:Close()
    end

    self.enditem:SetCloseCallBack(closeCallBack);

    self.events[#self.events + 1] = GlobalEvent:AddListener(DungeonEvent.LEAVE_DUNGEON_SCENE, call_back)

    self.event_id_1 = self.model:AddListener(DungeonEvent.ResEnterDungeonInfo, call_back)

    local call_back1 = function(target, x, y)
        GlobalEvent.BrocastEvent(MountEvent.OPEN_MOUNT_PANEL);
    end
    AddClickEvent(self.mount.gameObject, call_back1);

    local call_back2 = function(target, x, y)
        Notify.ShowText("Tap [Craft Gear]")--GlobalEvent.BrocastEvent(MountEvent.OPEN_MOUNT_PANEL);
    end
    AddClickEvent(self.equip_1.gameObject, call_back2);

    local call_back3 = function(target, x, y)
        Notify.ShowText("Tap [Forge]")--GlobalEvent.BrocastEvent(MountEvent.OPEN_MOUNT_PANEL);
    end
    AddClickEvent(self.equip_2.gameObject, call_back3);
end

function DungeonGoldEndPanel:StopAllSchedules()
    for i = 1, #self.schedules, 1 do
        GlobalSchedule:Stop(self.schedules[i]);
    end
    self.schedules = {};
end