---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by win 10.
--- DateTime: 2018/9/20 11:18
---

ExpEffPanel = ExpEffPanel or class("ExpEffPanel", WindowPanel)
local this = ExpEffPanel

function ExpEffPanel:ctor(parent_node, layer)
    self.abName = "dungeon"
    self.assetName = "ExpEffPanel"
    self.layer = "Bottom"
    self.events = {};

    self.panel_type = 4;
end

function ExpEffPanel:dctor()
    GlobalEvent:RemoveTabListener(self.events);
    destroyTab(self.items)
    self.items = {};
end

function ExpEffPanel:Open()
    WindowPanel.Open(self)
end

function ExpEffPanel:LoadCallBack()
    self.nodes = {
        "item_0", "ScrollView/Viewport/Content"
    }
    self:GetChildren(self.nodes)
    SetLocalPosition(self.transform, 0, 0, -1000);
    AddBgMask(self.gameObject);

    self:SetTileTextImage("dungeon_image", "dungeon_guwu_title");
    destroyTab(self.items);
    self.items = {};

    self.itemids = {
        [1] = 10015,
        [2] = 10016,
        [3] = 10017,
    }
    self.mallids = {
        [1] = 2206,
        [2] = 2206,
        [3] = 2206,
    }
    self.lastNum = {
    };

    self:InitItems();

    self:AddEvent();
end

function ExpEffPanel:InitItems()
    SetGameObjectActive(self.item_0.gameObject, true);

    destroyTab(self.items);
    self.items = {};

    local tab;
    local item
    for i = #self.itemids, 1 , -1 do
        if i > 2 then
            local num = BagModel:GetInstance():GetItemNumByItemID(self.itemids[i]);
            self.lastNum[self.itemids[i]] = num;
            if num > 0 then
                tab = self.itemids[i];
                item = newObject(self.item_0.gameObject);
                item.gameObject.name = "item_" .. i;
                self.items[i] = ExpEffUseItem(item, self.itemids[i], self.mallids[i]);
                self.items[i].transform:SetParent(self.Content.transform);
                SetLocalScale(self.items[i].transform, 1, 1, 1);
            end
        else
            tab = self.itemids[i];
            item = newObject(self.item_0.gameObject);
            item.gameObject.name = "item_" .. i;
            self.items[i] = ExpEffUseItem(item, self.itemids[i], self.mallids[i]);
            self.items[i].transform:SetParent(self.Content.transform);
            SetLocalScale(self.items[i].transform, 1, 1, 1);
        end

    end
    local rt = self.Content:GetComponent("RectTransform");
    rt.sizeDelta = Vector2(rt.sizeDelta.x, #self.itemids * 100)

    --if self.useItem_1 == nil then
    --    self.useItem_1 = MountUseItem(self.item_1, 50010)
    --end
    --if self.useItem_2 == nil then
    --    self.useItem_2 = MountUseItem(self.item_2, 50011)
    --end
    --if self.useItem_3 == nil then
    --    self.useItem_3 = MountUseItem(self.item_3, 50012)
    --end
    --if self.useItem_4 == nil then
    --    self.useItem_4 = MountUseItem(self.item_4, 50013)
    --end

    self.item_0.gameObject:SetActive(false);
end

function ExpEffPanel:AddEvent()

    local call_back3 = function()
        self:Close();
    end

    self.events[#self.events + 1] = GlobalEvent:AddListener(DungeonEvent.LEAVE_DUNGEON_SCENE, call_back3)

    local updateNumCallBack = function(data)
        --self:InitItems();
        for i = 1, #self.itemids do
            local itemid = self.itemids[i];
            local num = BagModel:GetInstance():GetItemNumByItemID(itemid);
            if num ~= self.lastNum[itemid] then
                self.lastNum[itemid] = num;
                self:InitItems();
                return ;
            end
        end
    end
    AddEventListenerInTab(BagEvent.UpdateGoods, updateNumCallBack, self.events);
end