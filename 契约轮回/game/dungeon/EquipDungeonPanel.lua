---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by win 10.
--- DateTime: 2018/10/9 17:34
--- 经验副本的UI
EquipDungeonPanel = EquipDungeonPanel or class("EquipDungeonPanel", DungeonMainBasePanel)
local this = EquipDungeonPanel

function EquipDungeonPanel:ctor()
    self.abName = "dungeon"
    self.imageAb = "dungeon_image";
    self.assetName = "EquipDungeonPanel"
    self.level = 1;
    self.events = {};
    self.schedules = {};
end

function EquipDungeonPanel:dctor()
    self.model = nil;
    GlobalEvent:RemoveTabListener(self.events);
    self:StopAllSchedules();
    self.level = nil;
    self.cur_wave = nil;
    self.max_wave = nil;
    self.end_time = nil;
    self.wave_etime = nil;

    if self.startSchedule then
        GlobalSchedule.StopFun(self.startSchedule);
    end
    self.startSchedule = nil;
    self.startDungeonTime = nil;
end

function EquipDungeonPanel:Open()
    WindowPanel.Open(self)
end

function EquipDungeonPanel:LoadCallBack()
    self.nodes = {
        "endTime/endTitleTxt", "endTime", "hardshow",
        "hardshow/bosshead", "hardshow/round", "hardshow/des", "hardshow/dun_name", "hardshow/killcd", "hardshow/current", "hardshow/kill_tip_bg1",
        "killtip", "killtip/kill_level", "killtip/kill_tip_bg", "killtip/kill_tip",
        "startTime","startTime/time",
    }
    self:GetChildren(self.nodes);

    SetLocalPosition(self.transform, 0, 0, 0)

    self:Init();
    self:AddEvent();

    SceneManager:GetInstance():SetMainRoleRotateY(45);

    SetAlignType(self.hardshow.transform, bit.bor(AlignType.Left, AlignType.Top))

    self:StartDungeonCD();
    --为了红点请求的
    DungeonCtrl:GetInstance():RequestDungeonPanel(enum.SCENE_STYPE.SCENE_STYPE_DUNGE_EQUIP);
end

function EquipDungeonPanel:StartDungeonCD()
    SetGameObjectActive(self.startTime , true);
    SetGameObjectActive(self.endTime.gameObject , false);
    local sceneInfo = SceneManager:GetInstance():GetSceneInfo();
    if sceneInfo then
        local dungeConfig = Config.db_dunge[sceneInfo.scene];

        if dungeConfig then
            local dungeInfo = Config.db_dunge[self.model.curDungeonID];
            if dungeInfo then
                self.dun_name.text = dungeInfo.name;
                self:SetBossHead(dungeInfo.icon)
            else
                self.dun_name.text = dungeConfig.name;
                self:SetBossHead(dungeConfig.icon)
            end

            local prep = dungeConfig.prep;
            self.startDungeonTime = os.time() + prep;
            --
            --self:SetBossHead();

            if self.startSchedule then
                GlobalSchedule.StopFun(self.startSchedule);
            end
            self.endDungeonStartCountDownFun = function()
                if self.startSchedule then
                    GlobalSchedule.StopFun(self.startSchedule);
                end
                self.startSchedule = nil;
                SetGameObjectActive(self.endTime.gameObject , true);
            end
            self.startSchedule = GlobalSchedule.StartFun(handler(self,self.HandleDungeonStartCountDown) , 0.2 , -1);
        end
    end
end

function EquipDungeonPanel:RequestInfo()
    --print2("请求经验副本信息");
    DungeonCtrl:GetInstance():RequeseExpDungeonInfo();
end



--killcd
--<color=#5BD022>58</color>秒内击败敌人
--首领难度将提升到:<color=#5BD022>普通</color>
function EquipDungeonPanel:Init()
    self.level = 1;
    self.endTitleTxt = GetText(self.endTitleTxt);--副本倒计时: 07:21
    self.kill_level = GetImage(self.kill_level);
    self.bosshead = GetImage(self.bosshead);
    self.round = GetText(self.round);--当前回合:    <color=#5BD022>1/5</color>
    self.des = GetText(self.des);
    self.dun_name = GetText(self.dun_name);
    self.killcd = GetText(self.killcd);
    self.current = GetText(self.current);--首领难度:    <color=#ff0000>炼狱</color>

    self.time = GetText(self.time);

    self.kill_tip = GetImage(self.kill_tip);
    self.kill_tip_bg = GetImage(self.kill_tip_bg);
    self.killcd.text = "";

    SetGameObjectActive(self.killtip, false);
    --self:SetHardLevel(2);
end
--设置boss的头像
function EquipDungeonPanel:SetBossHead(bossid)
    bossid = bossid or 50101;
    lua_resMgr:SetImageTexture(self, self.bosshead, "iconasset/icon_boss_head", bossid, false);
end
--服务端更新难度等级
function EquipDungeonPanel:SetHardLevel(num)
    num = num or 2;
    lua_resMgr:SetImageTexture(self, self.kill_level, self.imageAb, "dungeon_equip_" .. (num - 1), false);
    SetColor(self.kill_tip, 255, 255, 255, 255);
    SetColor(self.kill_tip_bg, 255, 255, 255, 255);
    SetColor(self.kill_level, 255, 255, 255, 255);
    SetGameObjectActive(self.killtip, true);
    local finishFun = function()
        SetColor(self.kill_tip, 255, 255, 255, 255);
        SetColor(self.kill_tip_bg, 255, 255, 255, 255);
        SetColor(self.kill_level, 255, 255, 255, 255);
        SetGameObjectActive(self.killtip, false);
    end
    local moveAction = cc.FadeOut(3, self.kill_tip);
    local moveAction1 = cc.FadeOut(3, self.kill_tip_bg);
    local moveAction2 = cc.FadeOut(3, self.kill_level);
    cc.ActionManager:GetInstance():addAction(moveAction, self.kill_tip.transform);
    cc.ActionManager:GetInstance():addAction(moveAction1, self.kill_tip_bg.transform);
    local fincall = cc.CallFunc(finishFun);
    local finAction = cc.Sequence(moveAction2, fincall);
    cc.ActionManager:GetInstance():addAction(finAction, self.kill_level.transform);
end

function EquipDungeonPanel:StartLeftTime(leftTime)
    leftTime = leftTime or os.time() + 59;
    if self.leftSchedule then
        StopSchedule(self.leftSchedule);
        self.leftSchedule = nil;
    end
    self.leftSchedule = GlobalSchedule.StartFun(handler(self, self.WaveEnd), 0.2, -1);
end

function EquipDungeonPanel:WaveEnd()

end

function EquipDungeonPanel:EndDungeon()
    local timeTab = nil;
    local timestr = "";
    local formatTime = "%02d";
    --整个副本的结束时间
    if self.end_time then
        if not self.startSchedule then
            SetGameObjectActive(self.endTime.gameObject, true);
        end

        timeTab = TimeManager:GetLastTimeData(os.time(), self.end_time);
        if table.isempty(timeTab) then
            Notify.ShowText("The dungeon is over. It's time to clean up");
            GlobalSchedule.StopFun(self.equipschedules);
        else
            if timeTab.min then
                timestr = timestr .. string.format(formatTime, timeTab.min) .. ":";
            end
            if timeTab.sec then
                timestr = timestr .. string.format(formatTime, timeTab.sec);
            end
            self.endTitleTxt.text = timestr;--"副本倒计时: " ..
        end
    end

    if self.wave_etime then
        timeTab = TimeManager:GetLastTimeData(os.time(), self.wave_etime);
        if table.isempty(timeTab) then
            if self.wave_etime == 0 then
                self.killcd.text = "";
                SetGameObjectActive(self.kill_tip_bg1, false);
            else
                self.killcd.text = "This round is over\nGood luck next time!";
                SetGameObjectActive(self.kill_tip_bg1, true);
            end
        else
            SetGameObjectActive(self.kill_tip_bg1, true);
            if timeTab.min then
                timestr = timestr .. string.format(formatTime, timeTab.min) .. ":";
            end
            if timeTab.sec then
                timestr = timestr .. string.format(formatTime, timeTab.sec);
            end
            local level = 1;
            level = tonumber(self.level) + 1;
            if level then
                if level < 1 then
                    level = 1;
                elseif level > 5 then
                    level = 5;

                    --return;
                end

            end
            self.killcd.text = "<color=#5BD022>" .. timeTab.sec .. "Defeat your enemy in </color>sec" .. "\nThe difficulty of boss encounter will be raised to:<color=#5BD022>" .. tostring(DungeonModel:GetInstance().hard_level[level]) .. "</color>";
        end
        --else
        --    self.killcd.text = "";
    end
    if self.cur_wave == self.max_wave then
        self.killcd.text = "Boos has been summoned!";
    end

    EquipDungeonPanel.super.EndDungeon(self);
end

function EquipDungeonPanel:AddEvent()
    --开一个定时器固定时间请求副本信息
    self:RequestInfo();
    self.schedules[1] = GlobalSchedule:Start(handler(self, self.RequestInfo), 5, -1);

    --结束副本时间
    self.equipschedules = GlobalSchedule:Start(handler(self, self.EndDungeon), 0.2, -1);

    self.events[#self.events + 1] = GlobalEvent:AddListener(DungeonEvent.DUNGEON_EXP_GOLD_INFO, handler(self, self.HandleData))

    local call_back = function()
        SetGameObjectActive(self.endTime.gameObject , false);
        self.hideByIcon = true;
    end

    self.events[#self.events + 1] = GlobalEvent.AddEventListener(MainEvent.ShowTopRightIcon, call_back);

    local call_back1 = function()
        if not self.startSchedule then
            self.endTime.gameObject:SetActive(true);
        end
        self.hideByIcon = false;
    end

    self.events[#self.events + 1] = GlobalEvent.AddEventListener(MainEvent.HideTopRightIcon, call_back1);

end

local temptab = {
    ["stype"] = 301,
    ["info"] = {
        ["prep_time"] = 1550056487,
        ["cur_wave"] = 0,
        ["world_level"] = 50,
        ["exp_activity"] = 40,
        ["coin_inspire"] = 5,
        ["end_time"] = 1550056852,
        ["max_wave"] = 3,
        ["inspire"] = 0,
        ["gold_inspire"] = 5,
        ["exp_team"] = 30,
        ["exp_elixir"] = 20,
        ["exp_gain"] = 0
    },
    ["id"] = 30101
}
function EquipDungeonPanel:HandleData(data)
    if data.stype ~= enum.SCENE_STYPE.SCENE_STYPE_DUNGE_EQUIP then
        return ;
    end
    local prep_time = data.prep_time;
    if data.level ~= self.level and data.level ~= 1 then
        self:SetHardLevel(data.level);
    end
    self.level = data.level;
    self.cur_wave = data.cur_wave;
    self.max_wave = data.max_wave;
    self.end_time = data.end_time;
    self.wave_etime = data.wave_etime;

    --if self.wave_etime < os.time() then
    --    self.wave_etime = nil;
    --end

    --self:StartLeftTime(self.wave_etime);

    self.round.text = "Current round:    <color=#5BD022>" .. self.cur_wave .. "/" .. self.max_wave .. "</color>";
    if self.level == 1 then
        self.current.text = "Difficulty:    <color=#ff0000>Easy</color>";
    else
        self.current.text = "Difficulty:    <color=#ff0000>" .. DungeonModel:GetInstance().hard_level[self.level] .. "</color>"
    end
end

function EquipDungeonPanel:StopAllSchedules()
    for i = 1, #self.schedules, 1 do
        GlobalSchedule:Stop(self.schedules[i]);
    end
    if self.equipschedules then
        GlobalSchedule:Stop(self.equipschedules);
    end
    self.equipschedules = nil;
    self.schedules = {};
end

