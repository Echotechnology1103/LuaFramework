---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by win 10.
--- DateTime: 2018/10/10 10:53
---
DungeonKillLogPanel = DungeonKillLogPanel or class("DungeonKillLogPanel", WindowPanel)
local this = DungeonKillLogPanel

function DungeonKillLogPanel:ctor(parent_node)
    self.abName = "dungeon";
    self.image_ab = "dungeon_image";
    self.assetName = "KillLogPanel"
    self.layer = "UI"
    self.panel_type = 4;
    self.model = DungeonModel.GetInstance()
    self.events = {};
    self.schedules = {};

    --DungeonKillLogPanel.super.Load(self)
end

function DungeonKillLogPanel:dctor()
    self.model = nil;
    GlobalEvent:RemoveTabListener(self.events);
    self:StopAllSchedules()

    destroyTab(self.items);
end

function DungeonKillLogPanel:Open(data)
    self.data = data;
    WindowPanel.Open(self)
end

function DungeonKillLogPanel:LoadCallBack()
    self.nodes = {
        "killlogItem_0", "ScrollView/Viewport/Content", "NoRecordTip"
    }
    self:GetChildren(self.nodes)

    SetLocalPosition(self.transform, 0, 0, 0)

    self:SetTileTextImage("dungeon_image", "kill_log_title");
    self:InitUI();

    --local parent = self.transform.parent:Find("PanelBackgroundTwo(Clone)/img_bg_2/");
    --if parent then
    --    self.map_bg.transform:SetParent(parent.transform);
    --end

    self:AddEvent();
end

function DungeonKillLogPanel:InitUI()
    self.itemList = {};
    local bossType = Config.db_boss[self.data.id].type

    --self.killlogItem_0 = GetText(self.killlogItem_0);
    self.killlogItem_0.gameObject:SetActive(true);
    local today = string.split(tostring(os.date()), " ")[1];
    local logs = self.data.logs;--1540546506

    local isNoRecord = (#logs == 0)
    SetVisible(self.NoRecordTip, isNoRecord)

    self.items = {};
    for i = 1, #logs, 1 do
        local killLogTab = logs[i];

        local killlogItem = KillLogItem(newObject(self.killlogItem_0), killLogTab, bossType);
        self.items[i] = killlogItem;

        --killlogItem.text = timestr .. "被<color=#00ffff>" .. killer .. "</color>击杀了";
        killlogItem.transform:SetParent(self.Content.transform);
        SetLocalScale(killlogItem.transform, 1, 1, 1);
    end
    SetSizeDeltaY(self.Content.transform, 40 * #self.items);
    self.killlogItem_0.gameObject:SetActive(false);
end

function DungeonKillLogPanel:AddEvent()

end

function DungeonKillLogPanel:StopAllSchedules()
    for i = 1, #self.schedules, 1 do
        GlobalSchedule:Stop(self.schedules[i]);
    end
    self.schedules = {};
end

KillLogItem = KillLogItem or class("KillLogItem", Node)
local this1 = KillLogItem

function KillLogItem:ctor(_obj, data, bossType)
    self.transform = _obj.transform
    self.gameObject = self.transform.gameObject;
    self.transform_find = self.transform.Find;
    self.data = data;
    self.bossType = bossType
    self:InitUI();
    self.events = {}

    self:AddEvent();
end

function KillLogItem:InitUI()
    self.is_loaded = true;
    self.nodes = {
        "log", "time",
    }
    self:GetChildren(self.nodes)

    self.log = GetText(self.log);
    self.time = GetText(self.time)

    self:SetTimeText()

    if self.bossType == enum.BOSS_TYPE.BOSS_TYPE_PET then
        self:SetPetBossLogText()
    else
        self:SetNormalLogText()
    end
end

function KillLogItem:SetPetBossLogText()
    if (self.data.quality) then
        local qualityName = ColorUtil.GetColorNameWithColorTag(self.data.quality)
        self.log.text = "Was <color=#ff0000>" .. self.data.killer .. "</color>Defeat.Quality is" .. qualityName
    else
        self:SetNormalLogText()
    end
end

function KillLogItem:SetNormalLogText()
    self.log.text = "Was <color=#ff0000>" .. self.data.killer .. "</color>Defeated";--00ffff
end

--<color=#268FDA>拾取者名称1</color>在世界BOSS1与<color=#E63232>boss名称1</color>大战三百回合，获得极品<color=#EC6F00>[大天使头盔]</color>
function KillLogItem:SetTimeText()
    local timeTab = TimeManager:GetTimeDate(self.data.time);
    local timestr = "";
    if timeTab.hour then
        timestr = timestr .. string.format("%02d", timeTab.hour) .. ":";
    end
    if timeTab.min then
        timestr = timestr .. string.format("%02d", timeTab.min) .. ":";
    end
    if timeTab.sec then
        timestr = timestr .. string.format("%02d", timeTab.sec);
    end

    self.time.text = timestr;--.. "     被<color=#00ffff>" .. killer .. "</color>击杀了";
end

function KillLogItem:AddEvent()

end

function KillLogItem:dctor()
    GlobalEvent:RemoveTabListener(self.events);
end