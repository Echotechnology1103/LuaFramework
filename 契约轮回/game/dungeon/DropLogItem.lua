---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by win 10.
--- DateTime: 2018/10/11 15:01
---
DropLogItem = DropLogItem or class("DropLogItem", Node)
local this = DropLogItem

function DropLogItem:ctor(_obj, data)
    self.transform = _obj.transform
    self.gameObject = self.transform.gameObject;
    self.transform_find = self.transform.Find;
    self.data = data;
    self:InitUI();
    self.events = {}

    self:AddEvent();
end

function DropLogItem:InitUI()
    self.is_loaded = true;
    self.nodes = {
        "kill_log_item_bg", "log", "time",
    }
    self:GetChildren(self.nodes)

    self.log = GetLinkText(self.log);
    self.time = GetText(self.time)

    self.kill_log_item_bg = GetImage(self.kill_log_item_bg);
    ShaderManager:GetInstance():SetImageNormal(self.kill_log_item_bg);

    SetLocalPosition(self.transform, 0, 0, 0)

    local killTime = self.data.time;
    local killer = self.data.picker_name;
    local killerID = self.data.picker_id;
    local boss = self.data.boss;
    local itemID = self.data.item_id;

    local sceneID = self.data.scene;
    local scenename = "";
    if Config.db_scene[sceneID] then
        scenename = Config.db_scene[sceneID].name
    end
    local itemName = "";
    local item = Config.db_item[itemID];
    local color = tostring(ColorUtil.GetColor(1))
    if item then
        itemName = item.name;
        color = tostring(ColorUtil.GetColor(item.color))
    end

    local timeTab = TimeManager:GetTimeDate(killTime);
    local timestr = "";
    if timeTab.month then
        timestr = timestr .. string.format("%02d", timeTab.month) .. "-";
    end
    if timeTab.day then
        timestr = timestr .. string.format("%02d", timeTab.day) .. "    ";
    end
    if timeTab.hour then
        timestr = timestr .. string.format("%02d", timeTab.hour) .. ":";
    end
    if timeTab.min then
        timestr = timestr .. string.format("%02d", timeTab.min) .. ":";
    end
    if timeTab.sec then
        timestr = timestr .. string.format("%02d", timeTab.sec);
    end
    --self.log:AddLoadSpriteFun(handler(self, self.HandleLoadSprite));
    self.time.text = timestr;--.. "     被<color=#00ffff>" .. killer .. "</color>击杀了";</color>
    --    self.log.text = "<quad name=btn_close size=39 width=1 /> <color=#268FDA><a href=player_" .. killerID .. ">" .. killer .. "</color></a>在" .. scenename .. "与" .. "<color=#E63232>" .. boss .. "</color>大战三百回合，获得极品<color=#EC6F00><a href=item_" .. itemID .. ">[" .. itemName .. "]</a></color>";
    self.log.text = "<color=#268FDA><a href=player_" .. killerID .. ">" .. killer .. "</color></a>At" .. scenename .. "X" .. "<color=#E63232>" .. boss .. "</color>Fight fiercely and obtain rare item<color=#" .. color .. "><a href=item_" .. itemID .. ">[" .. itemName .. "]</a></color>";--

    self.log:AddClickListener(handler(self, self.HandleLogClick));
end
--<color=#268FDA>拾取者名称1</color>在世界BOSS1与<color=#E63232>boss名称1</color>大战三百回合，获得极品<color=#EC6F00>[大天使头盔]</color>

function DropLogItem:AddEvent()
    --local call_back = function(target, bool)
    --    if self.data then
    --        if self.data.item_id then
    --            if Config.db_item[self.data.item_id] then
    --                Notify.ShowText(Config.db_item[self.data.item_id].name);
    --            end
    --        end
    --    end
    --end
    --AddClickEvent(self.gameObject, call_back);
    AddEventListenerInTab(RoleInfoEvent.QUERY_OTHER_ROLE, handler(self, self.HandleRoleInfoQuery), self.events);

end

function DropLogItem:SetItemCallBack(callback)
    self.ItemCallBack = callback
end

--@ling autofun
function DropLogItem:HandleRoleInfoQuery(data)
    if data and data.role and data.role.id == self.roleid then
        --local panel = lua_panelMgr:GetPanel(RoleMenuPanel)
        --if panel then
        --    panel:Close();
        --end
        local panel = lua_panelMgr:GetPanelOrCreate(RoleMenuPanel , self.log.transform);
        if not panel.isShow then
            panel:Open(data.role);
        end
    end
end
function DropLogItem:HandleLoadSprite(spriteName)
    --print2(">>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>");
    --print2(">>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>");
    --print2(spriteName);
    local spr = resMgr:GetSprite("dungeon_image", spriteName);
    --print2(spr);
    return spr;
end
--@ling autofun
function DropLogItem:HandleLogClick(str)
    local strTab = string.split(str, "_")
    if strTab and #strTab > 1 then
        if strTab[1] == "player" then
            --Notify.ShowText("显示玩家信息" .. strTab[2]);
            --ShaderManager:GetInstance():SetImageGray(self.kill_log_item_bg)
            self.roleid = strTab[2];
            RoleInfoController:GetInstance():RequestRoleQuery(strTab[2]);
        elseif strTab[1] == "item" then
            ShaderManager:GetInstance():SetImageNormal(self.kill_log_item_bg);

            if(self.ItemCallBack) then
                self:ItemCallBack(self)
            end

            --local itemId = tonumber(strTab[2])
            --BagModel:GetInstance():ShowTip(itemId, self.parent or self.transform)
        end
    end
end

function DropLogItem:HideBg()
    if self.kill_log_item_bg then
        self.kill_log_item_bg.gameObject:SetActive(false);
    end
end

function DropLogItem:dctor()
    GlobalEvent:RemoveTabListener(self.events);
    if self.goodsDetailView then
        self.goodsDetailView:destroy();
    end
end
