---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by win 10.
--- DateTime: 2018/10/11 14:40
---
ExpUseItem = ExpUseItem or class("ExpUseItem",BaseCloneItem)
local ExpUseItem = ExpUseItem

function ExpUseItem:ctor(obj,parent_node,layer)
    ExpUseItem.super.Load(self)
end


function ExpUseItem:LoadCallBack()
    self.nodes = {
        "buyBtn", "bg", "closeBtn", "icon", "Text", "buyBtn/buyLabel", "itemName"
    }
    self:GetChildren(self.nodes);
    self.events = {};
    self.itemList = {};
    self:InitUI();
    self:AddEvents()
end
--经验幻灵
ExpUseItem.ITEM_ID_1 = 11020144;
--可能是小幻灵?
ExpUseItem.ITEM_ID_2 = 11020145;
--体验幻灵ID
ExpUseItem.ITEM_ID_3 = 11020147;
--幻灵商城ID
ExpUseItem.ITEM_MALL_ID_1 = 2201;


function ExpUseItem:InitUI()
    self.buyLabel = GetText(self.buyLabel);

    self.itemName = GetText(self.itemName);

    local item;
    local isExpire = false;
    local equipItem = EquipModel:GetInstance().putOnedEquipDetailList[1011];
    if equipItem and equipItem.id ~= ExpUseItem.ITEM_ID_1 and equipItem.id ~= ExpUseItem.ITEM_ID_3 then
        --
        equipItem = nil;
    end
    if equipItem and BagModel:GetInstance():IsExpire(equipItem.etime) then
        --过期了
        --print2(equipItem.etime );
        --print2(os.clock());
        isExpire = true;
        --else
        --    print2("未过期");
        --if equipItem.id == ExpUseItem.ITEM_ID_1 then
        --    print2("应该直接退出同时return");
        --end
        --self:destroy();
    end

    local num = 0;
    local num1 = 0;
    self.status = 0;
    if equipItem then
        if isExpire then
            --身上的过期了
            --num = BagModel:GetInstance():GetItemNumByItemID(11020145);
            --if num > 0 then
            --    self.buyLabel.text = "穿 戴";
            --    item = AwardItem(self.icon);
            --    item:SetData(11020145, 0);
            --    self.itemList[1] = item;
            --    item:UpdateNum(num);
            --    item:SetIsSelected(false);
            --    self.status = 11;
            --    self:SetItemName(11020145);
            --    return ;
            --end

            num = BagModel:GetInstance():GetItemNumByItemID(ExpUseItem.ITEM_ID_1);
            if num > 0 then
                local item = BagModel:GetInstance():GetItemByItemId(ExpUseItem.ITEM_ID_1);
                if item and (item.etime < os.time() or item.etime == 0) then
                    print2("过期");
                    self.buyLabel.text = "Buy";
                    item = GoodsIconSettorTwo(self.icon);

                    self:SetParam(item, ExpBtnItem.ITEM_ID_1)

                    self.status = 13;
                    self:SetItemName(ExpUseItem.ITEM_ID_1);
                else
                    print2("未过期");
                    self.buyLabel.text = "Equip";
                    item = GoodsIconSettorTwo(self.icon);
                    self:SetParam(item, ExpBtnItem.ITEM_ID_1)
                    self.status = 12;
                    self:SetItemName(ExpUseItem.ITEM_ID_1);
                    return ;
                end
            else
                print2("过期");
                self.buyLabel.text = "Buy";
                item = GoodsIconSettorTwo(self.icon);

                self:SetParam(item, ExpBtnItem.ITEM_ID_1)

                self.status = 13;
                self:SetItemName(ExpUseItem.ITEM_ID_1);
            end
        else
            --未过期
            print2("未过期,应该直接退出同时return");
            --self:destroy();--有穿未过期都不提醒
            self:SetVisible(false)
            return ;
        end
    else
        --没有穿带
        num = BagModel:GetInstance():GetItemNumByItemID(ExpUseItem.ITEM_ID_1);
        num1 = BagModel:GetInstance():GetItemNumByItemID(ExpUseItem.ITEM_ID_3);
        if num > 0 then
            local item = BagModel:GetInstance():GetItemByItemId(ExpUseItem.ITEM_ID_1);
            if item and (item.etime < os.time() or item.etime == 0) then
                print2("过期");
                self.buyLabel.text = "Buy";
                item = GoodsIconSettorTwo(self.icon);
                self:SetParam(item, ExpBtnItem.ITEM_ID_1)
                self.status = 16;
                self:SetItemName(ExpUseItem.ITEM_ID_1);
            else
                print2("未过期");
                self.buyLabel.text = "Equip";
                item = GoodsIconSettorTwo(self.icon);
                --item:SetData(ExpUseItem.ITEM_ID_1, 0);
                self:SetParam(item, ExpBtnItem.ITEM_ID_1)
                self.status = 14;
                self:SetItemName(ExpUseItem.ITEM_ID_1);
                return ;
            end
        elseif num1 > 0 then
            local item = BagModel:GetInstance():GetItemByItemId(ExpUseItem.ITEM_ID_3);
            if item and (item.etime < os.time() or item.etime == 0) then
                print2("试用过期");
                self.buyLabel.text = "Buy";
                item = GoodsIconSettorTwo(self.icon);
                self:SetParam(item, ExpBtnItem.ITEM_ID_1)
                self.status = 16;
                self:SetItemName(ExpUseItem.ITEM_ID_1);
            else
                print2("试用未过期");
                self.buyLabel.text = "Equip";
                item = GoodsIconSettorTwo(self.icon);
                --item:SetData(ExpUseItem.ITEM_ID_1, 0);
                self:SetParam(item, ExpBtnItem.ITEM_ID_3)
                self.status = 18;
                self:SetItemName(ExpUseItem.ITEM_ID_3);
                return ;
            end
        else
            self.buyLabel.text = "Buy";
            item = GoodsIconSettorTwo(self.icon);
            self:SetParam(item, ExpBtnItem.ITEM_ID_1)
            --item:UpdateNum(num);
            --item:SetIsSelected(false);
            self.status = 16;
            self:SetItemName(ExpUseItem.ITEM_ID_1);
        end

        --num = BagModel:GetInstance():GetItemNumByItemID(ExpUseItem.ITEM_ID_1);
        --if num > 0 then
        --    self.buyLabel.text = "穿 戴";
        --    item = AwardItem(self.icon);
        --    item:SetData(ExpUseItem.ITEM_ID_1, 0);
        --    self.itemList[1] = item;
        --    item:UpdateNum(num);
        --    item:SetIsSelected(false);
        --    self.status = 15;
        --    self:SetItemName(ExpUseItem.ITEM_ID_1);
        --    return ;
        --end


    end


end
--status 1
function ExpUseItem:SetButtonLabel(status)
    self.status = status;
end
function ExpUseItem:AddEvents()
    local call_back = function(target, x, y)
        if self.status == 11 or self.status == 12 or self.status == 14 or self.status == 15 then
            local uid = BagModel:GetInstance():GetUidByItemID(ExpUseItem.ITEM_ID_1);
            EquipController:GetInstance():RequestPutOnEquip(uid);
        elseif self.status == 13 or self.status == 16 then
            ----小恶魔
            OpenLink(180, 1, 2, 2, ExpUseItem.ITEM_MALL_ID_1);--经验幻灵
        elseif self.status == 18 or self.status == 19 then
            local uid = BagModel:GetInstance():GetUidByItemID(ExpUseItem.ITEM_ID_3);
            EquipController:GetInstance():RequestPutOnEquip(uid);
        else
            print("buybuybuy");
        end
        self:SetVisible(false)
    end

    AddClickEvent(self.buyBtn.gameObject, call_back);

    local call_back1 = function(target, x, y)
        self:SetVisible(false)
    end

    AddClickEvent(self.closeBtn.gameObject, call_back1);

    local call_back2 = function(itemID)
    end

end

function ExpUseItem:dctor()
    RemoveClickEvent(self.buyBtn.gameObject);
    GlobalEvent:RemoveTabListener(self.events);
    if self.useitemClose then
        self.useitemClose();
    end
    self.useitemClose = nil;
    destroyTab(self.itemList);
    self.itemList = nil;
end

function ExpUseItem:SetItemName(itemID)
    local item = Config.db_item[itemID];
    if item then
        self.itemName.text = item.name;
    end

end


function ExpUseItem:SetParam(item, itemID)
    local param = {}
    param["item_id"] = itemID or ExpUseItem.ITEM_ID_1;
    param["can_click"] = true;
    param["bind"] = true;
    param["size"] = { x = 80, y = 80 }
    param["num"] = 0;
    item:SetIcon(param);
    self.itemList[1] = item;
end