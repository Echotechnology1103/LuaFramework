---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by win 10.
--- DateTime: 2018/9/21 16:53
---
ExpEffUseItem = ExpEffUseItem or class("ExpEffUseItem", Node)
local this = ExpEffUseItem

function ExpEffUseItem:ctor(obj, itemID, mallID)
    self.itemID = itemID;
    self.mallID = mallID;
    self.transform = obj.transform
    self.gameObject = self.transform.gameObject;
    self.transform_find = self.transform.Find;
    self.events = {};
    self:InitUI();
    self:AddEvents();
end

function ExpEffUseItem:InitUI()
    self.is_loaded = true;
    self.nodes = {
        "icon", "propTxt_1", "useBtn", "itembg", "useBtn/Text",
    }
    self:GetChildren(self.nodes)

    self.propTxt_1 = GetText(self.propTxt_1);
    self.useBtn = GetButton(self.useBtn);
    self.Text = GetText(self.Text);

    self.itemTab = Config.db_item[self.itemID] or {};

    if ExpDungeonPanel.buffs3[self.itemID] then
        local buff = Config.db_buff[ExpDungeonPanel.buffs3[self.itemID]];
        if buff then
            self.propTxt_1.text = buff.desc;
        end
    end
    --if Config.db_item[self.itemID] then
    --    self.propTxt_1.text = self.itemTab.desc;
    --end
    self.num = 0;
    if self.itemID ~= 0 then
        self.item = AwardItem(self.icon.transform);
        self.item:SetData(self.itemID, 0);
        self.num = BagModel:GetInstance():GetItemNumByItemID(self.itemID);
        self.item:UpdateNum(self.num);
    end
end

function ExpEffUseItem:AddEvents()

    local call_back2 = function(target, x, y)
        OpenLink(180, 1, 2, 2, self.mallID);----Notify.ShowText("前往购买" .. self.itemTab.name);
    end
    local call_back4 = function(target, x, y)
        FirstPayModel.GetInstance():OpenFirstPayPanelOne()
    end
    local call_back = function(target, x, y)
        local num = BagModel:GetInstance():GetItemNumByItemID(self.itemID);
        if num == 0 then
            --Notify.ShowText("前往商城购买" .. self.itemTab.name);
            --UnpackLinkConfig("180@1@2@2@" .. self.mallID)
            if self.itemID == 10015 then
                call_back2();
                --self.Text.text = "前往购买"
            elseif self.itemID == 10016 then
                call_back4();
                --self.Text.text = "充值获得"
            else
                UnpackLinkConfig("180@1@2@2@" .. self.mallID)
            end
        else
            local uid = BagModel:GetInstance():GetUidByItemID(self.itemID);
            GoodsController:GetInstance():RequestUseItem(uid, 1);

            local panel = lua_panelMgr:GetPanel(ExpDungeonPanel);
            if panel then
                if panel.effBtn then
                    panel.effBtn:HideBgText();
                end
            end
            --DungeonCtrl:GetInstance():
        end
        --local panel = lua_panelMgr:GetPanel(ExpEffPanel);
        --if panel then
        --    panel:Close();
        --end
    end
    if self.num == 0 then
        if self.itemID == 10015 then
            self.Text.text = "Buy"
        elseif self.itemID == 10016 then
            self.Text.text = "First recharge grants you"
        end
    else
        self.Text.text = "Use";
    end

    AddClickEvent(self.useBtn.gameObject, call_back);
    local call_back3 = function()
        if self.item and self.itemID then
            self.num = BagModel:GetInstance():GetItemNumByItemID(self.itemID);
            self.item:UpdateNum(self.num);
            if self.itemID == 10015 then
                if self.num == 0 then
                    self.Text.text = "Buy"
                else
                    self.Text.text = "Use";
                end
            elseif self.itemID == 10016 then
                if self.num == 0 then
                    self.Text.text = "First recharge grants you"
                else
                    self.Text.text = "Use";
                end
            else
                if self.num == 0 then
                    self:destroy();
                end
            end
        end
    end
    AddEventListenerInTab(BagEvent.UpdateGoods, call_back3, self.events);
    --if self.schedule then
    --    GlobalSchedule:Stop(self.schedule);
    --end
    --self.schedule = GlobalSchedule:Start(call_back3, 0.3, -1);
end

function ExpEffUseItem:dctor()
    RemoveClickEvent(self.useBtn.gameObject);
    GlobalEvent:RemoveTabListener(self.events);
    if self.schedule then
        GlobalSchedule:Stop(self.schedule);
    end
    if self.item then
        self.item:destroy();
    end
    self.item = nil;
end

function ExpEffUseItem:LoadCallBack()

end
