---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by win 10.
--- DateTime: 2018/10/11 14:40
---
DungeonScrollItem = DungeonScrollItem or class("DungeonScrollItem", Node)
local this = DungeonScrollItem

DungeonScrollItem.robotSetValue = false;

function DungeonScrollItem:ctor(obj, tab , isBeast)
    self.transform = obj.transform
    self.gameObject = self.transform.gameObject;
    self.data = tab;
    self.isBeast = isBeast;
    self.image_ab = "dungeon_image";
    self.transform_find = self.transform.Find;
    self.model = DungeonModel:GetInstance();
    self.events = {};
    self:InitUI();
    self:AddEvents();
end

function DungeonScrollItem:dctor()
    GlobalEvent:RemoveTabListener(self.events);
    if self.schedule then
        GlobalSchedule:Stop(self.schedule);
    end
    self.model = nil;
end

function DungeonScrollItem:InitUI()
    self.is_loaded = true;
    self.nodes = {
        "jie", "name_bg", "bossName", "bg", "selected", "timeText", "care", "jieText", "is_peace", --"iscare",
        "timeText2","bossName2",
    }
    self:GetChildren(self.nodes);

    --InitUI
    self.jie = GetImage(self.jie);
    self.jieText = GetText(self.jieText);
    if self.isBeast then
        SetGameObjectActive(self.bossName);
        self.bossName = GetText(self.bossName2);
    else
        SetGameObjectActive(self.bossName2);
        self.bossName = GetText(self.bossName);
    end

    self.selected = GetImage(self.selected);
    self.bg = GetImage(self.bg);
    self.care = GetToggle(self.care);
    self:SetIsCare(false);

    if self.isBeast then
        SetGameObjectActive(self.timeText);
        self.timeText = GetText(self.timeText2);
    else
        SetGameObjectActive(self.timeText2);
        self.timeText = GetText(self.timeText);
    end

    self.timeText.text = "";
    --self:SetBossBg()

    local level = "";
    if Config.db_creep[self.data.id] then
        local tab = Config.db_creep[self.data.id];
        local cur_level = "LV." .. tab.level .. level
        level = "  " .. cur_level
    end
    if self.isBeast then
        if self.data.seq <= 2 then
            self:SetBossName(self.data.name .. "  " .. self.data.num .. "X");
        else
            self:SetBossName(self.data.name);
        end
    else
        self:SetBossName(self.data.name .. level);
    end


    self:SetSelected(false);

    self:SetBossBg(self.data.boss_res);
    self:SetJie(self.data.order)
end



function DungeonScrollItem:AddEvents()
    local care_call_back = function(target, bool)
        if not self.robotSetValue then
            if bool then
                DungeonCtrl:GetInstance():RequestBossCare(enum.BOSS_TYPE.BOSS_TYPE_WORLD, self.data.id, 1);
            else
                DungeonCtrl:GetInstance():RequestBossCare(enum.BOSS_TYPE.BOSS_TYPE_WORLD, self.data.id, 2);
            end
        end
    end
    AddValueChange(self.care.gameObject, care_call_back);
end

function DungeonScrollItem:ShowCare(bool)
    bool = toBool(bool);
    SetGameObjectActive(self.care, bool);
end

function DungeonScrollItem:ShowPeace(bool)
    bool = toBool(bool);
    SetGameObjectActive(self.is_peace, bool);
end

function DungeonScrollItem:StartSechudle(time)
    self.time = time;
    self.timeText.text = "";
    local timeTab = TimeManager:GetLastTimeData(os.time(), time);
    if timeTab then
        if self.schedule then
            GlobalSchedule:Stop(self.schedule);
        end
        self.schedule = GlobalSchedule.StartFun(handler(self, self.CountTime), 1, -1);
        self:CountTime();
    end
end

function DungeonScrollItem:CountTime()
    local timeTab = TimeManager:GetLastTimeData(os.time(), self.time);
    local timestr = "";
    if timeTab then
        timeTab.min = timeTab.min or 0;
        timeTab.hour = timeTab.hour or 0;
        if timeTab.hour then
            timestr = timestr .. string.format("%02d", timeTab.hour) .. ":";
        end
        if timeTab.min then
            timestr = timestr .. string.format("%02d", timeTab.min) .. ":";
        end
        if timeTab.sec then
            timestr = timestr .. string.format("%02d", timeTab.sec);
        end
        if self.data and self.model:IsBeastBoss(self.data.type) then
            if self.data.seq <= 2 then
                self.timeText.text = "Next Refresh:" ..  timestr;
            else
                self.timeText.text = timestr;
            end
        else
            self.timeText.text = timestr;
        end
    else
        if self.schedule then
            GlobalSchedule:Stop(self.schedule);
        end
        --self.timeText.gameObject:SetActive(false);
        self.schedule = nil;

        if self.data and self.model:IsBeastBoss(self.data.type) then
            if self.data.seq <= 2 then
                self.timeText.text = "<color=#ffffff>             Refreshed</color>";
            else
                self.timeText.gameObject:SetActive(false);
            end
        else
            self.timeText.gameObject:SetActive(false);
        end
    end
end

function DungeonScrollItem:SetIsCare(bool)
    bool = bool and true or false;
    self.robotSetValue = true;
    self.care.isOn = bool;
    self.robotSetValue = false;
    --self.care = bool;
    --self.iscare.gameObject:SetActive(bool);
end

function DungeonScrollItem:SetJie(num)
    self.jieText.text = "T" .. num
    --lua_resMgr:SetImageTexture(self, self.jie, self.image_ab, "icon_step_" .. num, true);
end

function DungeonScrollItem:ShowJie(bool)
    bool = toBool(bool);
    SetGameObjectActive(self.jie , bool);
    SetGameObjectActive(self.jieText , bool);
end

function DungeonScrollItem:SetBossBg(bgName)
    --print2(bgName);
    lua_resMgr:SetImageTexture(self, self.bg, "iconasset/icon_boss_image", tostring(bgName), true);
end

function DungeonScrollItem:SetBossName(str)
    self.bossName.text = str;
end
--设置是否选中当前物体
function DungeonScrollItem:SetSelected(bool)
    bool = bool and true or false;
    self.selected.gameObject:SetActive(bool);
end

function DungeonScrollItem:LoadCallBack()

end

function DungeonScrollItem:RefreshBeastIslandNum()
    if self.data then
        local bossinfo = DungeonModel:GetInstance():GetDungeonBossInfo(self.data.type, self.data.id);
        if bossinfo then
            local level = "";
            if Config.db_creep[self.data.id] then
                local tab = Config.db_creep[self.data.id];
                local cur_level = tab.level .. level .. "Level"
                level = "  " .. cur_level
            end
            if self.isBeast then
                if self.data.seq <= 2 then
                    self:SetBossName(self.data.name .. "*"..bossinfo.num);
                else
                    self:SetBossName(self.data.name);
                end
            else
                self:SetBossName(self.data.name .. level);
            end
        end
    end
end