---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by win 10.
--- DateTime: 2018/10/9 17:34
--- 经验副本的UI
AdvanceDungeonPanel = AdvanceDungeonPanel or class("AdvanceDungeonPanel", DungeonMainBasePanel)
local AdvanceDungeonPanel = AdvanceDungeonPanel

function AdvanceDungeonPanel:ctor()
    self.abName = "dungeon"
    self.imageAb = "dungeon_image";
    self.assetName = "AdvanceDungeonPanel";
    self.model = DungeonModel:GetInstance();
    self.level = 1;
    self.events = {};
    self.schedules = {};

end

function AdvanceDungeonPanel:dctor()
    GlobalEvent:RemoveTabListener(self.events);
    self:StopAllSchedules();

    if self.endDungeSchedule then
        GlobalSchedule.StopFun(self.endDungeSchedule);
    end

    if self.event_id_1 then
        RemoveModelListener(self.event_id_1, self.model)
    end
    self.model = nil;

    if self.startSchedule then
        GlobalSchedule.StopFun(self.startSchedule);
    end
    self.startSchedule = nil;
    self.startDungeonTime = nil;
    self.dungeon_is_exit = nil;

    self.stars = nil;
end

function AdvanceDungeonPanel:Open(data)
    WindowPanel.Open(self)
    self.data = data;
end

function AdvanceDungeonPanel:LoadCallBack()
    self.nodes = {
        --描述相关
        --"txt/text_1", "txt/text_2", "txt/text_3",
        --三颗星星
        --"level/level_2", "level/level_1", "level/level_3",
        --"hardshow", "hardshow/dun_name", "hardshow/pingjia", "hardshow/gold", "hardshow/starframe/star_2", "hardshow/starframe/star_3", "hardshow/des", "hardshow/starframe/star_1",

        "startTime", "startTime/time",
        --副本倒计时
        "endTime", "endTime/endTitleTxt",
        --中间提示
        "killtip", "killtip/kill_tip",

        "starandtip/kill_tip_bg1", "starandtip/pingjia", "starandtip", "starandtip/starframe/star_3", "starandtip/starframe/star_1", "starandtip/starframe/star_2",

        "hardshow", "hardshow/des", "hardshow/round", "hardshow/dun_name",
    }
    self:GetChildren(self.nodes);

    SetLocalPosition(self.transform, 0, 0, 0)

    self:Init();
    self:AddEvent();

    SceneManager:GetInstance():SetMainRoleRotateY(45);

    SetAlignType(self.hardshow.transform, bit.bor(AlignType.Left, AlignType.Top));
    SetAlignType(self.starandtip.transform, bit.bor(AlignType.Left, AlignType.Null));

    self:HandleEnterDungeInfo();

    self:StartDungeonCD();
    SetGameObjectActive(self.starandtip.gameObject, false);

    --为了红点
    DungeonCtrl:GetInstance():RequestDungeonMount();

    --TaskModel:GetInstance():StopTask();--先停掉任务,因为任务优先级高
    --OperationManager:GetInstance():StopAStarMove();
    --
    --if not AutoFightManager:GetInstance():GetAutoFightState() then
    --    GlobalEvent:Brocast(FightEvent.AutoFight)
    --end
    
    self:checkAdaptUI()
end

function AdvanceDungeonPanel:checkAdaptUI()
    UIAdaptManager:GetInstance():AdaptUIForBangScreenLeft(self.hardshow)
    UIAdaptManager:GetInstance():AdaptUIForBangScreenLeft(self.starandtip)
end

function AdvanceDungeonPanel:StartDungeonTween()
    SetGameObjectActive(self.starandtip.gameObject, true);
    local x, y, z = GetLocalPosition(self.starandtip.transform);
    SetLocalPosition(self.starandtip.transform, x + 500, 0, 0);

    cc.ActionManager:GetInstance():removeAllActionsFromTarget(self.starandtip)
    local value_action = cc.MoveTo(1, x, y, z)
    local delayaction = cc.Sequence(cc.DelayTime(1), value_action)
    cc.ActionManager:GetInstance():addAction(delayaction, self.starandtip)


end

function AdvanceDungeonPanel:StartDungeonCD()
    SetGameObjectActive(self.startTime, true);
    SetGameObjectActive(self.endTime.gameObject, false);
    local sceneInfo = SceneManager:GetInstance():GetSceneInfo();
    if sceneInfo then
        local dungeConfig = Config.db_dunge[sceneInfo.scene];
        if dungeConfig then
            local prep = dungeConfig.prep;
            self.startDungeonTime = os.time() + prep;

            if self.startSchedule then
                GlobalSchedule.StopFun(self.startSchedule);
            end
            self.endDungeonStartCountDownFun = function()
                if self.startSchedule then
                    GlobalSchedule.StopFun(self.startSchedule);
                end
                self:StartDungeonTween();
                self.startSchedule = nil;
                if not self.dungeon_is_exit then
                    SetGameObjectActive(self.endTime.gameObject, true);
                end
            end
            self.startSchedule = GlobalSchedule.StartFun(handler(self, self.HandleDungeonStartCountDown), 0.2, -1);
        end
    end
end

function AdvanceDungeonPanel:RequestInfo()
    --print2("请求经验副本信息");
    DungeonCtrl:GetInstance():RequeseExpDungeonInfo();
end

--killcd
--<color=#5BD022>58</color>秒内击败敌人
--首领难度将提升到:<color=#5BD022>普通</color>
function AdvanceDungeonPanel:Init()
    --self.levels = {};
    --self.texts = {};
    self.time = GetText(self.time);
    self.stars = {};
    for i = 1, 3 do
        --local text_name = "text_" .. i;
        --self.texts[i] = GetText(self[text_name]);
        --local level_name = "level_" .. i;
        --self.levels[i] = GetText(self[level_name]);
        local star_name = "star_" .. i;
        self.stars[i] = GetToggle(self[star_name]);
    end
    --获取的金币
    --self.gold = GetText(self.gold);

    --特殊提示
    self:ShowKillTip(false);

    self.dun_name = GetText(self.dun_name);--通关条件

    self.round = GetText(self.round)--当前波数： <color=#5BD022>0/1</color>

    --难度越高,掉落奖励越好,
    --限时内击杀一波小怪,能
    --够提升一次<color=#5BD022>首领难度.</color>
    self.des = GetText(self.des);--读配置

    --<color=#5BD022>02:22</color>秒后
    --降到:<color=#5BD022>2</color>星评价
    self.pingjia = GetText(self.pingjia);

    self.endTitleTxt = GetText(self.endTitleTxt);--副本倒计时: 07:21

    self:ShowEndTime(false);

    if self.data then
        self:SetLeftText();
    end
end

function AdvanceDungeonPanel:StartLeftTime(leftTime)
    leftTime = leftTime or os.time() + 59;
    if self.leftSchedule then
        StopSchedule(self.leftSchedule);
        self.leftSchedule = nil;
    end
    self.leftSchedule = GlobalSchedule.StartFun(handler(self, self.WaveEnd), 0.2, -1);
end

function AdvanceDungeonPanel:SetLeftText()
    local dungeConfig = Config.db_dunge[self.model.curDungeonID];
    self.count = self.count or {};
    if dungeConfig and dungeConfig.des then
        self.dun_name.text = dungeConfig.name;
        self.des.text = "Dungeon Intro: \n" .. dungeConfig.des;

        local complete = String2Table(dungeConfig.complete);
        local con = "Require: \n";
        for k, v in pairs(complete) do
            local type = v[1];
            local id = v[2];
            local needNum = v[3];
            local currentNum = self.count[id] or 0
            if type == "creep" and Config.db_creep[id] then
                if currentNum >= needNum then
                    con = con .. "Slay:" .. Config.db_creep[id].name .. "（<color=#5BD022>" .. currentNum .. "/" .. needNum .. "</color>）\n";
                else
                    con = con .. "Slay:" .. Config.db_creep[id].name .. "（<color=#ff0000>" .. currentNum .. "/" .. needNum .. "</color>）\n";--</color>/<color=#5BD022>
                end

            end
        end
        self.round.text = con;
    end
end

function AdvanceDungeonPanel:EndDungeon()
    local data = DungeonModel:GetInstance().DungeEnter[DungeonModel:GetInstance().curDungeonID];

    if not data then
        return ;
    end

    local timeTab = nil;
    local timestr = "";
    local formatTime = "%02d";
    if data.etime then
        if not self.startSchedule and not self.dungeon_is_exit then
            SetGameObjectActive(self.endTime.gameObject, true);
        end

        timeTab = TimeManager:GetLastTimeData(os.time(), data.etime);
        if table.isempty(timeTab) then
            Notify.ShowText("The dungeon is over. It's time to clean up");
            SetGameObjectActive(self.endTime.gameObject, false);
            GlobalSchedule.StopFun(self.endDungeSchedule);
        else
            timestr = "";
            if timeTab.min then
                timestr = timestr .. string.format(formatTime, timeTab.min) .. ":";
            end
            if timeTab.sec then
                timestr = timestr .. string.format(formatTime, timeTab.sec);
            end
            self.endTitleTxt.text = timestr;--"副本倒计时: " ..
        end
    end

    if self.dungeonStartTime then
        timeTab = TimeManager:GetLastTimeData(os.time(), self.dungeonStartTime + (60 * (4 - tonumber(self.star))));

        if table.isempty(timeTab) then
            if self.star > 0 then
                self.star = self.star - 1;
                self:SetStar(4 - self.star);
            else
                Notify.ShowText("The dungeon is over. It's time to clean up");
                SetGameObjectActive(self.endTime.gameObject, false);
                GlobalSchedule.StopFun(self.endDungeSchedule);
            end
        else
            timestr = "";
            --<color=#5BD022>02:22</color>秒后
            --降到:<color=#5BD022>2</color>星评价
            timeTab.min = timeTab.min or 0;
            if timeTab.min then
                timestr = timestr .. string.format(formatTime, timeTab.min) .. ":";
            end
            if timeTab.sec then
                timestr = timestr .. string.format(formatTime, timeTab.sec);
            end
            if self.star - 1 >= 0 then
                self.pingjia.text = "<color=#5BD022>" .. timestr .. "</color>Sec later\nLower to:<color=#5BD022>" .. (self.star - 1) .. "</color>Star ratings";
            else
                self.pingjia.text = "<color=#5BD022>" .. timestr .. "</color>Sec later\nLower to:<color=#5BD022>0</color> Star ratings";
            end

        end
    end

    AdvanceDungeonPanel.super.EndDungeon(self);
end

function AdvanceDungeonPanel:AddEvent()
    --开一个定时器固定时间请求副本信息

    self.schedules[1] = GlobalSchedule:Start(handler(self, self.RequestInfo), 2, -1);

    --结束副本时间
    self.advanceschedules = GlobalSchedule:Start(handler(self, self.EndDungeon), 0.2, -1);

    self.events[#self.events + 1] = GlobalEvent:AddListener(DungeonEvent.DUNGEON_EXP_GOLD_INFO, handler(self, self.HandleData))

    --self.event_id_1 = AddModelEvent(DungeonEvent.ResEnterDungeonInfo, handler(self,self.HandleEnterDungeInfo) , DungeonModel:GetInstance());

    self:RequestInfo();

    GlobalEvent.AddEventListenerInTab(EventName.NewSceneObject, handler(self, self.HandleNewCreate), self.events);

    AddEventListenerInTab(DungeonEvent.DUNGEON_AUTO_EXIT, handler(self, self.HandleAutoExit), self.events);

    local call_back = function()
        SetGameObjectActive(self.endTime.gameObject, false);
        self.hideByIcon = true;
    end

    self.events[#self.events + 1] = GlobalEvent.AddEventListener(MainEvent.ShowTopRightIcon, call_back);

    local call_back1 = function()
        if not self.startSchedule and not self.dungeon_is_exit then
            self.endTime.gameObject:SetActive(true);
        end
        self.hideByIcon = false;
    end

    self.events[#self.events + 1] = GlobalEvent.AddEventListener(MainEvent.HideTopRightIcon, call_back1);

end

function AdvanceDungeonPanel:HandleAutoExit()
    self.dungeon_is_exit = true;
    SetGameObjectActive(self.endTime.gameObject, false);
    if self.endDungeSchedule then
        GlobalSchedule.StopFun(self.endDungeSchedule);
    end
end

function AdvanceDungeonPanel:HandleEnterDungeInfo()
    if self.endDungeSchedule then
        GlobalSchedule.StopFun(self.endDungeSchedule);
    end
    self.dungeonStartTime = os.time();
    self.star = 3;
    self:SetStar(4 - self.star);
    self.endDungeSchedule = GlobalSchedule.StartFun(handler(self, self.EndDungeon), 0.2, -1);
end

local exampletab = {
    ["ptime"] = 1556723438,
    ["id"] = 30402,
    ["stype"] = 308,
    ["floor"] = 0,
    ["etime"] = 1556725233
}
function AdvanceDungeonPanel:HandleEndDunge()
    if true then
        return ;
    end
    local data = DungeonModel:GetInstance().DungeEnter[DungeonModel:GetInstance().curDungeonID];

    if not data then
        return ;
    end

    local timeTab = nil;
    local timestr = "";
    local formatTime = "%02d";
    if data.etime then
        if not self.startSchedule and not self.dungeon_is_exit then
            SetGameObjectActive(self.endTime.gameObject, true);
        end

        timeTab = TimeManager:GetLastTimeData(os.time(), data.etime);
        if table.isempty(timeTab) then
            Notify.ShowText("The dungeon is over. It's time to clean up");
            SetGameObjectActive(self.endTime.gameObject, false);
            GlobalSchedule.StopFun(self.endDungeSchedule);
        else
            timestr = "";
            if timeTab.min then
                timestr = timestr .. string.format(formatTime, timeTab.min) .. "_";
            end
            if timeTab.sec then
                timestr = timestr .. string.format(formatTime, timeTab.sec);
            end
            self.endTitleTxt.text = timestr;--"副本倒计时: " ..
        end
    end

    if self.dungeonStartTime then
        timeTab = TimeManager:GetLastTimeData(os.time(), self.dungeonStartTime + (60 * (4 - tonumber(self.star))));

        if table.isempty(timeTab) then
            if self.star > 0 then
                self.star = self.star - 1;
                self:SetStar(4 - self.star);
            else
                Notify.ShowText("The dungeon is over. It's time to clean up");
                SetGameObjectActive(self.endTime.gameObject, false);
                GlobalSchedule.StopFun(self.endDungeSchedule);
            end
        else
            timestr = "";
            --<color=#5BD022>02:22</color>秒后
            --降到:<color=#5BD022>2</color>星评价
            timeTab.min = timeTab.min or 0;
            if timeTab.min then
                timestr = timestr .. string.format(formatTime, timeTab.min) .. ":";
            end
            if timeTab.sec then
                timestr = timestr .. string.format(formatTime, timeTab.sec);
            end
            if self.star - 1 >= 0 then
                self.pingjia.text = "<color=#5BD022>" .. timestr .. "</color>Sec later\nLower to:<color=#5BD022>" .. (self.star - 1) .. "</color>Star ratings";
            else
                self.pingjia.text = "<color=#5BD022>" .. timestr .. "</color>Sec later\nLower to:<color=#5BD022>0</color> Star ratings";
            end

        end
    end
end

local temptab = {

}
function AdvanceDungeonPanel:HandleData(data)
    if data.stype ~= enum.SCENE_STYPE.SCENE_STYPE_DUNGE_MOUNT then
        return ;
    end
    self.count = data.count;
    self:SetLeftText();
end

function AdvanceDungeonPanel:ShowKillTip(bool)
    bool = toBool(bool);
    SetGameObjectActive(self.killtip, bool);
end

function AdvanceDungeonPanel:ShowEndTime(bool)
    bool = toBool(bool);
    SetGameObjectActive(self.endTime.gameObject, bool);
end

function AdvanceDungeonPanel:SetStar(num)
    for i = 1, #self.stars do
        --SetGameObjectActive(self.stars[i].gameObject, false)
        self.stars[i].isOn = false;
    end
    for i = num, #self.stars do
        --SetGameObjectActive(self.stars[i].gameObject, true)
        self.stars[i].isOn = true;
    end
end

function AdvanceDungeonPanel:HandleNewCreate(monster)
    if monster then
        if monster and monster.object_type == enum.ACTOR_TYPE.ACTOR_TYPE_CREEP then
            local config = Config.db_creep[monster.object_info.id];
            local sceneid = monster.config.scene_id;
            local dungeonConfig = Config.db_dunge[monster.config.scene_id];

            if dungeonConfig and dungeonConfig.stype == enum.SCENE_STYPE.SCENE_STYPE_DUNGE_MOUNT then
                if sceneid == 30401 then
                    --风
                    if config.rarity == enum.CREEP_RARITY.CREEP_RARITY_BOSS2 then
                        monster.advance_container = AdvanceDungeonItem();
                        monster.advance_container:ShowDes(true, "Defeat it to clear the dungeon");
                        monster.advance_container:UpdateLockPos(-monster:GetBodyHeight());
                        monster.advance_container:ShowLock(true);
                    end
                elseif sceneid == 30402 then
                    --火
                    if config.rarity == enum.CREEP_RARITY.CREEP_RARITY_ELITE then
                        monster.advance_container = AdvanceDungeonItem();
                        monster.advance_container:ShowDes(true, "Defeat it to reduce boss attributes");
                    end
                elseif sceneid == 30403 then
                    --山
                    if config.rarity == enum.CREEP_RARITY.CREEP_RARITY_BOSS2 then
                        monster.advance_container = AdvanceDungeonItem();
                        monster.advance_container:ShowDes(true, "Defeat it to reduce minion attributes");
                        monster.advance_container:UpdateLockPos(-monster:GetBodyHeight());
                        monster.advance_container:ShowLock(true);
                    end
                elseif sceneid == 30404 then
                    --龙
                    if config.rarity == enum.CREEP_RARITY.CREEP_RARITY_COMM then
                        monster.advance_container = AdvanceDungeonItem();
                        monster.advance_container:ShowDes(true, "Defeat it to silence the boss");
                        monster.advance_container:UpdateLockPos(-monster:GetBodyHeight() / 2);
                    end
                end
                monster:SetAdvanceItemPos();
            end
        end
    end
end

function AdvanceDungeonPanel:StopAllSchedules()
    for i = 1, #self.schedules, 1 do
        GlobalSchedule:Stop(self.schedules[i]);
    end
    if self.advanceschedules then
        GlobalSchedule:Stop(self.advanceschedules);
    end
    self.advanceschedules = nil;
    self.schedules = {};
end