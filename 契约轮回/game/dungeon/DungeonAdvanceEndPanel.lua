---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by win 10.
--- DateTime: 2018/10/10 10:53
---
DungeonAdvanceEndPanel = DungeonAdvanceEndPanel or class("DungeonAdvanceEndPanel", BasePanel)
local this = DungeonAdvanceEndPanel

function DungeonAdvanceEndPanel:ctor()
    self.abName = "dungeon";
    self.image_ab = "dungeon_image";
    self.assetName = "DungeonAdvanceEndPanel"
    self.layer = "UI"

    self.model = DungeonModel.GetInstance()
    self.events = {};
    self.schedules = {};


    --DungeonCtrl:GetInstance().DungeonAdvanceEndPanel = self;
end

function DungeonAdvanceEndPanel:dctor()
    GlobalEvent:RemoveTabListener(self.events);
    if self.event_id_1 then
        self.model:RemoveListener(self.event_id_1)
        self.event_id_1 = nil
    end
    self:StopAllSchedules()
    self.model = nil;
    if self.enditem then
        self.enditem:destroy();
    end

    self.enditem = nil;
    self:OpenEntrance();
end

function DungeonAdvanceEndPanel:Open(data)
    self.data = data;
    WindowPanel.Open(self)
end

function DungeonAdvanceEndPanel:LoadCallBack()
    self.nodes = {
        "endCon", "awardCon", "zhandoujiangli", "sure/sureText", "winLabels/label3", -- "sure",

        "lose/mountlabel", "lose/equip_1", "lose/mount", "lose/equip_label_2", "lose", "lose/equip_2", "lose/equip_label_1",

        "jy/jingyan", "jy",
    }
    self:GetChildren(self.nodes)
    local orderIndex = LayerManager:GetInstance():GetLayerOrderByName(self.layer)
    self:SetOrderIndex(orderIndex + 5)

    SetLocalPosition(self.transform, 0, 0, 0)
    --AddBgMask(self.gameObject, 0, 0, 0, 230);
    self:Init();

    self:AddEvent();

    if AutoFightManager:GetInstance():GetAutoFightState() then
        GlobalEvent:Brocast(FightEvent.AutoFight)
    end
end

local exampleTable = {
    ["star"] = 3,
    ["isClear"] = true,
    ["stype"] = 308,
    ["id"] = 30402,
    ["reward"] = {
        [50000] = 9,
        [90010001] = 1,
        [90010002] = 4117734562,
        [55000] = 15
    }
}
function DungeonAdvanceEndPanel:Init()
    print2(">>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>");
    print2(Table2String(self.data));
    --if self.data.star then
    --    if self.data.star == 2 then
    --        self.data.star = 3;
    --    elseif self.data.star == 3 then
    --        self.data.star = 7;
    --    end
    --end
    self.label3 = GetText(self.label3);
    self.enditem = DungeonEndItem(self.transform, self.data);
    self.enditem:StartAutoClose(50);

    self.jingyan = GetText(self.jingyan);

    if self.data.isClear then
        self.enditem:ShowStars(true);

        --SetLocalPosition(self.zhandoujiangli.transform, 151, 89, 0);
        --SetLocalPosition(self.awardCon.transform, 276, -42, 0);
        SetGameObjectActive(self.label3.gameObject, false);
        SetGameObjectActive(self.lose.gameObject, false);
    else
        SetGameObjectActive(self.awardCon.transform, false);
        SetGameObjectActive(self.zhandoujiangli.transform, false);
        SetGameObjectActive(self.jy.gameObject, false);
    end

    if self.data then
        local reward = self.data.reward;

        if reward[enum.ITEM.ITEM_EXP] then
            self.jingyan.text = GetShowNumber(reward[enum.ITEM.ITEM_EXP]);
        else
            self.jingyan.text = "0";
        end
        local index = 1;
        destroyTab(self.items);
        self.items = {};
        for k, v in pairs(reward) do
            if k ~= enum.ITEM.ITEM_EXP then
                local item = AwardItem(self.awardCon);
                item:SetData(k, v);
                item:AddClickTips(self.transform);
                self.items[index] = item;
                index = index + 1;
            end
        end
    end
end

local closeTime = 5;
function DungeonAdvanceEndPanel:AddEvent()
    local function closeCallBack()
        SceneControler:GetInstance():RequestSceneLeave();
        self:Close();
    end
    self.enditem:SetAutoCloseCallBack(closeCallBack);

    local time = 5;
    local dungeTab = Config.db_dunge[SceneManager:GetInstance():GetSceneId()];
    if dungeTab then
        time = dungeTab.exit_cd;
    end
    time = time or 5;
    self.enditem:StartAutoClose(time);

    local function call_back()
        self:Close()
    end

    self.enditem:SetCloseCallBack(closeCallBack);

    self.events[#self.events + 1] = GlobalEvent:AddListener(DungeonEvent.LEAVE_DUNGEON_SCENE, call_back)

    self.event_id_1 = self.model:AddListener(DungeonEvent.ResEnterDungeonInfo, call_back)

    local call_back1 = function(target, x, y)
        GlobalEvent.BrocastEvent(MountEvent.OPEN_MOUNT_PANEL);
    end
    AddClickEvent(self.mount.gameObject, call_back1);

    local call_back2 = function(target, x, y)
        Notify.ShowText("Tap [Craft Gear]")--GlobalEvent.BrocastEvent(MountEvent.OPEN_MOUNT_PANEL);
    end
    AddClickEvent(self.equip_1.gameObject, call_back2);

    local call_back3 = function(target, x, y)
        Notify.ShowText("Tap [Forge]")--GlobalEvent.BrocastEvent(MountEvent.OPEN_MOUNT_PANEL);
    end
    AddClickEvent(self.equip_2.gameObject, call_back3);
end

function DungeonAdvanceEndPanel:StopAllSchedules()
    for i = 1, #self.schedules, 1 do
        GlobalSchedule:Stop(self.schedules[i]);
    end
    self.schedules = {};
end

function DungeonAdvanceEndPanel:OpenEntrance()
    local fun2 = function()
        lua_panelMgr:GetPanelOrCreate(DungeonEntrancePanel):Open(1, 3);
        if self.openschedule then
            GlobalSchedule.StopFun(self.openschedule);
        end
        self.openschedule = nil;
    end
    --说起来你可能不信,但是这段就是这么复杂
    local fun = function()
        if self.openevent then
            GlobalEvent:RemoveListener(self.openevent);
        end
        if self.openschedule then
            GlobalSchedule.StopFun(self.openschedule);
        end
        self.openevent = nil;
        GlobalSchedule.StartFunOnce(fun2, 0.5);
    end
    self.openschedule = GlobalSchedule.StartFunOnce(fun2, 5);
    self.openevent = AddModelEvent(EventName.ChangeSceneEnd, fun);
end












