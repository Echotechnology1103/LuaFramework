---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by win 10.
--- DateTime: 2018/10/10 10:53
---
DungeonEndItem = DungeonEndItem or class("DungeonEndItem", BaseItem)
local this = DungeonEndItem
--外部传进来的Fun,在自动关闭时会执行
DungeonEndItem.autoCloseFun = nil;
--外部传进来的fun,在点击关闭按钮时会执行
DungeonEndItem.closeBtnFun = nil;

--外部传进来的格式,如:挑战下一关(%s)
DungeonEndItem.sure_format = nil;
--外部传进来的格式,如:关闭(%s)
DungeonEndItem.close_format = nil;

function DungeonEndItem:ctor(parent_node, data)
    self.abName = "dungeon";
    self.image_ab = "dungeon_image";
    self.assetName = "DungeonEndItem"
    self.layer = data.layer or "Bottom";
    self.data = data;
    self.model = DungeonModel.GetInstance()
    self.events = {};
    self.schedules = {};
    DungeonEndItem.super.Load(self);
    --DungeonCtrl:GetInstance().DungeonEndItem = self;
end

function DungeonEndItem:dctor()
    GlobalEvent:RemoveTabListener(self.events);
    if self.event_id_1 then
        self.model:RemoveListener(self.event_id_1)
        self.event_id_1 = nil
    end
    self.model = nil;

    if self.autoschedule then
        GlobalSchedule.StopFun(self.autoschedule);
    end

    self.autoCloseFun = nil;
    self.closeBtnFun = nil;

    if self.effect_Win ~= nil then
        self.effect_Win:destroy()
    end

    if self.effect_Win2 ~= nil then
        self.effect_Win2:destroy()
    end
    self.autocloseupdatecallback = nil;

    self.starimgItems = nil;
end

function DungeonEndItem:Open(data)
    self.data = data;
    WindowPanel.Open(self)
end

function DungeonEndItem:LoadCallBack()
    self.nodes = {
        "win", "lose", "autoCloseText",
        "win/WinEffect", "win/bg",
        "btns", "btns/sureBtn", "btns/closeBtn", "btns/sureBtn/sureText", "btns/closeBtn/closeText",
        "win/bg/starCon", "win/bg/starCon/star1", "win/bg/starCon/star2", "win/bg/starCon/star3",
    }
    self:GetChildren(self.nodes)
    self.sureBtnImg = GetImage(self.sureBtn)

    SetLocalPosition(self.transform, 0, 0, 0)
    self.transform:SetAsFirstSibling();

    AddBgMask(self.gameObject, 0, 0, 0, 160);
    self:Init();

    self:AddEvent();
end

--[[
{
	["coin"]=0,
	["star"]=0,
	["floor"]=1,
	["isClear"]=false
}
--]]
function DungeonEndItem:Init()

    --self.winCanvas = self.bg:GetComponent("Canvas")
    --local orderIndex = LayerManager:GetInstance():GetLayerOrderByName(self.layer)
    --self.winCanvas.sortingOrder = orderIndex + 10

    LayerManager:GetInstance():AddOrderIndexByCls(self, self.bg, nil, true, nil, false, 5)

    self.autoCloseText = GetText(self.autoCloseText);--倒数时间
    self.closeBtn = GetButton(self.closeBtn);
    self.sureBtn = GetButton(self.sureBtn);
    self.sureText = GetText(self.sureText);
    self.closeText = GetText(self.closeText);

    self:SetBtnText();

    SetVisible(self.sureBtn.gameObject, false);

    self.starimgItems = {};

    for i = 1, 3, 1 do
        self.starimgItems[i] = GetImage(self["star" .. i]);
        SetGameObjectActive(self.starimgItems[i].gameObject, false);
    end

    self:InitData();

    self:ShowStars(self.isShowStar);

    self:ShowSureBtn(self.sureFun);
end

function DungeonEndItem:InitData(data)
    self.data = data or self.data;
    if self.data then
        if (self.data.isClear) then
            SetGameObjectActive(self.win.gameObject, true);
            SetGameObjectActive(self.lose.gameObject, false);
            self:LoadWinEffect()
        else
            SetGameObjectActive(self.win.gameObject, false);
            SetGameObjectActive(self.lose.gameObject, true);
            SetColor(self.autoCloseText, 212, 212, 216);
            --SetOutLineColor(GetOutLine(self.autoCloseText.transform), 59, 56, 71);
        end
		if self.is_Gray then 
			ShaderManager:GetInstance():SetImageGray(self.sureBtnImg)
			self.is_Gray = false
		else
			ShaderManager:GetInstance():SetImageNormal(self.btnImg)
		end
    end
end

function DungeonEndItem:LoadWinEffect()
    self.effect_Win = UIEffect(self.WinEffect, 10401, false, self.layer)
    self.effect_Win:SetConfig({ orderOffset = 3 , })

    self.effect_Win2 = UIEffect(self.WinEffect, 10402, false, self.layer)
    self.effect_Win2:SetConfig({ scale = 1.06, orderOffset = 7, pos = { x = 0, y = 10, z = 0 } })
end

function DungeonEndItem:AddEvent()

    if self.data and self.data.IsCancelAutoSchedule then
        self.autoCloseText.text = "";
        SetGameObjectActive(self.autoCloseText.gameObject, false);
    else
        if not self.autoschedule then
            local time = 10;
            local dungeTab = Config.db_dunge[SceneManager:GetInstance():GetSceneId()];
            if dungeTab then
                time = dungeTab.exit_cd;
            end
            time = time or 10;
            self.enditem:StartAutoClose(time);
            self:StartAutoClose(time);
        end
    end

    local call_back = function()
        if self.closeBtnFun then
            self.closeBtnFun();
            self.closeBtnFun = nil;
        end
    end

    AddClickEvent(self.closeBtn.gameObject, call_back);
end

function DungeonEndItem:StartAutoClose(closetime)
    closetime = closetime or 60;
    local function callBack1 (data)
        closetime = closetime - 1;
        --以下这个迟点要注释掉,因为想改成按钮上的文字显示关闭
        if self.autoCloseText then
            --self.autoCloseText.text = tostring(closetime) .. "Closing in X sec";
            self.autoCloseText.text = string.format("Closing in %s sec",tostring(closetime))
        end
        self:SetBtnText(closetime);
        if closetime <= 0 then
            --SceneControler:GetInstance():RequestSceneLeave();
            if self.autoCloseFun then
                self.autoCloseFun();
                self.autoCloseFun = nil;
            end
            GlobalSchedule.StopFun(self.autoschedule);
            SetGameObjectActive(self.autoCloseText, false);
        end
    end
    if self.autoschedule then
        GlobalSchedule.StopFun(self.autoschedule);
    end
    self:SetBtnText(closetime);
    self.autoschedule = GlobalSchedule:Start(callBack1, 1, -1);
end

function DungeonEndItem:SetBtnText(closetime)
    closetime = closetime or self.tempclosetime;
    self.tempclosetime = closetime;
    if not closetime then
        return ;
    end
    if self.sure_format and self.sureText then
        self.sureText.text = string.format(self.sure_format, tostring(closetime))
    end

    if self.close_format and self.closeText then
        self.closeText.text = string.format(self.close_format, tostring(closetime))
    end
end

function DungeonEndItem:SetCloseCallBack(fun)
    self.closeBtnFun = fun;
end

function DungeonEndItem:SetAutoCloseCallBack(fun)
    self.autoCloseFun = fun;
end

function DungeonEndItem:SetSureBtnGray()
	self.is_Gray= true
end
--需要下放到子类
function DungeonEndItem:ShowSureBtn(func)
    if self.is_loaded then
        if func then
            SetVisible(self.sureBtn, true)
            local function call_back(target, x, y)
                func();
            end
            AddClickEvent(self.sureBtn.gameObject, call_back)
        end
    else
        self.sureFun = func;
    end
end

function DungeonEndItem:ShowStars(bool)
    bool = toBool(bool);
    if not self.is_loaded then
        self.isShowStar = bool
        return ;
    end
    if bool then
        local bs = BitState(self.data.star);
        for i = 1, 3, 1 do
            local isOn = toBool(bs:Contain(BitState.State[i]));
            self.starimgItems[i].gameObject:SetActive(isOn);

            if isOn then
                self.starimgItems[i].transform.localScale = Vector3(6, 6, 6);

                local localPos = self.starimgItems[i].transform.localPosition;
                --
                local scaleAction = cc.ScaleTo(0.2, 0.5, 0.5, 0.5);
                local scaleAction2 = cc.ScaleTo(0.1, 1, 1, 1);
                if i == 3 then
                    scaleAction = cc.ScaleTo(0.2, -0.5, 0.5, 0.5);
                    scaleAction2 = cc.ScaleTo(0.1, -1, 1, 1);
                    self.starimgItems[i].transform.localScale = Vector3(-6, 6, 6);
                end

                if i > 1 then
                    local delayAction = cc.DelayTime(0.1 * i);
                    self.starimgItems[i].gameObject:SetActive(false);
                    local end_call = function()
                        self.starimgItems[i].gameObject:SetActive(true);
                    end
                    local finAction = cc.CallFunc(end_call);
                    local scaleAction1 = cc.Sequence(delayAction, finAction, scaleAction, scaleAction2);
                    cc.ActionManager:GetInstance():addAction(scaleAction1, self.starimgItems[i].transform);
                else
                    local scaleAction3 = cc.Sequence(scaleAction, scaleAction2);
                    cc.ActionManager:GetInstance():addAction(scaleAction3, self.starimgItems[i].transform);
                end
            end
        end
    end
end
