---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by win 10.
--- DateTime: 2018/10/10 10:53
---
DungeonGuildGuardEndPanel = DungeonGuildGuardEndPanel or class("DungeonGuildGuardEndPanel", BasePanel)
local this = DungeonGuildGuardEndPanel

function DungeonGuildGuardEndPanel:ctor()
    self.abName = "dungeon";
    self.image_ab = "dungeon_image";
    self.assetName = "GuildGuardEndPanel"
    self.layer = "UI"

    self.model = DungeonModel.GetInstance()
    self.events = {};
    self.schedules = {};
end

function DungeonGuildGuardEndPanel:dctor()
    GlobalEvent:RemoveTabListener(self.events);
    if self.event_id_1 then
        self.model:RemoveListener(self.event_id_1)
        self.event_id_1 = nil
    end
    self:StopAllSchedules()
    self.model = nil;
    if self.enditem then
        self.enditem:destroy();
    end
end

function DungeonGuildGuardEndPanel:Open(data)
    self.data = data;
    print2(">>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>");
    print2(Table2String(self.data));
    WindowPanel.Open(self)
end

function DungeonGuildGuardEndPanel:LoadCallBack()
    self.nodes = {
        "lose", "lose/jingyan_defeat", "lose/jingyanlogo_defeat", "lose/huodejingyan_defeat", "lose/label_icon1",
        "lose/mount", "lose/equip_1", "lose/equip_2",

        "win", "win/killnum", "win/s_award", "win/winLabels/kill_label", "win/jingyan", "win/my_rank", "win/winLabels/my_rank_label", "win/winLabels/success_label", "win/winLabels/ranklabel",
    }
    self:GetChildren(self.nodes)
    local orderIndex = LayerManager:GetInstance():GetLayerOrderByName(self.layer)
    self:SetOrderIndex(orderIndex + 5)

    SetLocalPosition(self.transform, 0, 0, 0)
    self:Init();

    self:AddEvent();

    if AutoFightManager:GetInstance():GetAutoFightState() then
        GlobalEvent:Brocast(FightEvent.AutoFight)
    end
end

function DungeonGuildGuardEndPanel:Init()
    --print2(Table2String(self.data));
    self.enditem = DungeonEndItem(self.transform, self.data);

    self.killnum = GetText(self.killnum);
    self.s_award = GetText(self.s_award);
    self.jingyan = GetText(self.jingyan);
    self.my_rank = GetText(self.my_rank);

    self.jingyan_defeat = GetText(self.jingyan_defeat);
    self.huodejingyan_defeat = GetText(self.huodejingyan_defeat);
    self.jingyanlogo_defeat = GetImage(self.jingyanlogo_defeat);
    self.label_icon1 = GetImage(self.label_icon1);

    self.killnum = GetText(self.killnum);

    local level = RoleInfoModel:GetInstance():GetMainRoleLevel();
    local expTab = Config.db_exp_acti_base[level];
    local multab = {};
    multab[enum.ITEM.ITEM_PLAYER_EXP] = expTab.player_exp;
    multab[enum.ITEM.ITEM_WORLDLV_EXP] = expTab.worldlv_exp;

    if self.data then
        local killMonnum = 0;
        if self.data["count"] then
            for k, v in pairs(self.data["count"]) do
                killMonnum = killMonnum + v;
            end
        end
        self.killnum.text = GetShowNumber(self.data.exp or 0);
        if self.data.rank and self.data.rank ~= 0 then
            self.my_rank.text = string.format("No.%s", self.data.rank);
        else
            self.my_rank.text = "Didn't make list";
        end

        local rankTab = Config.db_guild_guard_rank[self.data.rank];
        if not rankTab then
            rankTab = Config.db_guild_guard_rank[#Config.db_guild_guard_rank];
        end
        local rankExp = 0;
        if rankTab then
            local rankReward = LString2Table(rankTab.reward)[1];--一定要有个[1]在后面
            local key = rankReward[1];
            rankExp = tonumber(rankReward[2]) * tonumber(multab[key] or 1);
        end


        -- 成功界面
        if self.data.isClear == true then
            local successVal = GetGameConfigVal("guild_guard_succ");
            if successVal then
                local key = successVal[1][1][1];
                local value = successVal[1][1][2];
                self.s_award.text = GetShowNumber((tonumber(value) * (multab[key] or 0)));
            else
                self.s_award.text = "0";
            end
            self.jingyan.text = GetShowNumber(rankExp);
            self.win.gameObject:SetActive(true);
            self.lose.gameObject:SetActive(false);
            -- 失败界面
        else
            local failVal = GetGameConfigVal("guild_guard_fail");
            local failExp = 0;
            if failVal then
                local key = failVal[1][1][1];
                local value = failVal[1][1][2];
                failExp = tostring((tonumber(value) * (multab[key] or 0)));
                self.s_award.text = failExp
                --self.s_award.text = tostring(successVal[1][1][2]);
            else
                self.s_award.text = "0";
            end
            self.win.gameObject:SetActive(false);
            self.lose.gameObject:SetActive(true);
            local totalexp = self.data.exp + failExp + rankExp;
            self.jingyan_defeat.text = GetShowNumber(totalexp);
        end
    end
    local time = 5;
    local dungeTab = Config.db_dunge[SceneManager:GetInstance():GetSceneId()];
    if dungeTab then
        time = dungeTab.exit_cd;
    end
    time = time or 5;
    self.enditem:StartAutoClose(time);
end

local closeTime = 5;
function DungeonGuildGuardEndPanel:AddEvent()
    local function callBack1 (data)
        SceneControler:GetInstance():RequestSceneLeave();
        self:Close();
    end
    self.enditem:SetAutoCloseCallBack(callBack1);

    local function call_back()
        self:Close()
    end
    self.events[#self.events + 1] = GlobalEvent:AddListener(DungeonEvent.LEAVE_DUNGEON_SCENE, call_back)

    self.event_id_1 = self.model:AddListener(DungeonEvent.ResEnterDungeonInfo, call_back)

    local call_back = function()
        SceneControler:GetInstance():RequestSceneLeave();
        self:Close();
    end

    self.enditem:SetCloseCallBack(call_back);

    local call_back1 = function(target, x, y)
        GlobalEvent.BrocastEvent(MountEvent.OPEN_MOUNT_PANEL);
    end
    AddClickEvent(self.mount.gameObject, call_back1);

    local call_back2 = function(target, x, y)
        Notify.ShowText("Tap [Craft Gear]")--GlobalEvent.BrocastEvent(MountEvent.OPEN_MOUNT_PANEL);
    end
    AddClickEvent(self.equip_1.gameObject, call_back2);

    local call_back3 = function(target, x, y)
        Notify.ShowText("Tap [Forge]")--GlobalEvent.BrocastEvent(MountEvent.OPEN_MOUNT_PANEL);
    end
    AddClickEvent(self.equip_2.gameObject, call_back3);
end

function DungeonGuildGuardEndPanel:StopAllSchedules()
    for i = 1, #self.schedules, 1 do
        GlobalSchedule:Stop(self.schedules[i]);
    end
    self.schedules = {};
end