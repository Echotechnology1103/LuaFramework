---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by win 10.
--- DateTime: 2018/10/9 17:34
--- 经验副本的UI

ExpDungeonPanel = ExpDungeonPanel or class("ExpDungeonPanel", DungeonMainBasePanel)
local this = ExpDungeonPanel

ExpDungeonPanel.buffs = {
    130120001,
    130120002,
    130120003,
    130120004,
    130120005,
    130120006,
    130120007,
    130120008,
    130120009,
    130120010,

}
ExpDungeonPanel.buffs2 = {
    130130001,
    130130002,
    130130003,
}

ExpDungeonPanel.buffs3 = {
    [10015] = 130130001,
    [10016] = 130130002,
    [10017] = 130130003,
}

function ExpDungeonPanel:ctor()
    self.abName = "dungeon"
    self.assetName = "ExpDungeonPanel"

    self.events = {};
    self.schedules = {};
end

function ExpDungeonPanel:dctor()
    self.model = nil;
    --[[if self.useitem_ins then
        self.useitem_ins:destroy()
        self.useitem_ins = nil
    end--]]
    GlobalEvent:RemoveTabListener(self.events);
    self:StopAllSchedules();
    if self.Rschedule then
        GlobalSchedule.StopFun(self.Rschedule);
    end
    self.Rschedule = nil;

    if self.onceFade then
        GlobalSchedule.StopFun(self.onceFade );
    end
    self.onceFade = nil;
	
	if self.guide_item then
		self.guide_item:destroy()
		self.guide_item = nil
	end
end

function ExpDungeonPanel:Open()
    WindowPanel.Open(self)
end

function ExpDungeonPanel:LoadCallBack()
    self.nodes = {
        "rightTop", "rightTop/effBtn", "expshow/med", "expshow/activity",  "dungeonName", "dungeonName/dungeonNamebg", "dungeonName/dungeonNametxt", --"expshow/team",
        "expshow", "startTime", "startTime/time", "rightTop/guBtn", "expshow/guwuValue", "expshow/worldlevel", "expshow/expget", "endTime", "endTime/endText",
        "expshow/killnum","item_parent",
    }
    self:GetChildren(self.nodes);

    SetAlignType(self.rightTop, bit.bor(AlignType.Right, AlignType.Top), nil)

    SetLocalPosition(self.transform, 0, 0, 0)
    SetLocalPosition(self.rightTop.transform, -33, 0, 0);--(DeviceResolutionWidth - ScreenWidth) / 2
    --self.useitem_go = self.useitem.gameObject
    --SetVisible(self.useitem_go, false)
    self:Init();
    self:AddEvent();

    --开一个定时器固定时间请求副本信息
    self:RequestInfo();
    self.schedules[1] = GlobalSchedule:Start(handler(self, self.RequestInfo), 2, -1);

    --10秒后开始战斗
    --self.start_dungeon_time = 0;
    --self.schedules[2] = GlobalSchedule:Start(handler(self, self.StartDungeon), 1, -1);

    --结束副本时间
    self.schedules[3] = GlobalSchedule:Start(handler(self, self.EndDungeon), 1, -1);

    self.onceFade = GlobalSchedule.StartFunOnce(function()
        if self.dungeonNametxt and self.dungeonNamebg then
            local moveAction = cc.FadeOut(3, self.dungeonNametxt);
            local moveAction1 = cc.FadeOut(3, self.dungeonNamebg);
            cc.ActionManager:GetInstance():addAction(moveAction, self.dungeonNametxt.transform);
            cc.ActionManager:GetInstance():addAction(moveAction1, self.dungeonNamebg.transform);
        end
    end, 1);

    SetAlignType(self.expshow, bit.bor(AlignType.Left, AlignType.Null));

    self:InitOneKeyGuwu();

    self:HandleRefreshGUWUDRUG();

    --为了红点
    DungeonCtrl:GetInstance():RequestDungeonPanel(enum.SCENE_STYPE.SCENE_STYPE_DUNGE_EXP);
    --self.time.text = tostring(self.start_dungeon_time);
end

function ExpDungeonPanel:RequestInfo()
    --print2("请求经验副本信息");
    DungeonCtrl:GetInstance():RequeseExpDungeonInfo();
end

function ExpDungeonPanel:StartDungeon()
    --print2(self.start_dungeon_time .. "倒数开始经验副本");
    self.start_dungeon_time = self.start_dungeon_time - 1;
    self.time.text = tostring(self.start_dungeon_time);
    if self.start_dungeon_time <= 0 then
        self.startTime.gameObject:SetActive(false);

        if self.schedules[2] then
            GlobalSchedule:Stop(self.schedules[2]);
        end
        self.schedules[2] = nil;
        --防止自动战斗不打
        TaskModel:GetInstance():StopTask();--先停掉任务,因为任务优先级高
        --停止自动寻路
        OperationManager:GetInstance():StopAStarMove();
    end
end

function ExpDungeonPanel:EndDungeon()
    if self.endDungeonTime and self.start_dungeon_time <= 0 then
        self.endTime.gameObject:SetActive(true);
    end
    if self.endDungeonTime and self.endTime.gameObject.activeSelf then
        --self.endDungeonTimeTab = os.date("*t" , (self.endDungeonTime - os.time()));
        self.endDungeonTimeTab2 = TimeManager:GetLastTimeData(os.time(), self.endDungeonTime);
        if not self.endDungeonTimeTab2 then
            self.endTime.gameObject:SetActive(false);
            if self.schedules[3] then
                GlobalSchedule:Stop(self.schedules[3]);
                return ;
            end
        end
        if not self.endDungeonTimeTab2.min then
            self.endDungeonTimeTab2.min = 0;
        end
        self.endText.text = tostring(string.format("%02d", self.endDungeonTimeTab2.min) .. ":" .. string.format("%02d", self.endDungeonTimeTab2.sec));
    end

    self:RHandleRefreshGUWUDRUG();

    ExpDungeonPanel.super.EndDungeon(self);


end

function ExpDungeonPanel:Init()
    self.effBtn = ExpBtnItem(self.effBtn, 2);
    self.guBtn = ExpBtnItem(self.guBtn, 1);
    self.guwuValue = GetText(self.guwuValue);
    self.med = GetText(self.med);--当前波次
    self.activity = GetText(self.activity);--活动经验加成
    --self.team = GetText(self.team);--组队经验加成
    self.expget = GetText(self.expget);--获得到的经验
    self.worldlevel = GetText(self.worldlevel);--世界等级经验加成


    self.killnum = GetText(self.killnum);

    self.time = GetText(self.time);--倒数时间

    self.endText = GetText(self.endText);

    self.endTime.gameObject:SetActive(false);

    --[[local useitemClose = function()
        self.useitem_ins = nil;
    end
    self.useitem_ins = ExpUseItem(self.useitem_go);
    self.useitemClose = useitemClose;--]]

    self.dungeonNametxt = GetImage(self.dungeonNametxt);
    self.dungeonNamebg = GetImage(self.dungeonNamebg);
end

function ExpDungeonPanel:AddEvent()

    local updateNumCallBack = function(data)
        self:HandleRefreshGUWUDRUG();
    end
    AddEventListenerInTab(BagEvent.UpdateGoods, updateNumCallBack, self.events);

    AddEventListenerInTab(DungeonEvent.DUNGEON_GUWU_OR_USEDRUG, handler(self, self.HandleRefreshGUWUDRUG), self.events);

    local call_back = function()
        SetGameObjectActive(self.endTime.gameObject, false);
        self.hideByIcon = true;
        SetGameObjectActive(self.rightTop, false)
    end

    self.events[#self.events + 1] = GlobalEvent.AddEventListener(MainEvent.ShowTopRightIcon, call_back);

    local call_back1 = function()
        if self.endDungeonTime and self.start_dungeon_time <= 0 then
            self.endTime.gameObject:SetActive(true);
        end
        SetGameObjectActive(self.rightTop, true)
        self.hideByIcon = false;
    end

    self.events[#self.events + 1] = GlobalEvent.AddEventListener(MainEvent.HideTopRightIcon, call_back1);

    AddEventListenerInTab(DungeonEvent.DUNGEON_EXIT, handler(self, self.HandleDungeonExit), self.events);
    GlobalEvent.AddEventListenerInTab(EventName.NewSceneObject, handler(self, self.HandleNewCreate), self.events);

    local function callBack1 (data)
        if data.stype ~= enum.SCENE_STYPE.SCENE_STYPE_DUNGE_EXP then
            return ;
        end
		
		if data.first_enter == 1 then
			if not self.guide_item then
				self.guide_item = DungeonNewBeeGuideItem(self.guBtn.transform, "Bottom")
				local function click_callback()
				lua_panelMgr:GetPanelOrCreate(GuwuPanel):Open()
				end
				local str = "After inspiring,<color=#3ab60e>you will gain damage boost</Color> \nObtained<color=#3ab60e>200% EXP</color>"
				self.guide_item:SetData(click_callback, nil, true, str)
			end
		else
			if not self.autoguwu then
				self.autoguwu = true;
				self:InitOneKeyGuwu();
			end
		end
			
  
		
        --鼓舞伤害       inspire
        --药水经验加成   exp_elixir
        --组队经验加成   exp_team
        --活动经验加成   exp_activity
        --世界等级加成   world_level
        --经验获得       exp_gain
        self.med.text = tostring(data.cur_wave) .. "/" .. tostring(data.max_wave);--当前波次
        self.activity.text = tostring(data.exp_activity) .. "%";--活动经验加成
        self.activity.text = tostring(data.exp_activity) .. "%";--活动经验加成
        --self.team.text = tostring(data.exp_team) .. "%";--组队经验加成
        self.guwuValue.text = tostring(data.inspire) .. "%";
        --if data.exp_gain > 100000000 then
        --    data.exp_gain = (data.exp_gain / 100000000) .. "亿";
        --else
        --    data.exp_gain = (data.exp_gain / 10000) .. "万";
        --end
        self.expget.text = tostring(GetShowNumber(data.exp_gain));--获得到的经验
        self.worldlevel.text = (data.world_level / 100) .. "%";--世界等级经验加成

        local killnum = 0;
        if data["count"] then
            for k, v in pairs(data["count"]) do
                killnum = killnum + v;
            end
        end
        self.killnum.text = killnum .. "X";

        local panel = lua_panelMgr:GetPanel(GuwuPanel);
        if panel then
            panel:UpdateCount(data.coin_inspire, data.gold_inspire);
        end

        if not self.endDungeonTime then
            self.endDungeonTime = data.end_time;
            --self.endDungeonTimeTab = os.date("*t" , (data.end_time - os.time()));
            self.endDungeonTimeTab2 = TimeManager:GetLastTimeData(os.time(), data.end_time) or {};
            self.endDungeonTimeTab2.min = self.endDungeonTimeTab2.min or 0;
            self.endDungeonTimeTab2.sec = self.endDungeonTimeTab2.sec or 0;

            self.endText.text = tostring(string.format("%02d", self.endDungeonTimeTab2.min) .. "f" .. string.format("%02d", self.endDungeonTimeTab2.sec));
        end

        if data.prep_time and not self.start_dungeon_time then
            if data.prep_time < os.time() then
                self.start_dungeon_time = 0;
                self.time.text = tostring(self.start_dungeon_time);
                self:StartDungeon();
            else
                local preptime = data.prep_time;
                local ostime = math.round(os.time());
                self.start_dungeon_time = preptime - ostime - 1;
                self.time.text = tostring(self.start_dungeon_time);
                self.schedules[2] = GlobalSchedule:Start(handler(self, self.StartDungeon), 1, -1);
            end
        end
    end

    self.events[#self.events + 1] = GlobalEvent:AddListener(DungeonEvent.DUNGEON_EXP_GOLD_INFO, callBack1)

    --[[local function call_back()
        local function func( ... )
            local lastStatus = nil;
            if self.useitem_ins then
                lastStatus = self.useitem_ins.status;
                self.useitem_ins:destroy()
                self.useitem_ins = nil
            end
            self.useitem_ins = ExpUseItem(self.useitem_go, self.item_parent)
            if lastStatus == self.useitem_ins.status then--状态一致就不显示了
                SetGameObjectActive(self.useitem_ins.gameObject , false);
                --self.useitem_ins:destroy();
                --self.useitem_ins = nil;
            end
        end
        GlobalSchedule:StartOnce(func, 1)
    end
    self.events[#self.events + 1] = GlobalEvent:AddListener(BagEvent.UpdateGoods, call_back)--]]
end

function ExpDungeonPanel:HandleRefreshGUWUDRUG()
    if self.Rschedule then
        GlobalSchedule.StopFun(self.Rschedule);
    end
    self.Rschedule = GlobalSchedule.StartFunOnce(handler(self, self.RHandleRefreshGUWUDRUG), 0.2);
end

function ExpDungeonPanel:RHandleRefreshGUWUDRUG()
    --print2("ExpDungeonPanel:RHandleRefreshGUWUDRUG");
    local mainroledata = RoleInfoModel:GetInstance():GetMainRoleData();
    if mainroledata then
        local flag, _, buffID = mainroledata:IsAddExp1Buff()
        if flag then
            local buff = Config.db_buff[buffID];
            if buff then
                self.effBtn:SetEffText(buff.desc);
                self.effBtn.showBg = false;
                self.effBtn:HideBgText();
            else
                self.effBtn:SetEffText("");
            end
        else
            self.effBtn:SetEffText("");
        end

        flag, _, buffID = mainroledata:IsAddGuWuBuff()
        if flag then
            local buff = Config.db_buff[buffID];
            if buff then
                self.guBtn:SetEffText(buff.desc);
                self.guBtn.showBg = false;
                self.guBtn:HideBgText();
            else
                self.guBtn:SetEffText("");
            end
        else
            self.guBtn:SetEffText("");
        end
        --for i = 1, #self.buffs do
        --    if mainroledata:GetBuffListIndexByID(self.buffs[i]) then
        --        local buff = Config.db_buff[self.buffs[i]];
        --        if buff then
        --            self.guBtn:SetEffText(buff.desc);
        --        else
        --            self.guBtn:SetEffText("");
        --        end
        --    end
        --end

        --for i = 1, #self.buffs2 do
        --    if mainroledata:GetBuffListIndexByID(self.buffs2[i]) then
        --        local buff = Config.db_buff[self.buffs2[i]];
        --        if buff then
        --            self.effBtn:SetEffText(buff.desc);
        --        else
        --            self.effBtn:SetEffText("");
        --        end
        --    end
        --end
    end
end


--@ling 这里写注释
function ExpDungeonPanel:HandleDungeonExit()
    if self.endTime then
        SetGameObjectActive(self.endTime.gameObject, false);
    end
    if self.schedules[3] then
        GlobalSchedule:Stop(self.schedules[3]);
        return ;
    end
end

function ExpDungeonPanel:StopAllSchedules()
    for i = 1, #self.schedules, 1 do
        GlobalSchedule:Stop(self.schedules[i]);
    end
    if self.schedules[3] then
        GlobalSchedule:Stop(self.schedules[3]);
    end
    self.schedules = {};
end

function ExpDungeonPanel:InitOneKeyGuwu()
    if DungeonModel:GetInstance().isOneKeyGuwuDiamond then
        if not DungeonModel:GetInstance().dungeonInfo or tonumber(DungeonModel:GetInstance().dungeonInfo.gold_inspire or 0) <= 0 then
            return ;
        end
        self.autoguwu = true;
        local diamond = RoleInfoModel:GetInstance():GetMainRoleData()[Constant.GoldType.Gold] or 0;
        local bdiamond = RoleInfoModel:GetInstance():GetMainRoleData()[Constant.GoldType.BGold] or 0;
        local totaldiamond = diamond + bdiamond;
        if totaldiamond < 10 then
            lua_panelMgr:GetPanelOrCreate(GuwuPanel):Open();
        else
            local index = 0;
            for i = 1, DungeonModel:GetInstance().dungeonInfo.gold_inspire do
                if totaldiamond >= 10 then
                    DungeonCtrl:GetInstance():RequestInspire(2);
                    totaldiamond = totaldiamond - 10;
                    index = index + 1;

                    self.guBtn.showBg = false;
                    self.guBtn:HideBgText();
                end
                --print2("自动鼓舞2");
            end
            if index < 5 then
                lua_panelMgr:GetPanelOrCreate(GuwuPanel):Open();
            end
        end
    end

    if DungeonModel:GetInstance().isOneKeyGuwuGold then
        if not DungeonModel:GetInstance().dungeonInfo or tonumber(DungeonModel:GetInstance().dungeonInfo.coin_inspire or 0) <= 0 then
            return ;
        end
        self.autoguwu = true;
        local coin = RoleInfoModel:GetInstance():GetMainRoleData()[Constant.GoldType.Coin] or 0;
        if coin < 100 then
            lua_panelMgr:GetPanelOrCreate(GuwuPanel):Open();
        else
            local index = 0;
            for i = 1, DungeonModel:GetInstance().dungeonInfo.coin_inspire do
                if coin >= 100 then
                    DungeonCtrl:GetInstance():RequestInspire(1);
                    coin = coin - 100;
                    index = index + 1;

                    self.guBtn.showBg = false;
                    self.guBtn:HideBgText();
                end

                --print2("自动鼓舞1");
            end
            if index < 5 then
                lua_panelMgr:GetPanelOrCreate(GuwuPanel):Open();
            end
        end
    end
end
function ExpDungeonPanel:HideGuwuBtn()
    if self.guBtn then
        self.guBtn.showBg = false;
        self.guBtn:HideBgText();
    end
end
local ConfigLanguage = require('game.config.language.CnLanguage')
--@ling,需要改成读object_info里面的p_creep的level
function ExpDungeonPanel:HandleNewCreate(monster)
    if monster and monster.object_type == enum.ACTOR_TYPE.ACTOR_TYPE_CREEP then
        if monster.object_info and monster.object_info.name then
            local level = RoleInfoModel:GetInstance():GetMainRoleLevel();
            monster.name_container:SetName(string.format(ConfigLanguage.Common.Level, level) .. " " .. monster.object_info.name);
        end
    end
end