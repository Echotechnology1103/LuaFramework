---魔法卡卡片图标
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by win 10.
--- DateTime: 18/12/04 16:18
---
CardIcon = CardIcon or class("CardIcon", BaseItem)
local this = CardIcon
--类似的卡片数据
--[20010] = {id = 20010, star = 0, max_star = 3, cost = [[]], slot = 2, attr_type = [[21]], base = [[{{21,10}}]], rare = [[]], gate = 1, score = 1000, gain = [[{90010012,100}]]},
--slot == 1普通属性,2是核心卡
--融合卡有2个基础属性,红色卡有极品属性
function CardIcon:ctor(parent_node, data, cardData)
    self.abName = "magiccard";
    self.image_ab = "magiccard_image";
    self.assetName = "CardIcon"
    self.layer = "UI"
    self.model = CardModel.GetInstance()
    self.schedules = {};
    self.events = {};
    self.data = data;
    self.cardData = cardData;
    self.cardData = nil;

    self.showcardname = true;
    self.showcardlevel = false;
    CardIcon.super.Load(self);
end

function CardIcon:dctor()
    GlobalEvent:RemoveTabListener(self.events);
    if self.schedule then
        GlobalSchedule:Stop(self.schedule);
    end
    self.cardData = nil;
    self.data = nil;
    self.model = nil;
    self.starItems = nil;
end

function CardIcon:LoadCallBack()
    self.nodes = {
        "icon", "cname", "bg", "cardlocktxt", "lockbg",

        "stars", "stars/star_1", "stars/star_4", "stars/star_5", "stars/star_6", "stars/star_2", "stars/star_3",

        "card_lv",
    }
    self:GetChildren(self.nodes);

    SetLocalPosition(self.transform, 0, 0, 0);
    --SetLocalScale(self.transform, 1, 1, 1);

    self:SetCardSacle(self.scale);

    self:InitUI();
    self:AddEvents();
end

function CardIcon:InitUI()
    self.starItems = {};
    for i = 1, 6, 1 do
        self.starItems[i] = GetImage(self["star_" .. i]);
        SetGameObjectActive(self.starItems[i], false);
    end

    self.cname = GetText(self.cname);
    self.icon = GetImage(self.icon);

    self.bg = GetImage(self.bg);

    self.card_lv = GetText(self.card_lv);

    self.cardlocktxt = GetText(self.cardlocktxt);
    SetGameObjectActive(self.cardlocktxt);
    SetGameObjectActive(self.lockbg);
    self:ShowStars(self.showstar);

    if self.data then
        self:InitData();
    end

    self:ShowCardName(self.showcardname);

    self:SetCardLv(self.cardLevel);

    self:ShowMaxStarImg(self.showmaxstarimg);

    if self.cardlocktext then
        self:SetCardLock(self.cardlocktext);
    end

    if self.showcardlevel ~= nil then
        self:ShowCardLV(self.showcardlevel);
    end
end

function CardIcon:InitData()
    if self.data.name then
        self.cname.text = self.data.name;
    end
    self:SetCardCoreType(self.data.slot == 2);

    self:SetMaxStar(self.data.max_star);
    self:SetStarNum(self.data.star);

    local itemConfig = Config.db_item[self.data.id];
    if itemConfig then
        self:SetBgColor(itemConfig);
    end

    self:SetIcon();
end

function CardIcon:UpdateData(data)
    self.data = data;
    if data and self.is_loaded then
        self:InitData();
    end
end

function CardIcon:SetIcon()
    if self.data then
        local itemConfig = Config.db_item[self.data.id];
        if itemConfig then
            local abName = GoodIconUtil:GetInstance():GetResNameByItemID(itemConfig.icon);--"iconasset/icon_magic_card"
            lua_resMgr:SetImageTexture(self, self.icon, abName, itemConfig.icon, false);
        end
    end
end

function CardIcon:SetBgColor(itemConfig)
    lua_resMgr:SetImageTexture(self, self.bg, "common_image", "com_icon_bg_" .. itemConfig.color, true);
    SetColor(self.cname, HtmlColorStringToColor("#" .. ColorUtil.GetColor2(itemConfig.color)));
end

function CardIcon:SetCardLv(num)
    if not num then
        return ;
    end
    self.cardLevel = tonumber(num);
    if self.cardLevel ~= 0 and self.showcardlevel ~= false then
        self:ShowCardLV(true);
    else
        self:ShowCardLV(false);
    end
    if self.card_lv then
        self.card_lv.text = "LV." .. tostring(num);
    end

end

function CardIcon:ShowCardName(bool)
    bool = toBool(bool);
    self.showcardname = bool;
    SetGameObjectActive(self.cname, bool);
end

function CardIcon:SetCardLock(level)
    if self.cardlocktxt then
        SetGameObjectActive(self.cardlocktxt, true);
        SetGameObjectActive(self.lockbg, true);
        self.cardlocktxt.text = tonumber(level) .. "Unlock at Stage X";
    else
        self.cardlocktext = level;
    end
end

function CardIcon:ShowCardLV(bool)
    bool = toBool(bool);
    self.showcardlevel = bool;
    SetGameObjectActive(self.card_lv, bool);
end


--@ling autofun
function CardIcon:SetCardCoreType(bool)
    bool = toBool(bool);
    SetGameObjectActive(self.ball, bool);
    SetGameObjectActive(self.ball2, not bool);
end

function CardIcon:AddEvents()

end

function CardIcon:SetStarNum(num)
    for i = 1, num, 1 do
        SetGameObjectActive(self.starItems[i], true);
        SetAlpha(self.starItems[i], 1);
    end
end

function CardIcon:ShowStars(bool)
    bool = toBool(bool);
    self.showstar = bool;
    if self.starItems then
        for i = 1, 6, 1 do
            SetGameObjectActive(self.starItems[i], bool);
        end
    end
end

function CardIcon:SetCardSacle(num)
    num = num or 1;
    if self.transform then
        SetLocalScale(self.transform, num, num, num);
    else
        self.scale = num;
    end
end

function CardIcon:SetMaxStar(num)
    for i = 1, 6, 1 do
        if i <= num then
            SetGameObjectActive(self.starItems[i], true);
            SetAlpha(self.starItems[i], 0.3);
        else
            SetGameObjectActive(self.starItems[i], false);
        end
    end
end

--比上面的优先级高
function CardIcon:ShowMaxStarImg(bool)
    bool = toBool(bool);
    self.showmaxstarimg = bool;
    if self.max_star_img then
        SetGameObjectActive(self.max_star_img, bool);
    end
end


