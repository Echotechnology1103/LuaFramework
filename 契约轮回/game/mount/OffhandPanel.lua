---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by win 10.
--- DateTime: 2018/9/20 11:18
---

OffhandPanel = OffhandPanel or class("OffhandPanel", BaseItem)
local this = OffhandPanel

OffhandPanel.navTab = 1;
OffhandPanel.TRAIN_ID = 55000;
OffhandPanel.TRAIN_ID_1 = 55001;
OffhandPanel.TRAIN_ID_2 = 55002;

function OffhandPanel:ctor(parent_node, layer, defaultSelectedID)
    self.abName = "mount"
    self.assetName = "OffhandPanel"
    self.layer = layer
    self.events = {};
    self.model = MountModel:GetInstance();
    self.mountTogItems = {};
    self.schedules = {};
    self.height = 0
    self.defaultSelectedID = defaultSelectedID;
    if self.defaultSelectedID then
        OffhandPanel.navTab = 2;
    end
    self.model_event_list = {}
    self.toggle_red_dot = {}

    OffhandPanel.super.Load(self);
end

function OffhandPanel:OnEnable()
    --print2("OffhandPanel:OnEnable");
    self:HandleTogBtnClick(nil,nil,nil,1);
    self:InitMaterial();
    self:InitDan();
    self:HandleOffhandPropChange(enum.TRAIN.TRAIN_OFFHAND);
end

function OffhandPanel:dctor()
    GlobalEvent:RemoveTabListener(self.events);

    for k, v in pairs(self.mountTogItems) do
        v:destroy();
    end
    self.mountTogItems = nil;
    self:StopAllSchedules()
    OffhandPanel.navTab = 1;

    if self.mountModel then
        self.mountModel:destroy();
    end
    destroyTab(self.danItems);
    self.danItems = nil;

    if self.piaoZiSchedule then
        GlobalSchedule:Stop(self.piaoZiSchedule);
    end

    self.model:RemoveTabListener(self.model_event_list);

    for k, v in pairs(self.toggle_red_dot) do
        v:destroy()
    end
    self.toggle_red_dot = {}

    if self.autoBtn_reddot then
        self.autoBtn_reddot:destroy()
        self.autoBtn_reddot = nil
    end

    if self.jihuoBtn_reddot then
        self.jihuoBtn_reddot:destroy()
        self.jihuoBtn_reddot = nil
    end
    if self.upStarBtn_reddot then
        self.upStarBtn_reddot:destroy()
        self.upStarBtn_reddot = nil
    end
    if self.staritem then
        self.staritem:destroy();
    end
    self.staritem = nil;
    self:ClearItemList();
end
function OffhandPanel:ClearItemList()
    if not self.itemList then
        return ;
    end
    destroyTab(self.itemList);
    self.itemList = nil;
end

function OffhandPanel:LoadCallBack()
    self.nodes = {
        "mountTogItem_0", "PropItems", "ScrollView/Viewport/Content", "zhanliItems", "mount_ride_btn",
        "buyBtn", "mountView", "itemContainer", "jie", "dan_container", "starContainer", "upStarBtn", "upStarBtn/upStar_label", "mountDes",
        "exp/exp_bar", "exp/progressText", "bg/skillBtn", "mountName", "autoBtn/autoText", "autoBtn", "expCon/TextObj", "expCon",
        "jihuoBtn", "jihuoBtn/jihuo_label", "mount_vision_btn", "togbtns/tog_text_1", "togbtns/tog_text_2", "togbtns/tog_btn", "togbtns",
        --"starContainer/star_8", "starContainer/star_2", "starContainer/star_3", "starContainer/star_6",
        --"starContainer/star_9", "starContainer/star_4", "starContainer/star_7", "starContainer/star_1", "starContainer/star_5", "starContainer/star_10",
        "prop_bg/mount_bg",
    }
    self:GetChildren(self.nodes);

    self.toggle_red_dot[1] = RedDot(self.togbtns, nil, RedDot.RedDotType.Nor)
    self.toggle_red_dot[1]:SetPosition(-12, 10)

    self.toggle_red_dot[2] = RedDot(self.togbtns, nil, RedDot.RedDotType.Nor)
    self.toggle_red_dot[2]:SetPosition(66, 10)

    self.autoBtn_reddot = RedDot(self.autoBtn, nil, RedDot.RedDotType.Nor)
    self.autoBtn_reddot:SetPosition(55, 12)

    self.jihuoBtn_reddot = RedDot(self.jihuoBtn, nil, RedDot.RedDotType.Nor)
    self.jihuoBtn_reddot:SetPosition(55, 12)

    self.upStarBtn_reddot = RedDot(self.upStarBtn, nil, RedDot.RedDotType.Nor)
    self.upStarBtn_reddot:SetPosition(55, 12)

    MountCtrl:GetInstance():RequestMorphList(enum.TRAIN.TRAIN_OFFHAND);

    self:InitUI();
    self:AddEvent();

    local res = "mount_bg";
    lua_resMgr:SetImageTexture(self, self.mount_bg, "iconasset/icon_big_bg_" .. res, res, false);
end

function OffhandPanel:SetReddot()
    for k, redot in pairs(self.toggle_red_dot) do
        local bo = self.model:GetReddotState(enum.TRAIN.TRAIN_OFFHAND, k)
        redot:SetRedDotParam(bo)
    end
    local auto_bo = false
    if OffhandPanel.navTab == 1 then

        for k, item in pairs(self.mountTogItems) do
            local bo = self.model:GetReddotState(enum.TRAIN.TRAIN_OFFHAND, OffhandPanel.navTab, item.param)
            item:SetRedDotParam(bo)
            if not auto_bo then
                auto_bo = bo
            end
        end
        self.autoBtn_reddot:SetRedDotParam(auto_bo)
        self.jihuoBtn_reddot:SetRedDotParam(false)
        self.upStarBtn_reddot:SetRedDotParam(false)
    else
        for k, item in pairs(self.mountTogItems) do
            local bo = self.model:GetReddotState(enum.TRAIN.TRAIN_OFFHAND, OffhandPanel.navTab, item.param)
            item:SetRedDotParam(bo)
        end
        self.autoBtn_reddot:SetRedDotParam(false)
        if self.currentSelectedTogItem then
            local cur_mount_id = self.currentSelectedTogItem.param
            local bo = self.model:GetReddotState(enum.TRAIN.TRAIN_OFFHAND, OffhandPanel.navTab, cur_mount_id)
            if not self.model:CheckIsActiveByType(enum.TRAIN.TRAIN_OFFHAND, cur_mount_id) then
                self.jihuoBtn_reddot:SetRedDotParam(bo)
                self.upStarBtn_reddot:SetRedDotParam(false)
            else
                self.jihuoBtn_reddot:SetRedDotParam(false)
                self.upStarBtn_reddot:SetRedDotParam(toBool(bo))
            end
        end
    end
end

function OffhandPanel:InitUI()
    self.textList = {};

    self.mount_bg = GetImage(self.mount_bg);
    self.mount_vision_btn = GetButton(self.mount_vision_btn);
    SetGameObjectActive(self.mount_vision_btn, false);
    self.mount_ride_btn = GetButton(self.mount_ride_btn);
    self.buyBtn = GetButton(self.buyBtn);
    self.upStarBtn = GetButton(self.upStarBtn);
    self.mountDes = GetText(self.mountDes);
    self.jihuoBtn = GetButton(self.jihuoBtn);
    self.exp_bar = GetImage(self.exp_bar);
    self.progressText = GetText(self.progressText);
    self.autoBtn = GetButton(self.autoBtn);
    self.autoText = GetText(self.autoText);
    self.upStar_label = GetText(self.upStar_label);
    SetGameObjectActive(self.upStarBtn.gameObject, false);

    SetGameObjectActive(self.jihuoBtn.gameObject, false);

    self.jie = GetText(self.jie);--当前副手阶数 : 3阶2星

    self.exp_bar.fillAmount = 0;
    self.progressText.text = "";
    self.jie.text = "Current off-hand tier: T0S0";

    self.TextObj.gameObject:SetActive(false);

    self.skillBtn = GetImage(self.skillBtn);
    self.mountName = GetText(self.mountName);

    self.PropItems = PropItems(self.PropItems);
    SetLocalPosition(self.PropItems.transform, -14, 0, 0)
    self.PropItems:HideBgs(3);
    self.PropItems:HideLines(5);

    self.staritem = MountStarsItem(self.starContainer);
    self.staritem:ShowStars(10, false);
    self.staritem:OpenStars(0);
    self.zhanliItems = ZhanLiItems(self.zhanliItems, false);
    self.zhanliItems:UpdateZhanli(0, 0);

    self.tog_btn = GetImage(self.tog_btn);
    self.tog_text_1 = GetText(self.tog_text_1);
    self.tog_text_2 = GetText(self.tog_text_2);

    SetColor(self.tog_text_1, 0x99, 0x48, 0x29, 255);
    SetColor(self.tog_text_2, 0xEB, 0xD3, 0x9A, 255);

    self:InitTogType();
    self:HandleTogBtnClick(nil, nil, nil, OffhandPanel.navTab);
    --self:InitTog();
    self:InitMaterial();
    self:InitDan();
    self:HandleOffhandPropChange(enum.TRAIN.TRAIN_OFFHAND);
end

function OffhandPanel:InitModel()
    if not self.currentSelectedOffhandID then
        return ;
    end
    local offhandID = self.currentSelectedOffhandID;
    local offhand_level = 0;
    local configTab = nil;

    if offhandID < MountModel:GetInstance().offhand_layer then
        offhand_level = 9;
    elseif offhandID == MountModel:GetInstance().offhand_layer then
        offhand_level = MountModel:GetInstance().offhand_level;
    end
    configTab = Config.db_offhand[offhandID .. "@" .. offhand_level];
    self.mountName.text = string.format(ConfigLanguage.Mount.ShowPanelName, configTab.name, configTab.order)

    self.ratio = configTab.ratio;

    if self.mountModel then
        self.mountModel:destroy();
    end

    local config = {};
    config.rotate = { x = 0, y = 0, z = 0 };
    config.offset = { x = 3980, y = 100, z = -250 };
    config.scale = { x = self.ratio, y = self.ratio, z = self.ratio };
    config.trans_x = 500
    config.trans_y = 500
    self.mountModel = UIMountCamera(self.mountView.transform, nil, "model_hand_" .. configTab.res, enum.ITEM_STYPE.ITEM_STYPE_OFFHAND_MORPH);
    self.mountModel:SetConfig(config)
    --self.mountModel = UIMountModel(self.mountView.transform, "model_hand_" .. configTab.res, handler(self, self.LoadModelCallBack));

end

function OffhandPanel:InitMorphModel()
    if not self.currentSelectedOffhandID then
        return ;
    end
    local offhandID = self.currentSelectedOffhandID;
    local level = 0;
    local configTab = nil;
    if self.model.db_offhand_morph[offhandID] then
        configTab = self.model.db_offhand_morph[offhandID];
        --self.mountName.text = configTab.name;
        local morph = MountModel.GetInstance():GetOffHandMorphData(configTab.id);
        if morph then
            self.mountName.text = string.format(ConfigLanguage.Mount.ShowPanelName, configTab.name or "", morph.star or 0)
        else
            self.mountName.text = string.format(ConfigLanguage.Mount.ShowPanelName, configTab.name or "", 0)
        end
        self.jie.text = "";

        SetVisible(self.mountskill_tips, false)

        if self.mountModel then
            self.mountModel:destroy();
        end
        self.ratio = configTab.ratio;
        --self.mountModel = UIMountModel(self.mountView.transform, "model_hand_" .. configTab.res, handler(self, self.LoadModelCallBack));
        local config = {};
        config.rotate = { x = 0, y = 0, z = 0 };
        config.offset = { x = 3980, y = 90, z = -250 };
        config.far = 20;
        config.scale = { x = self.ratio, y = self.ratio, z = self.ratio };
        config.trans_x = 500
        config.trans_y = 500
        self.mountModel = UIMountCamera(self.mountView.transform, nil, "model_hand_" .. configTab.res, enum.ITEM_STYPE.ITEM_STYPE_OFFHAND_MORPH);
        self.mountModel:SetConfig(config)
    end
end

function OffhandPanel:LoadModelCallBack()
    local ratio = self.ratio or 100;
    SetLocalPosition(self.mountModel.transform, -2143, 45, 950);
    local v3 = self.mountModel.transform.localScale;
    SetLocalScale(self.mountModel.transform, 150 * (ratio / 100), 150 * (ratio / 100), 150 * (ratio / 100));
    SetLocalRotation(self.mountModel.transform, 0, 0, 0);
    self.mountModel:SetCameraLayer();
    self.mountModel:AddAnimation({ "show", "idle" }, false, "idle", 0)--,"casual"
    self.mountModel.animator:CrossFade("idle", 0)
end
local lastX = 0;
function OffhandPanel:AddEvent()

    local call_back1 = function(target, x, y)
        if self.currentSelectedOffhandID then
            if OffhandPanel.navTab == 1 then
                MountCtrl:GetInstance():RequestFigure(self.currentSelectedOffhandID, enum.TRAIN.TRAIN_OFFHAND);
            else
                local configTab = self.model.db_offhand_morph[self.currentSelectedOffhandID];
                if configTab then
                    MountCtrl:GetInstance():RequestMorph(enum.TRAIN.TRAIN_OFFHAND, configTab.id);
                else
                    Notify.ShowText("Unable to find the off-hand ID")
                end
            end
        end
    end
    AddClickEvent(self.mount_ride_btn.gameObject, call_back1);

    local prop_call_back = function(type)
        if type == enum.TRAIN.TRAIN_OFFHAND and OffhandPanel.navTab == 1 then
            local mountTogItem;
            for i = 1, #self.mountTogItems, 1 do
                mountTogItem = self.mountTogItems[i];

                if i <= MountModel:GetInstance().offhand_layer then
                    mountTogItem:SetIsLock(false);
                else
                    mountTogItem:SetIsLock(true);
                end
            end
            mountTogItem = self.mountTogItems[MountModel:GetInstance().offhand_layer];
            self.mountTogItems[MountModel:GetInstance().offhand_layer]:SetIsSelected(true);
            self:HandleTogClick(mountTogItem.gameObject, 0, 0, mountTogItem);
        end
    end
    self.events[#self.events + 1] = GlobalEvent:AddListener(MountEvent.MOUNT_PROP_CHANGE, prop_call_back);

    --收到服务端副手激活列表
    self.events[#self.events + 1] = GlobalEvent.AddEventListener(MountEvent.MORPH_ACTIVE_LIST, handler(self, self.HandleMountActiveList));

    --激活的事件
    self.events[#self.events + 1] = GlobalEvent.AddEventListener(MountEvent.MORPH_ACTIVE_DATA, handler(self, self.HandleMorphActive));

    local function call_back(type)
        if type == enum.TRAIN.TRAIN_OFFHAND then
            if OffhandPanel.navTab == 1 then
                for i = 1, #self.mountTogItems do
                    local mountTogItem = self.mountTogItems[i]
                    mountTogItem:SetRiding(MountModel:GetInstance():IsOffhand(i))
                end
                SetGameObjectActive(self.mount_ride_btn.gameObject, not self.model:IsOffhand(self.currentSelectedOffhandID));
            else
                local config = nil;
                for i = 1, #self.mountTogItems do
                    local mountTogItem = self.mountTogItems[i]
                    config = self.model.db_offhand_morph[i];
                    mountTogItem:SetRiding(MountModel:GetInstance():IsMorphOffhand(config and config.id or self.currentSelectedOffhandID))
                end
                config = self.model.db_offhand_morph[self.currentSelectedOffhandID];
                SetGameObjectActive(self.mount_ride_btn.gameObject, not MountModel:GetInstance():IsMorphOffhand(config and config.id or self.currentSelectedOffhandID));
            end
        end
    end
    self.events[#self.events + 1] = GlobalEvent:AddListener(MountEvent.MOUNT_CHANGE_FIGURE, call_back)

    local handleBuyClick = function(target, x, y)
        --副手进阶丹
        UnpackLinkConfig("180@1@2@2@2209")
    end
    AddClickEvent(self.buyBtn.gameObject, handleBuyClick);

    local auto_50000 = function()
        if BagModel:GetInstance():GetItemNumByItemID(OffhandPanel.TRAIN_ID) ~= 0 then
            MountCtrl:GetInstance():RequestMountUpgrade(OffhandPanel.TRAIN_ID, enum.TRAIN.TRAIN_OFFHAND);
        else
            GlobalSchedule:Stop(self.schedules[1]);
            self.schedules[1] = nil;
            self.autoText.text = "Auto star-up";

            self:CheckQuickBuy(false, OffhandPanel.TRAIN_ID)
        end
    end

    local auto_50001 = function()
        if BagModel:GetInstance():GetItemNumByItemID(OffhandPanel.TRAIN_ID_1) ~= 0 then
            MountCtrl:GetInstance():RequestMountUpgrade(OffhandPanel.TRAIN_ID_1, enum.TRAIN.TRAIN_OFFHAND);
        else
            GlobalSchedule:Stop(self.schedules[2]);
            self.schedules[2] = nil;
            self.autoText.text = "Auto star-up";

            self:CheckQuickBuy(false, OffhandPanel.TRAIN_ID_1)
        end
    end

    local handleAutoClick = function(target, x, y)
        if self.schedules[1] or self.schedules[2] then
            self:StopAllSchedule();
            self.autoText.text = "Auto star-up";
            return ;
        end
        local layer = self.model.offhand_layer
        local level = self.model.offhand_level;
        if level == MountModel.OFFHAND_MAX_LEVEL then
            local key = (layer + 1) .. "@" .. 0;
            if not Config.db_offhand[key] then
                Notify.ShowText("Max Tier reached");
                return ;
            end
        end

        local id

        if self.itemList[1]:GetIsSelected() then

            id = OffhandPanel.TRAIN_ID

            if BagModel:GetInstance():GetItemNumByItemID(OffhandPanel.TRAIN_ID) ~= 0 then
                --MountCtrl:GetInstance():RequestMountUpgrade(OffhandPanel.TRAIN_ID,enum.TRAIN.TRAIN_OFFHAND);
                self.schedules[1] = GlobalSchedule:Start(auto_50000, 0.1, -1);
                self.autoText.text = "Stop";
            elseif BagModel:GetInstance():GetItemNumByItemID(OffhandPanel.TRAIN_ID_1) ~= 0 then
                
                --这个为0，另一个不为0才提示
                Notify.ShowText("This item doesn't exist, please tap to buy");
            end
        elseif self.itemList[2]:GetIsSelected() then

            id = OffhandPanel.TRAIN_ID_1

            if BagModel:GetInstance():GetItemNumByItemID(OffhandPanel.TRAIN_ID_1) ~= 0 then
                --MountCtrl:GetInstance():RequestMountUpgrade(OffhandPanel.TRAIN_ID_1,enum.TRAIN.TRAIN_OFFHAND);
                self.schedules[2] = GlobalSchedule:Start(auto_50001, 0.1, -1);
                self.autoText.text = "Stop";

            elseif BagModel:GetInstance():GetItemNumByItemID(OffhandPanel.TRAIN_ID) ~= 0 then
                
                --这个为0，另一个不为0才提示
                Notify.ShowText("This item doesn't exist, please tap to buy");
            end
        end

        self:CheckQuickBuy(false, id)

    end
    AddClickEvent(self.autoBtn.gameObject, handleAutoClick);

    self.events[#self.events + 1] = GlobalEvent:AddListener(MountEvent.MOUNT_PROP_CHANGE, handler(self, self.HandleOffhandPropChange));
    self.events[#self.events + 1] = GlobalEvent:AddListener(MountEvent.MOUNT_USE_DAN, handler(self, self.HandleOffhandPropChange));
    self.events[#self.events + 1] = GlobalEvent:AddListener(MountEvent.MOUNT_STOP_AUTO, handler(self, self.StopAllSchedule));
    self.events[#self.events + 1] = GlobalEvent.AddEventListener(MountEvent.MORPH_UPSTAR_DATA, handler(self, self.HandleUpstar));

    local addText = function(text)
        self:ShowAddExp(text);
    end
    self.events[#self.events + 1] = GlobalEvent:AddListener(MountEvent.MOUNT_ADD_EXP, addText);

    --注释这个消息,现在不发了
    self.events[#self.events + 1] = GlobalEvent.AddEventListener(MountEvent.MOUNT_OR_VISION, handler(self, self.MountOrVision))

    local jihuo_callBack = function()
        local config = self.model.db_offhand_morph[self.currentSelectedOffhandID];
        if config then
            MountCtrl:GetInstance():RequestMorphActive(enum.TRAIN.TRAIN_OFFHAND, config.id);
        else
            Notify.ShowText("Unable to find the off-hand item")
        end
    end
    AddClickEvent(self.jihuoBtn.gameObject, jihuo_callBack);

    local upStar_50000 = function()
        local mountID = 0;
        local config = self.model.db_offhand_morph[self.currentSelectedOffhandID];
        if config then
            if MountModel.GetInstance():CheckOffhandIsActive(config.id) then
                mountID = config.id;
            else
                GlobalSchedule:Stop(self.schedules[3]);
                self.schedules[3] = nil;
                Notify.ShowText("The off-hand item isn't activated yet");
                return ;
            end
        else
            GlobalSchedule:Stop(self.schedules[3]);
            self.schedules[3] = nil;
            Notify.ShowText("Unable to find the off-hand item configuration")
            return ;
        end

        if BagModel:GetInstance():GetItemNumByItemID(OffhandPanel.TRAIN_ID) ~= 0 then
            MountCtrl:GetInstance():RequestUpStar(enum.TRAIN.TRAIN_OFFHAND, mountID, OffhandPanel.TRAIN_ID);--MountCtrl:GetInstance():RequestMountUpgrade(OffhandPanel.TRAIN_ID_1);
        else
            GlobalSchedule:Stop(self.schedules[3]);
            self.schedules[3] = nil;
            self.upStar_label.text = "Auto star-up";
            self:CheckUpStarLabel();

            self:CheckQuickBuy(true, OffhandPanel.TRAIN_ID)
        end
    end

    local upStar_50001 = function()
        local mountID = 0;
        local config = self.model.db_offhand_morph[self.currentSelectedOffhandID];
        if config then
            if MountModel.GetInstance():CheckOffhandIsActive(config.id) then
                mountID = config.id;
            else
                GlobalSchedule:Stop(self.schedules[4]);
                self.schedules[4] = nil;
                Notify.ShowText("The off-hand item isn't activated yet");
                return ;
            end
        else
            GlobalSchedule:Stop(self.schedules[4]);
            self.schedules[4] = nil;
            Notify.ShowText("Unable to find the off-hand item configuration")
            return ;
        end

        if BagModel:GetInstance():GetItemNumByItemID(OffhandPanel.TRAIN_ID_1) ~= 0 then
            MountCtrl:GetInstance():RequestUpStar(enum.TRAIN.TRAIN_OFFHAND, mountID, OffhandPanel.TRAIN_ID_1);--MountCtrl:GetInstance():RequestMountUpgrade(50001);
        else
            GlobalSchedule:Stop(self.schedules[4]);
            self.schedules[4] = nil;
            self.upStar_label.text = "Auto star-up";
            self:CheckUpStarLabel();

            self:CheckQuickBuy(true, OffhandPanel.TRAIN_ID_1)
        end
    end

    local upStar_call_back = function(target, x, y)
        if self.schedules[3] or self.schedules[4] then
            self:StopAllSchedule();
            return ;
        end

        if self.upStar_label.text == "Max Stars" then
            Notify.ShowText("Max Stars");
            return ;
        end

        local id
        if self.itemList[1]:GetIsSelected() then

            id = OffhandPanel.TRAIN_ID

            if BagModel:GetInstance():GetItemNumByItemID(OffhandPanel.TRAIN_ID) ~= 0 then
                --MountCtrl:GetInstance():RequestMountUpgrade(OffhandPanel.TRAIN_ID,enum.TRAIN.TRAIN_OFFHAND);
                self.schedules[3] = GlobalSchedule:Start(upStar_50000, 0.1, -1);
                self.upStar_label.text = "Stop";

            elseif BagModel:GetInstance():GetItemNumByItemID(OffhandPanel.TRAIN_ID_1) ~= 0 then
                
                --这个为0，另一个不为0才提示
                Notify.ShowText("This item doesn't exist, please tap to buy");
            end
        elseif self.itemList[2]:GetIsSelected() then

            id = OffhandPanel.TRAIN_ID_1

            if BagModel:GetInstance():GetItemNumByItemID(OffhandPanel.TRAIN_ID_1) ~= 0 then
                --MountCtrl:GetInstance():RequestMountUpgrade(OffhandPanel.TRAIN_ID_1 , enum.TRAIN.TRAIN_OFFHAND);
                self.schedules[4] = GlobalSchedule:Start(upStar_50001, 0.1, -1);
                self.upStar_label.text = "Stop";
            elseif BagModel:GetInstance():GetItemNumByItemID(OffhandPanel.TRAIN_ID) ~= 0 then
                
                --这个为0，另一个不为0才提示
                Notify.ShowText("This item doesn't exist, please tap to buy");
            end
        end


        self:CheckQuickBuy(true, id)
    end
    --AddClickEvent(self.autoBtn.gameObject, handleAutoClick);
    AddClickEvent(self.upStarBtn.gameObject, upStar_call_back);

    local updateNumCallBack = function()
        for k, v in pairs(self.itemList) do
            local awardItem = v;
            local num = BagModel:GetInstance():GetItemNumByItemID(v.db_id);
            awardItem:UpdateNum0(num);
        end
    end
    AddEventListenerInTab(BagEvent.UpdateGoods, updateNumCallBack, self.events);

    AddClickEvent(self.mount_vision_btn.gameObject, handler(self, self.HandleVisionBtn));

    local function call_back()
        self:SetReddot()
    end
    self.model_event_list[#self.model_event_list + 1] = self.model:AddListener(MountEvent.UpdateRedDot, call_back)
end

function OffhandPanel:StopAllSchedules()
    if self.schedules[1] then
        GlobalSchedule:Stop(self.schedules[1]);
    end
    if self.schedules[2] then
        GlobalSchedule:Stop(self.schedules[2]);
    end
    self.schedules = {};
end

function OffhandPanel:ClearTog()
    destroyTab(self.mountTogItems);
    self.mountTogItems = {};
end

function OffhandPanel:InitTogType()
    AddClickEvent(self.tog_text_1.gameObject, handler(self, self.HandleTogBtnClick, 1));
    AddClickEvent(self.tog_text_2.gameObject, handler(self, self.HandleTogBtnClick, 2));
end
OffhandPanel.TogImgPos = {
    [1] = -43,
    [2] = 34,
}

function OffhandPanel:HandleTogBtnClick(go, x, y, index)
    cc.ActionManager:GetInstance():removeAllActionsFromTarget(self.tog_btn.transform)
    local value_action = cc.MoveTo(0.1, OffhandPanel.TogImgPos[index], GetLocalPositionY(self.tog_btn.transform), GetLocalPositionZ(self.tog_btn.transform))
    cc.ActionManager:GetInstance():addAction(value_action, self.tog_btn.transform)
    self.currentSelectedOffhandID = 1;
    if 1 == index then
        SetColor(self.tog_text_1, 0x99, 0x48, 0x29, 255);
        SetColor(self.tog_text_2, 0xEB, 0xD3, 0x9A, 255);
        self:HandleOffhandPropChange(enum.TRAIN.TRAIN_OFFHAND);
    else
        SetColor(self.tog_text_1, 0xEB, 0xD3, 0x9A, 255);--EBD39A
        SetColor(self.tog_text_2, 0x99, 0x48, 0x29, 255);
        self:UpdateVisionProp();
    end
    OffhandPanel.navTab = index;
    --初始化
    self:InitTog();
end

function OffhandPanel:InitTog()
    self:ClearTog();
    self.mountTogItem_0.gameObject:SetActive(true);
    local mountTogItem;
    --local model = MountModel:GetInstance();
    self.height = 0
    if OffhandPanel.navTab == 1 then
        for i = 1, #MountModel:GetInstance().allOffHand, 1 do
            mountTogItem = MountTogItem(newObject(self.mountTogItem_0.gameObject), i);
            mountTogItem.gameObject.name = "mountTogItem_" .. i;
            mountTogItem.transform:SetParent(self.Content.transform)
            if i == 1 then
                mountTogItem:SetIsOn(true);
            else
                mountTogItem:SetIsOn(false);
            end
            mountTogItem:SetName(Config.db_offhand[i .. "@0"].name);
            mountTogItem:SetHead(Config.db_offhand[i .. "@0"].res, "iconasset/icon_offhand")
            mountTogItem:SetJie(i);
            mountTogItem:SetParam(i)
            if i <= MountModel:GetInstance().offhand_layer then
                mountTogItem:SetIsLock(false);
            else
                mountTogItem:SetIsLock(true);
            end
            mountTogItem:SetRiding(MountModel:GetInstance():IsOffhand(i))
            self.mountTogItems[i] = mountTogItem;
            self.height = self.height + mountTogItem:GetHeight()
            SetLocalScale(mountTogItem.transform, 1, 1, 1);
            SetLocalPosition(mountTogItem.transform, 0, 0, 0);
            AddClickEvent(mountTogItem.gameObject, handler(self, self.HandleTogClick, mountTogItem));
        end
        if self.mountTogItems[MountModel:GetInstance().offhand_layer] then
            mountTogItem = self.mountTogItems[MountModel:GetInstance().offhand_layer];
            self.mountTogItems[MountModel:GetInstance().offhand_layer]:SetIsSelected(true);
            self:HandleTogClick(mountTogItem.gameObject, 0, 0, mountTogItem);
        else
            mountTogItem = self.mountTogItems[1];
            self:HandleTogClick(mountTogItem.gameObject, 0, 0, mountTogItem);
        end
    else
        local sortFun = function(a1, a2)
            local offhand_id1 = a1.id
            local offhand_id2 = a2.id
            local isActive1 = self.model:CheckOffhandIsActive(offhand_id1);
            local isActive2 = self.model:CheckOffhandIsActive(offhand_id2);
            if isActive2 == isActive1 then
                return offhand_id1 < offhand_id2;
            elseif isActive2 ~= isActive1 then
                return isActive1
            else
                return offhand_id1 < offhand_id2;
            end
        end
        table.sort(self.model.db_offhand_morph , sortFun)
        for i = 1, #self.model.db_offhand_morph, 1 do
            local mount_id = self.model.db_offhand_morph[i].id
            mountTogItem = MountTogItem(newObject(self.mountTogItem_0.gameObject), i);
            mountTogItem.gameObject.name = "mountTogItem_" .. i;
            mountTogItem.transform:SetParent(self.Content.transform);
            mountTogItem:SetIsOn(false);
            mountTogItem:SetName(self.model.db_offhand_morph[i].name);
            mountTogItem:SetHead(self.model.db_offhand_morph[i].res, "iconasset/icon_offhand");

            self.mountTogItems[i] = mountTogItem;

            --改成遍历激活列表吧?
            --self.mountTogItems[1]:SetIsSelected(false);
            mountTogItem:SetParam(mount_id)
            if MountModel:GetInstance():CheckOffhandIsActive(mount_id) then
                mountTogItem:SetIsLock(false);
                mountTogItem:SetIsSelected(true);
                --scrollToIndex = i;
            else
                mountTogItem:SetIsLock(true);
            end

            local morph = self.model:GetOffHandMorphData(mount_id);
            if morph then
                mountTogItem:SetJie(morph.star);
            end

            mountTogItem:SetRiding(MountModel:GetInstance():IsMorphOffhand(self.model.db_offhand_morph[i].id))
            SetLocalScale(mountTogItem.transform, 1, 1, 1);
            SetLocalPosition(mountTogItem.transform, 0, 0, 0);

            AddClickEvent(mountTogItem.gameObject, handler(self, self.HandleTogClick, mountTogItem));
        end
        local flag = false;
        if self.defaultSelectedID then
            for i = #self.model.db_offhand_morph, 1, -1 do
                local mount_id = self.model.db_offhand_morph[i].id
                if self.defaultSelectedID == mount_id then
                    flag = true;
                    self:HandleTogClick(self.mountTogItems[i].gameObject, 0, 0, self.mountTogItems[i]);
                    break ;
                end
            end
        else
            for i = #self.model.db_offhand_morph, 1, -1 do
                local mount_id = self.model.db_offhand_morph[i].id
                if MountModel:GetInstance():CheckOffhandIsActive(mount_id) then
                    flag = true;
                    self:HandleTogClick(self.mountTogItems[i].gameObject, 0, 0, self.mountTogItems[i]);
                    break ;
                end
            end
        end

        if not flag then
            self:HandleTogClick(self.mountTogItems[1].gameObject, 0, 0, self.mountTogItems[1]);
        end
    end

    self:ReLayout()

    self.mountTogItem_0.gameObject:SetActive(false);
end

function OffhandPanel:MountOrVision()
    --self:InitTog();
end

function OffhandPanel:HandleMountActiveList(data)
    if data.type == enum.TRAIN.TRAIN_OFFHAND then
        local tab = data.morphs;
        MountModel:GetInstance().morphOffHandData = tab;

        if OffhandPanel.navTab == 2 then
            for k, v in pairs(self.mountTogItems) do
                --如果ID一样就直接setlock false

            end

            for k, v in pairs(tab) do
                local item = self:GetMountItemByVisionID(v.id);
                if item then
                    item:SetIsLock(false);
                end
            end

        end

    end
end
--id = 1234之类
function OffhandPanel:GetMountItem(mountid)
    if OffhandPanel.navTab == 2 then
        if self.mountTogItems[mountid] then
            return self.mountTogItems[mountid]
        end
    end
    return nil;
end
--获取副手togitem,id是self.model.db_offhand_morph里面的ID
function OffhandPanel:GetMountItemByVisionID(id)
    for k, v in pairs(self.mountTogItems) do
        local config = self.model.db_offhand_morph[v.mountID];
        if config and config.id == id then
            return v;
        end
    end
    return nil;
end

function OffhandPanel:HandleMorphActive(data)
    if data.type == enum.TRAIN.TRAIN_OFFHAND then
        local item = self:GetMountItemByVisionID(data.id);
        if item then
            item:SetIsLock(false);
            local morph = MountModel.GetInstance():GetOffHandMorphData(data.id)
            item:SetJie(morph.star);
            --self:RefreshData(item);
        end

        local config = self.model.db_offhand_morph[self.currentSelectedOffhandID];
        if config and config.id == data.id then
            self:UpdateVisionProp();

            self.jihuoBtn.gameObject:SetActive(false);
            self.upStarBtn.gameObject:SetActive(true);
            self.buyBtn.gameObject:SetActive(true);
            self:CheckUpStarLabel();
            local morph = MountModel.GetInstance():GetOffHandMorphData(data.id)
            self:RefreshStarAndExp(morph);
        end
    end
    self:InitMaterial();

end

function OffhandPanel:ReLayout()
    self.Content.sizeDelta = Vector2(self.Content.sizeDelta.x, #self.mountTogItems * 99)
end

function OffhandPanel:RefreshMountDesc()
    if not self.currentSelectedOffhandID then
        return ;
    end
    --最后才读配能配置
    if OffhandPanel.navTab == 1 then
        local configTab = Config.db_offhand[self.currentSelectedOffhandID .. "@" .. 0];
        if configTab then
            local skill = configTab.skill;
            local skillDes = Config.db_skill[tonumber(skill)];
            if skillDes then
                self.mountDes.text = skillDes.desc;
                --self.mountskill.text = skillDes.name
            else
                self.mountDes.text = "HP +400"
            end
            lua_resMgr:SetImageTexture(self, self.skillBtn, "iconasset/icon_skill", skillDes.icon, true);
        end
    else
        local configTab = self.model.db_offhand_morph[self.currentSelectedOffhandID];
        if configTab then
            local morph = MountModel:GetInstance():GetOffHandMorphData(configTab.id);
            --if morph then
            local skillTab = MountModel:GetInstance().morph_offhand_skill[configTab.id];
            if skillTab then
                local skill = skillTab["skill"];
                local skillDes = Config.db_skill[tonumber(skill)];
                if skillDes then
                    local star = 0;
                    if morph then
                        star = morph.star;
                    end
                    lua_resMgr:SetImageTexture(self, self.skillBtn, "iconasset/icon_skill", skillDes.icon, true);
                    if tonumber(skillTab["level"]) > tonumber(star) then
                        --未激活
                        self.mountDes.text = skillDes.desc .. "<color=#ff0000>(" .. skillTab["level"] .. "-Star Activate)</color>";
                    else
                        --已激活
                        self.mountDes.text = skillDes.desc;
                    end
                else
                    self.mountDes.text = "HP +400"
                end
            end
            --end
        end
    end

end

function OffhandPanel:RefreshBtn()
    if OffhandPanel.navTab == 1 then
        self.upStarBtn.gameObject:SetActive(false);
        self.buyBtn.gameObject:SetActive(true);
        self.jihuoBtn.gameObject:SetActive(false);
        self.autoBtn.gameObject:SetActive(true);
    else
        local config = self.model.db_offhand_morph[self.currentSelectedOffhandID];

        if config and MountModel.GetInstance():CheckOffhandIsActive(config.id) then
            --mountTogItem.isActive
            self.jihuoBtn.gameObject:SetActive(false);
            self.upStarBtn.gameObject:SetActive(true);
            self.buyBtn.gameObject:SetActive(true);
        else
            self.jihuoBtn.gameObject:SetActive(true);
            self.upStarBtn.gameObject:SetActive(false);
            self.buyBtn.gameObject:SetActive(false);
        end
        self.autoBtn.gameObject:SetActive(false);
        local morph = MountModel.GetInstance():GetOffHandMorphData(config.id);
        self:RefreshStarAndExp(morph);
        self:CheckUpStarLabel();
    end
end

OffhandPanel.currentSelectedTogItem = nil;
function OffhandPanel:HandleTogClick(go, x, y, mti)
    for k, v in pairs(self.mountTogItems) do
        v:SetIsOn(false);
    end
    mti:SetIsOn(true);
    if self.currentSelectedTogItem ~= mti then

        self.currentSelectedTogItem = mti;
        self.currentSelectedOffhandID = mti.mountID;
        if OffhandPanel.navTab == 1 then
            self:InitModel();
        else
            self:InitMorphModel();
        end

        self:RefreshMountDesc();
        self:InitMaterial();
        if OffhandPanel.navTab == 1 then
            self:HandleOffhandPropChange(enum.TRAIN.TRAIN_OFFHAND);
            SetGameObjectActive(self.mount_ride_btn.gameObject, not self.model:IsOffhand(mti.mountID));
            --SetGameObjectActive(self.skill_bg_2, true);
            --SetGameObjectActive(self.dan_container, true);
            --SetGameObjectActive(self.skill_title_2, true);
        else
            self:UpdateVisionProp();
            local offhandResID = mti.mountID;
            if self.model.db_offhand_morph[mti.mountID] then
                offhandResID = self.model.db_offhand_morph[mti.mountID].res
            end

            SetGameObjectActive(self.mount_ride_btn.gameObject, not (self.model:IsMorphRiding(mti.mountID) or self.model:IsMorphOffhandModel(offhandResID)));
            --SetGameObjectActive(self.skill_bg_2, false);
            --SetGameObjectActive(self.dan_container, false);
            --SetGameObjectActive(self.skill_title_2, false);
        end
    end
    self:RefreshBtn();
    self:SetReddot()
end
--这个是活动的啊,槽
function OffhandPanel:UpdateVisionProp()
    local mountID = self.currentSelectedOffhandID;
    local model = MountModel:GetInstance();
    local config = self.model.db_offhand_morph[mountID];
    local id = config.id;
    local star = 0;

    --消耗的物品在上面,这里不用管了,只做属性的改变
    local propTab;
    local nextTab;
    local starTab = Config.db_offhand_star[id .. "@" .. star];
    if not MountModel.GetInstance():CheckOffhandIsActive(id) then
        --更新战力
        --self.zhanliText.text = "0";
        --更新数据
        propTab = String2Table(starTab.attrs);

        if #propTab < 5 then
            self.PropItems:HideLines(4);
        end
        table.sort(propTab, PropCompareFun);

        nextTab = Config.db_offhand_star[id .. "@" .. (star + 1)];

        if propTab and nextTab then
            self.PropItems:UpdateValues(starTab, nextTab,true)
        end

        if nextTab then
            self.zhanliItems:UpdateZhanli(GetPowerByConfigList(propTab), 0);--策划说不要了GetPowerByConfigList(nextTab) - GetPowerByConfigList(propTab)--self.zhanliItems:UpdateZhanli(starTab.power, (nextTab.power - starTab.power));
        end
    else
        local morph = MountModel.GetInstance():GetOffHandMorphData(id);
        star = morph.star;
        starTab = Config.db_offhand_star[id .. "@" .. star];
        --更新数据
        propTab = String2Table(starTab.attrs);
        table.sort(propTab, PropCompareFun);

        nextTab = Config.db_offhand_star[id .. "@" .. (star + 1)];

        --if propTab and nextTab then
        self.PropItems:UpdateValues(starTab, nextTab,true)
        --end

        --if nextTab then
        --    self.zhanliItems:UpdateZhanli(starTab.power, (nextTab.power - starTab.power));
        --else
        --    self.zhanliItems:UpdateZhanli(0, 0);
        --end

        if nextTab then
            self.zhanliItems:UpdateZhanli(GetPowerByConfigList(propTab), 0);--GetPowerByConfigList(nextTab) - GetPowerByConfigList(propTab)
        else
            self.zhanliItems:UpdateZhanli(GetPowerByConfigList(propTab), 0);
        end
    end
end

function OffhandPanel:HandleOffhandPropChange(type)
    if type ~= enum.TRAIN.TRAIN_OFFHAND then
        return ;
    end
    local model = MountModel:GetInstance();
    local config = Config.db_offhand[model.offhand_layer .. "@" .. model.offhand_level]
    if not config then
        return ;
    end
    local propTab = String2Table(config.attrs);
    table.sort(propTab, PropCompareFun);
    local nextConfig = nil;
    if model.offhand_layer == MountModel.OFFHAND_MAX_LEVEL then

    else
        if model.offhand_level == MountModel.OFFHAND_MAX_LEVEL then
            nextConfig = Config.db_offhand[(model.offhand_layer + 1) .. "@0"]
        else
            nextConfig = Config.db_offhand[model.offhand_layer .. "@" .. (model.offhand_level + 1)]
        end
    end
    local nextPropTab = nil;
    if nextConfig then
        nextPropTab = String2Table(nextConfig.attrs);
        table.sort(nextPropTab, PropCompareFun);
    end

    local danAddedProp = {};
    for k, v in pairs(model.offhand_trainData) do
        local trainTab = Config.db_offhand_train[k];
        if trainTab then
            local attrTabs = String2Table(trainTab.attrs);
            for k1, attrTab in pairs(attrTabs) do
                local k1 = attrTab[1]
                local v1 = attrTab[2];

                danAddedProp[k1] = danAddedProp[k1] or 0;
                danAddedProp[k1] = danAddedProp[k1] + v1 * v;

                if self.danItems then
                    for i = 1, #self.danItems do
                        if k == self.danItems[i].db_id then
                            self.danItems[i]:SetNumText(v);
                        end
                        local num = BagModel:GetInstance():GetItemNumByItemID(self.danItems[i].db_id);
                        if num > 0 then
                            self.danItems[i]:ShowCanUse(num);
                        else
                            self.danItems[i]:HideCanUse();
                        end
                    end
                end
            end
        end
    end

    if propTab  then
        self.PropItems:UpdateValuesMount(config, nextConfig, danAddedProp,true);
    end
    --战力都要算
    if nextPropTab then
        self.zhanliItems:UpdateZhanli(GetPowerByConfigList(propTab), 0);--策划说不要了GetPowerByConfigList(nextPropTab) - GetPowerByConfigList(propTab)
    else
        self.zhanliItems:UpdateZhanli(GetPowerByConfigList(propTab), 0);
    end
    --更新星星
    self.staritem:OpenStars(model.offhand_level);

    local fullExp = Config.db_offhand[model.offhand_layer .. "@" .. model.offhand_level].exp;--{order = 1, level = 0, name = [[1阶0星]], exp = 21, attrs = [[{4,0},{2,0},{6,0},{5,0}]]},
    --print2("full exp = " .. fullExp)
    self.exp_bar.fillAmount = model.offhand_exp / fullExp;
    self.progressText.text = model.offhand_exp .. "/" .. fullExp;
    --self.curstep.text = string.format(ConfigLanguage.Mount.OrderLevel, model.layer, model.level)
    --self.jie.text = "当前副手阶数 : " .. model.layer .. "阶" .. model.level .. "星";--mountID .. "zi";
    self.jie.text = "Current off-hand tier: " .. string.format(ConfigLanguage.Mount.OrderLevel, model.offhand_layer, model.offhand_level)
    --有一种情况为空,就是用道具跳转进来的时候
    if self.itemList then
        for i = 1, #self.itemList, 1 do
            local item = self.itemList[i];
            local num = BagModel:GetInstance():GetItemNumByItemID(item.db_id);
            item:UpdateNum0(num);
        end
    end
end

function OffhandPanel:RefreshStarAndExp(morph)
    if OffhandPanel.navTab == 1 then
        self.staritem:AllOn(false);
        self.staritem:OpenStars(MountModel:GetInstance().offhand_level);
    else
        if morph then
            self.staritem:OpenStars(morph.star);
            local config = Config.db_offhand_star[morph.id .. "@" .. morph.star];
            if config then
                if config.exp == 0 then
                    self.exp_bar.fillAmount = 1;
                    self.progressText.text = "";
                else
                    self.exp_bar.fillAmount = morph.exp / config.exp;
                    self.progressText.text = morph.exp .. "/" .. config.exp;
                end
            end
        else
            self.staritem:OpenStars(0);
            self.exp_bar.fillAmount = 0;
            self.progressText.text = "";
        end
    end
    self:RefreshMountDesc();
end

function OffhandPanel:InitDan()
    destroyTab(self.danItems);
    self.danItems = {};
    local trainTab = MountModel:GetInstance().offhand_trainData;
    for i = 1, #MountModel:GetInstance().OFFHAND_TRAIN_ID do
        local itemId = MountModel:GetInstance().OFFHAND_TRAIN_ID[i];
        local awardItem = AwardItem(self.dan_container);
        awardItem:SetData(itemId, 0);
        local num = BagModel:GetInstance():GetItemNumByItemID(itemId);
        if num > 0 then
            awardItem:ShowCanUse(num);
        end
        local click_call = function(go, x, y)
            if awardItem.iscanusenum then
                MountCtrl:GetInstance():RequestMountTrain(awardItem.db_id, enum.TRAIN.TRAIN_OFFHAND);
            else
                awardItem:ShowTips();
            end
        end
        self.danItems[i] = awardItem;
        AddClickEvent(awardItem.gameObject, click_call);

        if trainTab[itemId] then
            awardItem:SetNumText(trainTab[itemId]);
        end
    end
end

function OffhandPanel:InitMaterial()
    --if not self.currentSelectedMountID then
    --    return;
    --end

    self:ClearItemList();
    local item;
    self.itemList = {};

    local selectedCall_back = function(gameObject, x, y)
        for i = 1, #self.itemList, 1 do
            if self.itemList[i].gameObject == gameObject and self.itemList[i]:GetIsSelected() then
                self.itemList[i]:ShowTips();
                break ;
            end
        end
        for i = 1, #self.itemList, 1 do
            self.itemList[i]:SetIsSelected(false);
        end
        for i = 1, #self.itemList, 1 do
            if self.itemList[i].gameObject == gameObject then
                self.itemList[i]:SetIsSelected(true);
            end
        end
        self:StopAllSchedule();
    end
    local config = self.model.db_offhand_morph[self.currentSelectedOffhandID];
    if OffhandPanel.navTab == 2 and config and not MountModel.GetInstance():CheckOffhandIsActive(config.id) then
        local cost = String2Table(config.cost);
        local itemID = cost[1];
        local costNum = cost[2];
        item = AwardItem(self.itemContainer);
        item:SetData(itemID, 0);
        self.itemList[1] = item;
        local num = BagModel:GetInstance():GetItemNumByItemID(itemID);
        item:SetNumText(num .. "/" .. costNum);
        item:SetIsSelected(false);
        AddClickEvent(item.gameObject, selectedCall_back);
    else
        item = AwardItem(self.itemContainer);
        item:SetData(OffhandPanel.TRAIN_ID, 0);
        self.itemList[1] = item;
        local num = BagModel:GetInstance():GetItemNumByItemID(OffhandPanel.TRAIN_ID);
        item:UpdateNum0(num);
        item:SetIsSelected(false);
        AddClickEvent(item.gameObject, selectedCall_back);
        item = AwardItem(self.itemContainer);
        item:SetData(OffhandPanel.TRAIN_ID_1, 0);
        self.itemList[2] = item;
        local num1 = BagModel:GetInstance():GetItemNumByItemID(OffhandPanel.TRAIN_ID_1);
        item:UpdateNum0(num1);
        item:SetIsSelected(false);
        AddClickEvent(item.gameObject, selectedCall_back);
        if num > 0 then
            self.itemList[1]:SetIsSelected(true);
        elseif num1 > 0 then
            self.itemList[2]:SetIsSelected(true);
        else
            self.itemList[1]:SetIsSelected(true);
        end
    end
end

function OffhandPanel:StopAllSchedule()
    if self.schedules[1] then
        GlobalSchedule:Stop(self.schedules[1]);
    end
    if self.schedules[2] then
        GlobalSchedule:Stop(self.schedules[2]);
    end
    if self.schedules[3] then
        GlobalSchedule:Stop(self.schedules[3]);
    end
    if self.schedules[4] then
        GlobalSchedule:Stop(self.schedules[4]);
    end
    self.schedules = {};
    self.autoText.text = "Auto star-up";
    self.upStar_label.text = "Auto star-up";
    self:CheckUpStarLabel();
end

function OffhandPanel:CheckUpStarLabel()
    local config = self.model.db_offhand_morph[self.currentSelectedOffhandID];
    if config then
        local id = config.id;

        local morph = MountModel.GetInstance():GetOffHandMorphData(id);
        if morph then
            local starConfig = Config.db_offhand_star[morph.id .. "@" .. morph.star];
            if starConfig then
                local nextConfig = Config.db_offhand_star[morph.id .. "@" .. (morph.star + 1)];
                if not nextConfig then
                    --and morph.exp == starConfig.exp
                    self.upStar_label.text = "Max Stars";
                else
                    if self.upStar_label.text ~= "Stop" then
                        self.upStar_label.text = "Auto star-up";
                    end
                end
            end
        end
    end
end

function OffhandPanel:HandleUpstar(data)
    if data.type == enum.TRAIN.TRAIN_OFFHAND then
        local morph = data.morph;
        self:RefreshStarAndExp(morph);
        local item;
        for i = 1, #self.itemList do
            item = self.itemList[i];
            local num = BagModel:GetInstance():GetItemNumByItemID(item.db_id);
            item:UpdateNum0(num);
        end

        item = self:GetMountItemByVisionID(morph.id);
        if item then
            item:SetJie(morph.star);
        end

        if OffhandPanel.navTab == 1 then
            self:HandleOffhandPropChange(enum.TRAIN.TRAIN_OFFHAND);
        else
            self:UpdateVisionProp();
        end

        self:CheckUpStarLabel();
    end
end

function OffhandPanel:ShowAddExp(text1)
    local textObj = self:CreateText();
    textObj.transform:SetParent(self.expCon.transform);
    textObj.gameObject:SetActive(true);
    SetLocalPosition(textObj.transform, 0, 0, 0);
    SetLocalScale(textObj.transform, 1, 1, 1);
    SetLocalRotation(textObj.transform, 0, 0, 0);
    textObj.text = tostring(text1);
    self.textList[#self.textList + 1] = textObj;

    if not self.piaoZiSchedule then
        self.piaoZiSchedule = GlobalSchedule:Start(handler(self, self.UpdateTextList), 0.033, -1);
    end

end

function OffhandPanel:CreateText()
    return newObject(self.TextObj):GetComponent('Text');
end

function OffhandPanel:UpdateTextList()
    local removeIndex = 0;
    for i = 1, #self.textList, 1 do
        local text = self.textList[i];
        local color = text.color;
        local pos = text.transform.localPosition;

        color.a = color.a - 0.1;
        pos.y = pos.y + 1;
        text.color = color;
        text.transform.localPosition = pos;
        if color.a < 0 then
            removeIndex = i;
        end
    end
    for i = 1, removeIndex, 1 do
        destroy(self.textList[1]);
        table.remove(self.textList, 1)
    end
    if #self.textList == 0 then
        GlobalSchedule:Stop(self.piaoZiSchedule);
        self.piaoZiSchedule = nil;
    end
end

function OffhandPanel:HandleVisionBtn(go, x, y)
    local panel = lua_panelMgr:GetPanel(WingHuaXingPanel);
    if panel then
        panel:Close();
    end
    lua_panelMgr:GetPanelOrCreate(WingHuaXingPanel):Open(4)
end

--获取快捷购买的数据
function OffhandPanel:GetQuickBuyData(is_activity)
    local data = {}
    local offhandId 
    local res  --模型资源名
    local name -- 副手名
    local layer --副手阶级
    local star --副手星级
    local propTable --副手属性列表

    if is_activity == false then
        --普通副手
        offhandId = MountModel:GetInstance().offhand_layer
        if offhandId < 10 then
            offhandId = offhandId + 1
        end
        local offhandConfig = Config.db_offhand[offhandId .. "@" .. 0];
        res = offhandConfig.res
        name = offhandConfig.name
        layer = offhandId
        propTable = String2Table(offhandConfig.attrs)
    else
        --活动副手
        offhandId  = self.currentSelectedOffhandID
        local offhandConfig = self.model.db_offhand_morph[offhandId];
        res = offhandConfig.res
        name = offhandConfig.name

        local id = offhandConfig.id;
        local morph = MountModel.GetInstance():GetOffHandMorphData(id);
        star = morph.star;
        if star < 10 then
            star = star + 1
        end
        local starTab = Config.db_offhand_star[id .. "@" .. star];

        propTable = String2Table(starTab.attrs)
    end

    data.path = "model_hand_" .. res
    data.type = enum.ITEM_STYPE.ITEM_STYPE_OFFHAND_MORPH
    data.name = name
    data.layer = layer
    data.star = star
    data.propTable = propTable
    return data
end

--检查是否弹出快捷购买
function OffhandPanel:CheckQuickBuy(is_activity,id)
    if BagModel:GetInstance():GetItemNumByItemID(OffhandPanel.TRAIN_ID) == 0
        and BagModel:GetInstance():GetItemNumByItemID(OffhandPanel.TRAIN_ID_1) == 0
    then

        --两个都为0才弹出快捷购买

        local data = self:GetQuickBuyData(is_activity)
        data.id = id
           
        GlobalEvent:Brocast(QuickBuyEvent.OpenQuickBuyPanel,data)
    end
end