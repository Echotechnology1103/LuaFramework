---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by win 10.
--- DateTime: 2018/9/21 16:53
---
MountUseItem = MountUseItem or class("MountUseItem", Node)
local MountUseItem = MountUseItem

function MountUseItem:ctor(obj, parentNode, trainTab)
    self.itemID = trainTab.item_id;
    self.data = trainTab;
    self.transform = obj.transform
    self.parentNode = parentNode;
    self.gameObject = self.transform.gameObject;
    self.transform_find = self.transform.Find;
    self.events = {};
    self:InitUI();
    self:AddEvents();
end

function MountUseItem:InitUI()
    self.is_loaded = true;
    self.nodes = {
        "itembg", "useNum", "propTxt_1", "propTxt_2", "propTxt_3", "useBtn", "expbar", "icon",
    }
    self:GetChildren(self.nodes)

    local model = MountModel:GetInstance();

    if self.itemID ~= 0 then
        self.item = AwardItem(self.icon.transform);
        self.item:SetData(self.itemID, 0);
        local num = BagModel:GetInstance():GetItemNumByItemID(self.itemID);
        self.item:UpdateNum0(num);
        self.item:AddClickTips(self.parentNode);
    end

    self.expbar = GetScrollbar(self.expbar);
    self.useNum = GetText(self.useNum);

    self:CalcLimitUse();

    self.propTxt_1 = GetText(self.propTxt_1);
    self.propTxt_2 = GetText(self.propTxt_2);
    self.propTxt_3 = GetText(self.propTxt_3);
    self.propTxt_1.gameObject:SetActive(false);
    self.propTxt_2.gameObject:SetActive(false);
    self.propTxt_3.gameObject:SetActive(false);

    self:CalcProp();

    --for i = 1 , #propTab , 1 do
    --    --暂时只有一个属性
    --end
end

function MountUseItem:UpateNum()
    if self.item and self.itemID then
        local num = BagModel:GetInstance():GetItemNumByItemID(self.itemID);
        self.item:UpdateNum0(num);
    end
end

function MountUseItem:CalcProp()
    local model = MountModel:GetInstance();
    local propTab = String2Table(self.data.attrs);
    local k = propTab[1];
    local v = propTab[2];
    self["propTxt_1"].gameObject:SetActive(true);
    local currentUseNum = 0;
    if model.trainData[self.itemID] then
        currentUseNum = tonumber(model.trainData[self.itemID])
    end
    --攻击<color=#43f673>+25</color>
    self["propTxt_1"].text = PROP_ENUM[k].label .. "<color=#40C034>+" .. (tonumber(v) * currentUseNum) .. "</color>";
end
--计算最大能使用
function MountUseItem:CalcLimitUse()
    local level = RoleInfoModel:GetInstance():GetMainRoleLevel();
    local model = MountModel:GetInstance();
    self.limitUseNum = 0;

    local limitTab = String2Table(self.data.limit);
    for i = 1, #limitTab, 1 do
        local tab = limitTab[i];
        if level >= tonumber(tab[1]) and level < tonumber(tab[2]) then
            self.limitUseNum = tonumber(tab[3]);
        end
    end

    local currentUseNum = 0;
    if model.trainData[self.itemID] then
        currentUseNum = tonumber(model.trainData[self.itemID])
    end

    self.useNum.text = currentUseNum .. "/" .. self.limitUseNum;
    self.expbar.size = 0;
    if self.limitUseNum ~= 0 then
        self.expbar.size = currentUseNum / self.limitUseNum;
    end
end

function MountUseItem:AddEvents()
    local call_back = function(target, x, y)
        --print2(self.itemID)
        local num = BagModel:GetInstance():GetItemNumByItemID(self.itemID);
        if num == 0 then
            Notify.ShowText("This mount pill doesn't exist")
            return ;
        end
        MountCtrl:GetInstance():RequestMountTrain(self.itemID , enum.TRAIN.TRAIN_MOUNT);
    end

    AddClickEvent(self.useBtn.gameObject, call_back)

    local call_back2 = function(type , itemID)
        if self.itemID == itemID then
            self:CalcLimitUse();
            self:CalcProp();
        end
    end

    self.events[#self.events + 1] = GlobalEvent:AddListener(MountEvent.MOUNT_USE_DAN, call_back2)
end

function MountUseItem:dctor()
    RemoveClickEvent(self.useBtn.gameObject);
    GlobalEvent:RemoveTabListener(self.events);
    if self.item then
        self.item:destroy();
    end
    self.item = nil;
end

function MountUseItem:LoadCallBack()

end
