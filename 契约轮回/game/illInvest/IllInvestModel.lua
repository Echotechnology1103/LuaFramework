--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Admin.

IllInvestModel = IllInvestModel or class("IllInvestModel",BaseModel)
local IllInvestModel = IllInvestModel

function IllInvestModel:ctor()
    IllInvestModel.Instance = self
    self.act_id_list = {[1] = 1001, [2] = 1002, [3] = 1003 }
    self.investInfoList = {}
    self.redList = {}
    self.is_nextday = false
    self.is_Open = false

    self:Reset()
end

function IllInvestModel:Reset()
    self.is_Open = false
end

function IllInvestModel.GetInstance()
    if IllInvestModel.Instance == nil then
        IllInvestModel()
    end
    return IllInvestModel.Instance
end

function IllInvestModel:SetInvestInfo(info)
    local tab = info.acts
    for i = 1, #tab do
		local id = tab[i].act_id
        self.investInfoList[id] = tab[i]
    end
    self:UpdateRed()
end

function IllInvestModel:SetOneInfo(info)
   local data = self.investInfoList[info.act_id]
    if data then
        if data.day == 0 then
            data.day = 1
            table.insert(data.fetch, 1)
        end
		
		data.fetch[#data.fetch + 1] = info.day
        self.investInfoList[info.act_id] = data
        self:UpdateRed()
    end
end

function IllInvestModel:UpdateRed()
    local is_show = false
    for i, v in pairs(self.investInfoList) do
        local day = v.day > 7 and 7 or v.day
        local is_togRed = false
        if day then
			if day > #v.fetch then
                  is_show = true
                  is_togRed = true
            end
        end
        self.redList[v.act_id] = is_togRed
    end

    GlobalEvent:Brocast(MainEvent.ChangeRedDot, "investment", is_show)
	
	if not self:IsOpen() then
		GlobalEvent:Brocast(MainEvent.ChangeRightIcon,"investment",false)
	end
end

function IllInvestModel:GetConfigData(act_id)
    local config = Config.db_actinvest_reward
	local tab = {}
    if config then
        for i, v in pairs(config) do
            if v.id == act_id then
                table.insert(tab, v)
            end
        end
    end
	table.sort(tab, function (a, b)
		return a.day < b.day
	end)
	
	return tab
end

--  返回 1 不可领取 2 已领取 3 可领取
function IllInvestModel:GetInfoData(act_id, id)
    local data = self.investInfoList[act_id]
    if data then
        if id > data.day then
            return 1
        else
            local tab = data.fetch
            for i = 1, #tab do
                if tab[i] == id then
                    return 2
                end
            end
            return 3
        end
    end
end

function IllInvestModel:GetPriceByActId(act_id)
    local data = Config.db_actinvest
    if data then
        for i, v in pairs(data) do
            if v.id == act_id then
                return v
            end
        end
    end
end

function IllInvestModel:GetEndTimeByActId(act_id)
    local data = self.investInfoList[act_id]
    if data then
        return data.etime
    end
end

function IllInvestModel:GetIsBuyByActId(act_id)
    local data = self.investInfoList[act_id]
    if data then
        return data.day > 0
    end
end

function IllInvestModel:GetRedData()
    return self.redList
end


function IllInvestModel:IsOpen()
	local info = self.investInfoList
	local time = os.time()

    for i, v in pairs(info) do
		if time > v.stime and time < v.etime then
			self.is_Open = true
			return true
		end

        if v.day > 0 and #v.fetch < 7 then
            self.is_Open = true
            return true
        end

    end
	self.is_Open = false
	return false
end


