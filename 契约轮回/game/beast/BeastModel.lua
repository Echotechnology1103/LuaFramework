---魔法卡数据类
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by win 10.
--- DateTime: 18/12/04 16:01
---
BeastModel = BeastModel or class("BeastModel", BaseBagModel)
local this = BeastModel
--神兽背包物品
BeastModel.items = {};

BeastModel.allBeasts = {};

--物品数据,按照顺序存取
BeastModel.beastItemDatas = {}

BeastModel.equipBeasts = {}
--镶嵌在身上的装备
--以神兽的id作为key,最长共5个装备
BeastModel.EmbedEquips = {};
--最大可出战数量
BeastModel.max_summon = 0;

BeastModel.currentBeastEquip = 0;

BeastModel.strengthColor = 2;
BeastModel.maxColor = 6;

function BeastModel:defaultStrengthColor(color)
    if color then
        CacheManager:GetInstance():SetInt("BeastModel.DefaultStrengthColor", color);
    else
        color = CacheManager:GetInstance():GetInt("BeastModel.DefaultStrengthColor", self.strengthColor);
    end
    return color;
end

function BeastModel:defaultStrengthSelect(value)
    if value then
        value = value == 1 and 1 or 0;
        CacheManager:GetInstance():SetInt("BeastModel.defaultStrengthSelect", value);
    else
        value = CacheManager:GetInstance():GetInt("BeastModel.defaultStrengthSelect", 1);
    end
    return value;
end

BeastModel.ItemsUid = {}
BeastModel.POS2CHINESE = {
    [1] = "Beast Horn",
    [2] = "Beast Eye",
    [3] = "Fang",
    [4] = "Beast Claw",
    [5] = "Scale",
}

BeastModel.FONTCOLOR = {
    [1] = "dbdbdb", --dbdbdb--666666
    [2] = "98e42b",
    [3] = "4B8DD2", --72f4f9
    [4] = "914eec",
    [5] = "f38034",
    [6] = "f34343",
    [7] = "ed96fa",
}

function BeastModel:ctor()
    BeastModel.Instance = self;
    self.red_dot_list = {};
    self:Reset();

    self:InitBeasts();

end

function BeastModel:dctor()

end

function BeastModel.GetInstance()
    if BeastModel.Instance == nil then
        BeastModel()
    end
    return BeastModel.Instance
end

function BeastModel:Reset()
    self.red_dot_list = {}
    self.max_summon = 0;
    self.items = {};
    --物品数据,按照顺序存取
    self.beastItemDatas = {}

    self.equipBeasts = {}
    --镶嵌在身上的装备
    --以神兽的id作为key,最长共5个装备
    self.EmbedEquips = {};
    --最大可出战数量
    self.max_summon = 0;

    self.currentBeastEquip = 0;

    self.strengthColor = 2;
end

function BeastModel:AddEquipInBeastBag(idx, item)
    local itemCfg = Config.db_item[item.id]
    if itemCfg ~= nil and itemCfg.type == enum.ITEM_TYPE.ITEM_TYPE_EQUIP_BEAST then
        local hasNil = false
        local nilIndex = 0
        for ii, vv in pairs(self.equipBeasts) do
            if vv == 0 then
                hasNil = true
                nilIndex = ii
                break
            end
        end

        local pos = 0
        if hasNil then
            pos = nilIndex
            self.equipBeasts[pos] = item
        else
            table.insert(self.equipBeasts, #self.equipBeasts + 1, item)
            pos = #self.equipBeasts
        end

        GlobalEvent:Brocast(BagEvent.AddItems, BagModel.beast, pos)
    end
    self:UpdateStengthReddot(item);
    --self:UpdateReddot();
end

function BeastModel:DelEquipInBeastBag(item)
    local itemCfg = Config.db_item[item.id]
    if itemCfg ~= nil and itemCfg.type == enum.ITEM_TYPE.ITEM_TYPE_EQUIP_BEAST then
        for i, v in pairs(self.equipBeasts) do
            if type(v) == "table" and v.uid == item.uid then
                self.equipBeasts[i] = 0
                GlobalEvent:Brocast(GoodsEvent.DelItems, BagModel.beast, item.uid)
                break
            end
        end
        --self:UpdateReddot();
    end
end

function BeastModel:DelItemDataInBeastBag(item)
    local itemCfg = Config.db_item[item.id]
    for i, v in pairs(self.beastItemDatas) do
        if type(v) == "table" and v.uid == item.uid then
            table.removebyindex(self.beastItemDatas, i);
            --self.beastItemDatas[i] = nil;
            --GlobalEvent:Brocast(GoodsEvent.DelItems, BagModel.beast, item.uid);
            --self:UpdateReddot();
            break
        end
    end
end

function BeastModel:GetItemDataByUid(uid)
    local allEquip = self:GetBeastBagItems();
    for k, v in pairs(allEquip) do
        if v.uid == uid then
            return v;
        end
    end
    return nil;
end


--删除空的数据
function BeastModel:DelectedEmptyItem()
    table.removebyvalue(self.equipBeasts, 0, true)
    table.removebyvalue(self.equipBeasts, nil, true)
    table.removebyvalue(self.beastItemDatas, nil, true)
    table.removebyvalue(self.beastItemDatas, 0, true)

    BagModel.Instance:DeleteEmptyItems(BagModel.beast)
end

--删除选中的uid
function BeastModel:DelSelectItemByUid(uid)
    for i, v in pairs(self.ItemsUid) do
        if uid == v then
            table.removebyvalue(self.ItemsUid, v)
            break
        end
    end
end

--设置出售项是否选中
function BeastModel:SetItemSelect(uid, select)
    local hasUid = false
    for i, v in pairs(self.ItemsUid) do
        if v == uid then
            hasUid = true
            break
        end
    end

    if select then
        if not hasUid then
            table.insert(self.ItemsUid, uid)
            --self:Brocast(BagEvent.SetSellMoney)
        end
    else
        if hasUid then
            table.removebyvalue(self.ItemsUid, uid)
            --self:Brocast(BagEvent.SetSellMoney)
        end
    end
end

function BeastModel:DelectedItemByUid(uid)
    local bag = BagModel:GetInstance():GetBag(BagModel.beast)
    self.items = bag.items;
    for k, v in pairs(self.items) do
        if v.uid == uid then
            local item = v;
            self.items[k] = nil;
            BrocastModelEvent(BeastEvent.DELETE_ITEM, nil, item, k)
            return
        end
    end
end

function BeastModel:GetItemSelect(uid)
    local select = false
    for i, v in pairs(self.ItemsUid) do
        if v == uid then
            select = true
        end
    end

    return select
end

function BeastModel:GetAllEqipBaseTbl(eqipTbl)
    local result = {}
    local allTbl = self:GetSortBeastBag()
    for _, itemId in pairs(eqipTbl) do
        for i = 1, #allTbl do
            if itemId == allTbl[i].id then
                if not CombineModel.GetInstance():IsUidUsed(allTbl[i].uid) then
                    result[#result + 1] = allTbl[i]
                end
            end
        end
    end
    return result
end

function BeastModel:GetItemNumByItemID(itemID)
    local bag = BagModel:GetInstance():GetBag(BagModel.beast)
    if not bag then
        return 0
    end
    self.items = bag.items;
    local num = 0
    for i, v in pairs(self.items) do
        if v ~= 0 and v.id == itemID then
            num = num + v.num
        end
    end
    return num
end

function BeastModel:SetItemsByLessQuality(quality, selectedQuality)
    selectedQuality = selectedQuality or quality;
    selectedQuality = selectedQuality > quality and quality or selectedQuality;
    self.beastItemDatas = {}
    local beastItems = BagModel.Instance.bags[BagModel.beast].bagItems

    for i, v in pairs(beastItems) do
        local itemCfg = Config.db_item[v.id]
        if itemCfg.color <= quality then
            table.insert(self.beastItemDatas, v)
        end
        if itemCfg.color <= selectedQuality then
            self:SetItemSelect(v.uid, true)
        else
            self:SetItemSelect(v.uid, false)
        end
    end

    BagModel.Instance:ArrangeGoods(self.beastItemDatas)
end



--function BeastModel
function BeastModel:SetItemsByQulityAndStar(qulity, star)
    self.equipBeasts = {}
    local beastItems = {}
    local allbeastItems = BagModel.Instance.bags[BagModel.beast].bagItems
    for i, v in pairs(allbeastItems or {}) do
        if type(v) == "table" then
            local itemCfg = Config.db_item[v.id]
            if itemCfg.type == enum.ITEM_TYPE.ITEM_TYPE_EQUIP_BEAST then
                table.insert(beastItems, v)
            end
        end
    end
    if qulity == 0 and star == 0 then
        for i, v in pairs(beastItems) do
            if type(v) == "table" then
                table.insert(self.equipBeasts, v)
            end
        end
    else
        for i, v in pairs(beastItems or {}) do
            if type(v) == "table" then
                local itemCfg = Config.db_item[v.id]
                local equipCfg = Config.db_beast_equip[v.id]
                if qulity == 0 then
                    if equipCfg.star == star then
                        table.insert(self.equipBeasts, v)
                    end
                elseif star == 0 then
                    if itemCfg.color == qulity then
                        table.insert(self.equipBeasts, v)
                    end
                elseif itemCfg.color == qulity and equipCfg.star == star then
                    table.insert(self.equipBeasts, v)
                end
            end
        end
    end

    BagModel.Instance:ArrangeGoods(self.equipBeasts)
end

function BeastModel:GetItemByUid(uid)
    local beastDatas = BagModel.Instance:GetBag(BagModel.beast)
    beastDatas = beastDatas or {}
    return beastDatas.items[uid]
end

--获取身上该位置的装备
function BeastModel:GetPutOn(equip_cfg_id)
    local equip = nil
    local equipCfg = Config.db_beast_equip[equip_cfg_id]
    if equipCfg == nil then
        return nil
    else

        local equipsTbl = self.EmbedEquips[self.currentBeastEquip] or {}
        local equips = equipsTbl.equips or {}
        for i, v in pairs(equips) do
            local _beastEquipCfg = Config.db_beast_equip[v.id]
            if _beastEquipCfg.slot == equipCfg.slot then
                -- v.id ~= equip_cfg_id and
                equip = v
                break
            end
        end
    end

    return equip
end

function BeastModel:GetBeastBagItems()
    local bag = BagModel:GetInstance():GetBag(BagModel.beast)
    self.items = bag.items;
    return self.items;
end

function BeastModel:IsBeastEquip(id)
    if Config.db_beast_equip[id] then
        return true;
    else
        return false;
    end
end

function BeastModel:GetSortBeastBag(slot)
    slot = slot or 0;
    local allItems = self:GetBeastBagItems();
    local itemArr = {};
    for k, v in pairs(allItems) do
        local equipConfig1 = Config.db_beast_equip[v.id];
        if equipConfig1.slot ~= 0 then
            table.insert(itemArr, v);
        end
    end
    table.sort(itemArr, function(p_item1, p_item2)
        local itemConfig1 = Config.db_item[p_item1.id];
        local itemConfig2 = Config.db_item[p_item2.id];

        local equipConfig1 = Config.db_beast_equip[p_item1.id];
        local equipConfig2 = Config.db_beast_equip[p_item2.id];

        if equipConfig1.slot == slot and equipConfig2.slot ~= slot then
            return true;
        elseif equipConfig2.slot == slot and equipConfig1.slot ~= slot then
            return false;
        else
            --相同卡槽或者卡槽不同,但是都不等于目标卡槽

            if equipConfig1.slot == equipConfig2.slot then
                if itemConfig1.color == itemConfig2.color then
                    if equipConfig1.star == equipConfig2.star then
                        if p_item1.extra == p_item2.extra then
                            return p_item1.uid > p_item2.uid;
                        else
                            return p_item1.extra > p_item2.extra;
                        end
                    else
                        return equipConfig1.star > equipConfig2.star;
                    end
                else
                    return itemConfig1.color > itemConfig2.color;
                end
            else
                return equipConfig2.slot > equipConfig1.slot;
            end
        end
    end);
    return itemArr;
end

function BeastModel:GetAllEquips()
    local tab = {};
    for k, v in pairs(self.EmbedEquips) do
        if v.summon then
            local equips = v.equips;
            for k1, v1 in ipairs(equips) do
                table.insert(tab, v1);
                v1.beastID = k;
            end
            --for i = 1, 5 do
            --    if equips[i] then
            --        table.insert(tab , equips[i]);
            --    end
            --end
        end
    end
    return tab;
end

function BeastModel:GetBeastIDByItemUid(uid)
    for k, v in pairs(self.EmbedEquips) do
        local equips = v.equips;
        for k1, v1 in ipairs(equips) do
            if v1.uid == uid then
                return k;
            end
        end
    end
    return nil;
end

function BeastModel:GetConfig(item_id)
    return Config.db_beast_equip[item_id]
end

function BeastModel:GetEquipCanPutOn(equipId)
    return true
end

function BeastModel:GetEquipScoreInCfg(equipId)
    local score = 0
    local equip = Config.db_beast_equip[equipId]
    local equipBaseTbl = String2Table(equip.base)
    for i, v in pairs(equipBaseTbl) do
        score = score + v[2] * Config.db_beast_equip_score[v[1]].ratio
    end

    return math.floor(score)
end

--@ling autofun 
function BeastModel:InitBeasts()
    self.allBeasts = {};
    for k, v in pairs(Config.db_beast) do
        table.insert(self.allBeasts, v);
    end
    table.sort(self.allBeasts, OrderCompareFun);
end
--异兽整体红点刷新
function BeastModel:UpdateReddot()
    --local r2 = self.red_dot_list and self.red_dot_list[2] or false;
    self.red_dot_list = {};
    --self.red_dot_list[2] = r2;
    --self:UpdateStengthReddot();
    self.red_dot_list[1] = {};
    if not self:IsFullAssist() then
        self:UpdateAssistReddot();
    end
    self.red_dot_list[3] = {};
    self.red_dot_list[4] = {};
    self:UpdateBetterEquip();

    --print2(">>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>");
    --print2(Table2String(self.red_dot_list));
    local isMainReddot = self:IsMainReddot();
    local isIllReddot = illustrationModel.GetInstance():CheckReddotByAll()
    local isIllDecomposeReddot = illustrationModel.GetInstance():CheckDecomposeReddot()

    GlobalEvent:Brocast(MainEvent.ChangeRedDot, "beast", isMainReddot or isIllReddot or isIllDecomposeReddot)--主菜单
    BrocastModelEvent(BeastEvent.UpdateRedDot);
end
--物品改变需要更新
function BeastModel:UpdateStengthReddot(item)
    self.red_dot_list[2] = false;
    local defaultColor = self.maxColor - self:defaultStrengthColor();
    --if item then
    --
    --    local itemConfig = Config.db_item[item.id];
    --    if itemConfig then
    --        if itemConfig.color <= defaultColor and self:CalcItemExp(item) > 10 then
    --            self.red_dot_list[2] = true;
    --        end
    --    end
    --
    --else
    --整个db_beast_equip都要遍历吧?
    local num = 0;
    local allbeastItems = self:GetBeastBagItems();
    for k, v in pairs(allbeastItems) do
        local itemConfig = Config.db_item[v.id];
        if itemConfig then
            if itemConfig.color <= defaultColor then
                --and self:CalcItemExp(v) > 10
                --self.red_dot_list[2] = true;
                num = num + 1;
            end
        end
    end
    if num >= 10 then
        self.red_dot_list[2] = true;
    end
    --end
end
--可助战红点
function BeastModel:UpdateAssistReddot()
    self.red_dot_list[1] = {};

    --k是神兽ID,V
    for k, v in pairs(self.allBeasts) do
        local beast = self.EmbedEquips[k] or {};
        local equips = beast.equips or {};
        local allEquip = true;
        for i = 1, 5 do
            if not equips[i] then
                allEquip = false;
            end
        end

        if not beast.summon and allEquip then
            self.red_dot_list[1][k] = true;
        end
    end

end

function BeastModel:UpdateBetterEquip()
    --k是神兽ID,V
    for k, v in pairs(self.allBeasts) do
        local beast = self.EmbedEquips[k] or {};
        local equips = beast.equips or {};
        self.red_dot_list[3][k] = {};
        self.red_dot_list[4][k] = {};
        if not self:IsFullAssist() then
            for i = 1, 5 do
                local equip = equips[i];
                if equip then
                    --有更好的装备
                    if self:IsBetterEquip(equip) then
                        self.red_dot_list[3][k][i] = true;
                    end
                    --self.red_dot_list[4][k][i] = true;
                else
                    --有可穿的装备
                    if self:IsSlotBetterEquip(k, i) then
                        self.red_dot_list[4][k][i] = true;
                    end
                end
            end
        end
    end
end
function BeastModel:IsBetterEquip(item)
    local itemConfig = Config.db_beast_equip[item.id];
    if not itemConfig then
        return false;
    end
    local allbeastItems = self:GetBeastBagItems();
    for k, v in pairs(allbeastItems) do
        local itemConfig1 = Config.db_beast_equip[v.id];
        --if itemConfig1 and itemConfig1.score > itemConfig.score then
        --    return true;
        --end
        if itemConfig1 and itemConfig1.slot == itemConfig.slot and v.score > item.score then
            return true;
        end
    end
    return false;
end
function BeastModel:IsSlotBetterEquip(beastID, slot)
    local needColor = 8;
    local beastConfig = Config.db_beast[beastID];
    if beastConfig then
        local slotColorTab = String2Table(beastConfig.slot)
        for k, v in pairs(slotColorTab) do
            if v[1] == slot then
                needColor = v[2];
            end
        end
    end
    local allbeastItems = self:GetBeastBagItems();
    for k, v in pairs(allbeastItems) do
        local equipConfig = Config.db_beast_equip[v.id];
        local itemConfig = Config.db_item[v.id];
        if equipConfig and equipConfig.slot == slot and itemConfig and itemConfig.color >= needColor then
            return true;
        end
    end
end

function BeastModel:IsFullAssist()
    local summonNum = 0;
    for k, v in pairs(self.EmbedEquips) do
        if v.summon then
            summonNum = summonNum + 1;
        end
    end
    --最大出战了
    if summonNum == self.max_summon then
        return true;
    end
    return false;
end

function BeastModel:CalcItemExp(item)
    local addedExp = 0;
    local equipConfig = Config.db_beast_equip[item.id];
    if equipConfig then
        addedExp = addedExp + equipConfig.exp;

        if item.extra and item.extra >= 1 then
            local slot = equipConfig.slot;
            local total = 0;
            for i = 1, item.extra do
                local reinConfig = Config.db_beast_reinforce[slot .. "@" .. item.extra];
                if reinConfig then
                    total = reinConfig.total;
                end
            end
            addedExp = addedExp + total;
        end
    end
    return addedExp;
end

function BeastModel:IsMainReddot()
    if self.red_dot_list[2] then
        return true;
    end

    --for k, v in pairs(self.red_dot_list[2]) do
    --    if v then
    --        return true;
    --    end
    --end
    for k, v in pairs(self.red_dot_list[1]) do
        if v then
            return true;
        end
        --for k1, v1 in pairs(v) do
        --    if v1 then
        --        return true;
        --    end
        --end
    end
    for k, v in pairs(self.red_dot_list[3]) do
        for k1, v1 in pairs(v) do
            if v1 then
                return true;
            end
        end
    end

    for k, v in pairs(self.red_dot_list[4]) do

        if self:GetCanEquipReddot(k) then
            return true;
        end
        --local canUpdate = 0;
        --
        --for k1, v1 in pairs(v) do
        --    if v1 then
        --        canUpdate = canUpdate + 1;
        --    end
        --end
        --if canUpdate >= 1 then
        --    return true;
        --end
    end

    return false;
end

function BeastModel:GetSummonReddot(id)
    id = id or self.currentBeastEquip;
    if self.red_dot_list and self.red_dot_list[1] and self.red_dot_list[1][id] then
        return true;
    end
    return false;
end

function BeastModel:GetCanUpdateReddot(id)
    id = id or self.currentBeastEquip;
    local flag = false;
    for k, v in pairs(self.red_dot_list[3][id]) do
        if v then
            return true;
        end
    end
    return false;
end

function BeastModel:GetCanEquipReddot(id)
    id = id or self.currentBeastEquip;
    --local flag = true;
    local is5equip = false;
    if self.EmbedEquips[id] then
        local equips = self.EmbedEquips[id].equips;
        if table.nums(equips) == 5 then
            return false;
        end
        local index = 0;
        for i = 1, 5 do
            if self.red_dot_list[4][id][i] or self:IsPosHasEquip(id, i) then
                index = index + 1;
            end
        end
        if index >= 5 then
            return true;
        end
    else
        local index = 0;
        for i = 1, 5 do
            if self.red_dot_list[4][id][i] then
                index = index + 1;
            end
        end
        if index >= 5 then
            return true;
        end
    end

    return false;
end

function BeastModel:IsPosHasEquip(beastID, pos)
    if self.EmbedEquips[beastID] then
        local equips = self.EmbedEquips[beastID].equips;
        if equips and equips[pos] then
            return true
        end
    end
    return false;
end

function BeastModel:GetCurrentDefaultSlot()
    if self.red_dot_list[3] then
        if self.red_dot_list[3][self.currentBeastEquip] then
            for i = 1, 5 do
                if self.red_dot_list[3][self.currentBeastEquip][i] then
                    return i;
                end
            end

        end
    end

    return nil;
end

function BeastModel:CheckCanEquip(uid)
    local beastItem = self:GetItemDataByUid(uid);
    if not beastItem then
        return "Unable to find the item, please try again";
    end
    local beast = Config.db_beast[self.currentBeastEquip];
    if not beast then
        return "Beast data exception, please try again";
    end
    local beastEquipItem = Config.db_beast_equip[beastItem.id];
    if not beastEquipItem then
        return "Unable to find Gear configuration";
    end

    local itemConfig = Config.db_item[beastItem.id];
    if not itemConfig then
        return "Unable to find item configuration";
    end
    local beastSlot = String2Table(beast.slot);
    local needColor = 8;
    for k, v in pairs(beastSlot) do
        local key = v[1];
        local value = v[2];
        if key == beastEquipItem.slot then
            needColor = value;
        end
    end
    if itemConfig.color < needColor then
        return beast.name .. "Need to equip first" .. "<color=#" .. self.FONTCOLOR[needColor] .. ">" .. enumName.COLOR[needColor] .. tostring(BeastModel.POS2CHINESE[beastEquipItem.slot]) .. "</color>"
    end
end