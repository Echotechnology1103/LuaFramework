---神兽主页 暂时用不上了.因为和原来想的不一样
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by win 10.
--- DateTime: 18/12/04 16:10
---

BeastInfoPanel = BeastInfoPanel or class("BeastInfoPanel", BaseItem)
local this = BeastInfoPanel

function BeastInfoPanel:ctor(parent_node)
    self.abName = "beast";
    self.image_ab = "beast_image";
    self.assetName = "BeastInfoPanel"
    self.layer = "UI"
    self.items = {};

    self.model = BeastModel.GetInstance()
    self.events = {};
    self.schedules = {};
    BeastInfoPanel.super.Load(self);
end

function BeastInfoPanel:dctor()
    self.model = nil;

    GlobalEvent:RemoveTabListener(self.events);
    self:StopAllSchedules()
    destroyTab(self.items);
    self.items = nil;
    self.preSelectItem = nil;

    self:DestroySkills();
    self.skillItems = nil;
    if self.bagUi then
        self.bagUi:destroy();
    end
    self.bagUi = nil;

    destroyTab(self.equipItems);
    self.equipItems = nil;

    self.labels = nil;
    self.values = nil;
    self.equips = nil;

    if self.strength_reddot then
        self.strength_reddot:destroy();
    end
    self.strength_reddot = nil;
    if self.bag_reddot then
        self.bag_reddot:destroy();
    end
    self.bag_reddot = nil;
    if self.summon_reddot then
        self.summon_reddot:destroy();
    end
    self.summon_reddot = nil;
end

--@ling autofun
function BeastInfoPanel:DestroySkills()
    if self.skillItems then
        for k, v in pairs(self.skillItems) do
            destroy(v);
        end
    end
end

function BeastInfoPanel:OnDisable()
    --if self.bg then
    --    self.bg.transform:SetParent(self.transform);
    --end
end
function BeastInfoPanel:OnEnable()
    --local parent = self.transform:Find("PanelBackgroundTwo(Clone)/img_bg_2");
    --if parent then
    --    self.bg.transform:SetParent(parent.transform);
    --end
end

function BeastInfoPanel:Open(data)
    self.data = data;
    WindowPanel.Open(self)
end

function BeastInfoPanel:AddEquipSlotEvent()
    for i = 1, #self.equips, 1 do
        RemoveClickEvent(self.equips[i].gameObject);
        AddClickEvent(self.equips[i].gameObject, handler(self, self.HandleEquipSort, i));
    end
end

function BeastInfoPanel:AddEvent()
    for k, v in pairs(self.items) do
        AddClickEvent(v.gameObject, handler(self, self.HandleScrollClick, k));
    end
    --self:AddEquipSlotEvent()

    AddClickEvent(self.strength.gameObject, handler(self, self.HandleStrength));

    AddClickEvent(self.onekey.gameObject, handler(self, self.HandleOneKey));

    AddClickEvent(self.bag.gameObject, handler(self, self.HandleEquipBag));

    AddClickEvent(self.summon.gameObject, handler(self, self.HandleSummon));

    AddClickEvent(self.jiaBtn.gameObject, handler(self, self.HandleOpenBuyTip));

    AddEventListenerInTab(BeastEvent.BEAST_LIST, handler(self, self.HandleBeastList), self.events);

    AddEventListenerInTab(BeastEvent.BEAST_EQUIP_LOADED, handler(self, self.HandleBeastEquipLoad), self.events);
    AddEventListenerInTab(BeastEvent.BEAST_EQIUP_UNLOAD, handler(self, self.HandleEquipUnload), self.events);

    AddEventListenerInTab(BeastEvent.BEAST_SUMMON, handler(self, self.HandleSummonChange), self.events);
    AddEventListenerInTab(BeastEvent.BEAST_UNSUMMON, handler(self, self.HandleSummonChange), self.events);
    AddEventListenerInTab(BeastEvent.ADD_MAX_SUMMON, handler(self, self.HandleMaxSummon), self.events);

    AddEventListenerInTab(BeastEvent.UpdateRedDot, handler(self, self.UpdateReddot), self.events);


    local stren_call_back = function()
        self:RefreshEquips();
        self:RefreshEquipProp();
    end
    AddEventListenerInTab(BeastEvent.BEAST_STRENGTH, stren_call_back, self.events);
end

function BeastInfoPanel:LoadCallBack()
    self.nodes = {
        "bgs/bg",
        --label
        "l/label_1", "l/label_2", "l/label_4", "l/label_3",
        --value
        "v/value_1", "v/value_2", "v/value_3", "v/value_4",
        --btns
        "btns/assistNum", "btns/jiaBtn", "btns/strength", "btns/bag", "btns/summon", "btns/onekey", "btns/summon/summonText",
        --
        "beast_skill_item", "moncon", "us_item", "ScrollView/Viewport/Content", "skills", "desc",
        --equips
        "equip/equip_5", "equip/equip_1", "equip/equip_2", "equip/equip_3", "equip/equip_4",
    }
    self:GetChildren(self.nodes);

    SetLocalPosition(self.transform, 0, 0, 0);

    self:InitUI();

    self:AddEvent();
    self:UpdateReddot();
end

function BeastInfoPanel:InitUI()
    self.labels = {};
    self.values = {};
    self.equips = {};
    for i = 1, 4 do
        self.labels[i] = GetText(self["label_" .. i]);
        self.values[i] = GetText(self["value_" .. i]);
        self.equips[i] = GetImage(self["equip_" .. i]);
    end
    self.equips[5] = GetImage(self["equip_" .. 5]);
    self.assistNum = GetText(self.assistNum);
    self.jiaBtn = GetButton(self.jiaBtn);
    self.strength = GetButton(self.strength);
    self.bag = GetButton(self.bag);
    self.summon = GetButton(self.summon);
    self.summonImg = GetImage(self.summon);
    self.onekey = GetButton(self.onekey);

    self.moncon = GetImage(self.moncon);

    self.summonText = GetText(self.summonText);

    self:InitTogs();

    self:HandleBeastList();

    self:HandleMaxSummon();

    self.strength_reddot = RedDot(self.strength.transform, nil, RedDot.RedDotType.Nor)
    self.strength_reddot:SetPosition(64, 22);
    --self.strength_reddot:SetRedDotParam(true);

    self.bag_reddot = RedDot(self.bag.transform, nil, RedDot.RedDotType.Nor)
    self.bag_reddot:SetPosition(64, 22);
    --self.bag_reddot:SetRedDotParam(true);

    self.summon_reddot = RedDot(self.summon.transform, nil, RedDot.RedDotType.Nor)
    self.summon_reddot:SetPosition(64, 22);
    --self.summon_reddot:SetRedDotParam(true);
end

function BeastInfoPanel:InitTogs()
    destroyTab(self.items);
    self.items = {};
    SetGameObjectActive(self.us_item, true);
    self.defaultSelectedIndex = 1;
    for i = 1, #self.model.allBeasts, 1 do
        local tab = self.model.allBeasts[i];
        local item = BeastScrollItem(newObject(self.us_item), tab);
        self.items[i] = item;
        item:SetScoreText("Rating: " .. 0);
        self:CalcScore(item);
        item:SetIcon(tab.res);
        item:SetColor(tab.color)

        SetParent(item.transform, self.Content.transform);
        SetLocalPosition(item.transform, 0, 0, 0);
        SetLocalScale(item.transform, 1, 1, 1);
    end

    local rt = GetRectTransform(self.Content);
    rt.sizeDelta = Vector2(rt.sizeDelta.x, #self.items * 90);
    if #self.items >= self.defaultSelectedIndex then
        self:HandleScrollClick(nil, nil, nil, self.defaultSelectedIndex);--self.items[1]
    end
    if self.defaultSelectedIndex <= 3 then
        SetLocalPositionY(rt, 0);
    else
        SetLocalPositionY(rt, (self.defaultSelectedIndex - 3) * 90);
    end

    SetGameObjectActive(self.us_item, false);
end


BeastInfoPanel.preSelectItem = nil;
BeastInfoPanel.preSelectItemIndex = -1;
--点击ScrollItem事件
function BeastInfoPanel:HandleScrollClick(go, x, y, k)
    if self.preSelectItemIndex == k then
        return ;
    end
    if self.preSelectItem then
        self.preSelectItem:SetIsSelected(false);
    end
    self.preSelectItemIndex = k;
    self.preSelectItem = self.items[k];
    self.preSelectItem:SetIsSelected(true);
    self:RefreshItem(self.preSelectItem);
    self.model.currentBeastEquip = self.preSelectItem.data.id;
    self:RefreshImage();
    self:UpdateReddot();
end

function BeastInfoPanel:RefreshImage()
    local data1 = self.preSelectItem.data;
    lua_resMgr:SetImageTexture(self, self.moncon, self.image_ab, "beast_" .. data1.res, false);
    --local data = self.preSelectItem.data;
    local data = self.model.EmbedEquips[self.preSelectItemIndex];
    if data and data.summon then
        ShaderManager:GetInstance():SetImageNormal(self.moncon);
    else
        ShaderManager:GetInstance():SetImageGray(self.moncon);
    end
end

function BeastInfoPanel:RefreshEquipProp()
    if not self.preSelectItem then
        return ;
    end
    local data = self.preSelectItem.data;
    local embedEquips = self.model.EmbedEquips[self.preSelectItemIndex];
    local propTab = {};
    if embedEquips then
        local equips = embedEquips.equips;
        local index = 1;
        local eventSlot = {};
        for i = 1, 5, 1 do
            if equips[i] then
                index = index + 1
                local p_item = equips[i];
                local equipConfig = Config.db_beast_equip[p_item.id];
                if equipConfig then
                    local prop = String2Table(equipConfig.base);
                    eventSlot[equipConfig.slot] = true;
                    for j = 1, #prop, 1 do
                        local tab = prop[j];
                        local k = tab[1];
                        local v = tab[2];
                        if not propTab[k] then
                            propTab[k] = 0;
                        end
                        propTab[k] = propTab[k] + v;
                    end
                    local strengthConfig = Config.db_beast_reinforce[i .. "@" .. p_item.extra];
                    if strengthConfig then
                        prop = String2Table(strengthConfig.base);
                        for j = 1, #prop, 1 do
                            local tab = prop[j];
                            local k = tab[1];
                            local v = tab[2];
                            if not propTab[k] then
                                propTab[k] = 0;
                            end
                            propTab[k] = propTab[k] + v;
                        end
                    end
                end

            end
        end

        for i = 1, 5, 1 do
            if eventSlot[i] then
                RemoveClickEvent(self.equips[i].gameObject);
            else
                AddClickEvent(self.equips[i].gameObject, handler(self, self.HandleEquipSort, i));
            end
        end

        if embedEquips.summon then
            self.summonText.text = "Recall";
            self.summon.interactable = true;
            ShaderManager:GetInstance():SetImageNormal(self.summonImg);
        else
            if index == 6 then
                self.summonText.text = "Assist";
                self.summon.interactable = true;
                ShaderManager:GetInstance():SetImageNormal(self.summonImg);
            else
                self.summonText.text = "Assist";
                self.summon.interactable = false;
                ShaderManager:GetInstance():SetImageGray(self.summonImg);
            end
        end
    else
        self:AddEquipSlotEvent();
        self.summonText.text = "Assist";
        self.summon.interactable = false;
        ShaderManager:GetInstance():SetImageGray(self.summonImg);
    end
    --62EA43
    local index = 1;
    local base = String2Table(data.attr);
    for k, v in pairs(base) do
        local key = v[1];
        local value = v[2];
        local suffix = "";
        propTab[key] = propTab[key] or 0;
        if propTab[key] ~= 0 then
            suffix = "<color=#62EA43>+" .. tonumber(propTab[key]) .. "</color>";--"+" .. tonumber(propTab[key])
        end
        self.labels[index].text = PROP_ENUM[key].label .. ":";
        if v[1] >= 13 then
            self.values[index].text = math.ceil(tonumber(value) / 100) .. suffix .. "%";
        else
            self.values[index].text = tostring(value) .. suffix;
        end

        SetGameObjectActive(self.values[index].gameObject, true);

        index = index + 1;
    end
end

function BeastInfoPanel:RefreshItem(item)
    local data = item.data;

    local index = 1;
    SetGameObjectActive(self.beast_skill_item, true);
    local skill = String2Table(data.skill);
    index = 1;
    self:DestroySkills()
    self.skillItems = {};
    for k, v in pairs(skill) do
        local skillConfig = Config.db_skill[v[1]];
        if skillConfig then
            local bsi = newObject(self.beast_skill_item);
            local icon = GetImage(GetChild(bsi.transform, "skill_icon"));
            local level = GetText(GetChild(bsi.transform, "skill_level"));
            level.text = "Level" .. tostring(v[2]);
            lua_resMgr:SetImageTexture(self, icon, "iconasset/icon_skill", skillConfig.icon, true);
            SetGameObjectActive(icon, true);
            SetParent(bsi.transform, self.skills.transform);
            SetLocalPosition(bsi.transform, 0, 0, 0);
            SetLocalScale(bsi.transform, 1, 1, 1);
            self.skillItems[index] = bsi.gameObject;
            index = index + 1;
            AddClickEvent(bsi.gameObject, handler(self, self.HandleSkillTip, v[1]));
        end
    end

    SetGameObjectActive(self.beast_skill_item, false);
    self:RefreshEquipProp();
    self:RefreshEquips();
end

function BeastInfoPanel:RefreshEquips()
    destroyTab(self.equipItems);
    self.equipItems = {};
    local resetPoscallback = function(baseiconsettor)
        SetAnchoredPosition(baseiconsettor.transform, -5, 5);
    end
    if self.is_loaded then
        if self.model.EmbedEquips[self.preSelectItemIndex] then
            local tab = self.model.EmbedEquips[self.preSelectItemIndex];
            local embedEquips = tab.equips;
            for k, v in pairs(embedEquips) do
                local equipConfig = Config.db_beast_equip[embedEquips[k].id];
                local slot = equipConfig.slot;

                local param = {}
                local operate_param = {}
                GoodsTipController.Instance:SetTakeOffCB(operate_param, handler(self, self.TakeOff), { embedEquips[k] })
                GoodsTipController.Instance:SetStrongCB(operate_param, handler(self, self.Strong), { embedEquips[k] })
                param["cfg"] = Config.db_beast_equip[embedEquips[k].id]
                param["model"] = self.model
                param["p_item"] = embedEquips[k]
                param["can_click"] = true
                --param["out_call_back"] = callback
                param["operate_param"] = operate_param

                local awarditem = GoodsIconSettorTwo(self.equips[slot].transform);
                awarditem:SetIcon(param)

                --awarditem:LoadNow(resetPoscallback);
                --awarditem:UpdateIconClickNotOperate(embedEquips[k], 0, nil, ClickGoodsIconEvent.Click.BEAST_SHOW);
                --local awarditem = AwardItem(self.equips[slot].transform);
                --awarditem:SetData(embedEquips[k].id, 1);
                if self.equipItems[slot] then
                    self.equipItems[slot]:destroy();
                end
                self.equipItems[slot] = awarditem;
            end
        end
    end
end

--@ling autofun
function BeastInfoPanel:HandleStrength()
    if self.strength.enabled then
        lua_panelMgr:GetPanelOrCreate(BeastStrengthPanel):Open();
    else
        Notify.ShowText("You can only enhance gear of deployed beasts");
    end
    self.model.red_dot_list[2] = false;
    self:UpdateReddot();
end

--@一键卸下
function BeastInfoPanel:HandleOneKey()
    if self.preSelectItem then
        local data = self.preSelectItem.data;
        BeastCtrl:GetInstance():RequestEquipUnLoad(data.id, 0);
    end
end

--@ling autofun
function BeastInfoPanel:HandleBeastList()
    local index = 0;
    for k, v in pairs(self.model.EmbedEquips) do
        if v.summon then
            index = index + 1;
            if self.items[k] then
                self.items[k]:SetIsAssist(true);
                self.items[k]:SetGray(false);
            end
        end
    end
    self:RefreshEquips();

    self:RefreshEquipProp();

    self:HandleMaxSummon();

    --
    self:UpdateReddot();
    --if self.strength_reddot then
    --    self.strength_reddot:SetRedDotParam(false);
    --end


    --self.assistNum.text = "助战神兽:   <color=#56BF3E>" .. index .. "/" .. self.model.max_summon .. "</color>";
end

--@ling autofun
function BeastInfoPanel:HandleBeastEquipLoad(data)
    local id = data.id;
    local p_item = data.equip;

    --local equipConfig = Config.db_beast_equip[p_item.id];
    --local slot = equipConfig.slot;
    --local resetPoscallback = function(baseiconsettor)
    --    SetAnchoredPosition(baseiconsettor.transform, -5, 5);
    --end
    --local awarditem = GoodsIconSettorTwo(self.equips[slot].transform);
    --awarditem:LoadNow(resetPoscallback);
    --awarditem:UpdateIconClickNotOperate(p_item, 1, nil, ClickGoodsIconEvent.Click.BEAST_SHOW);
    ----local awarditem = AwardItem(self.equips[slot].transform);
    ----awarditem:SetData(p_item.id, 1);
    --if self.equipItems[slot] then
    --    self.equipItems[slot]:destroy();
    --end
    --self.equipItems[slot] = awarditem;

    self:RefreshEquips();
    self:RefreshEquipProp();

    self:HandleSummonBtnStatus();
    self:CalcScore(self.items[data.id])
    --self:RefreshEquips();
end
--loadStatus 0表示空,1表示load,2表示unload
function BeastInfoPanel:HandleSummonBtnStatus()
    local embedEquips = self.model.EmbedEquips[self.preSelectItemIndex];
    local index = 1;
    if embedEquips then
        local equips = embedEquips.equips;
        for k, v in pairs(equips) do
            index = index + 1;
        end
        if index == 6 then
            self.summonText.text = "Assist";
            self.summon.interactable = true;
            ShaderManager:GetInstance():SetImageNormal(self.summonImg);
        else
            self.summonText.text = "Assist";
            self.summon.interactable = false;
            ShaderManager:GetInstance():SetImageGray(self.summonImg);
        end
        self.preSelectItem:SetIsAssist(embedEquips.summon);
        self.preSelectItem:SetGray(not embedEquips.summon);
    else
        self.summonText.text = "Assist";
        self.summon.interactable = false;
        ShaderManager:GetInstance():SetImageGray(self.summonImg);
        self.preSelectItem:SetIsAssist(false);
        self.preSelectItem:SetGray(true);
    end


end

--@ling autofun
function BeastInfoPanel:HandleEquipUnload(data)
    local id = data.id;
    local slot = data.slot;

    self:RefreshEquips();
    self:RefreshEquipProp();
    --if slot == 0 then
    --    if self.preSelectItemIndex == id then
    --        destroyTab(self.equipItems);
    --        self.equipItems = {};
    --    end
    --else
    --    if self.equipItems and self.equipItems[slot] then
    --        self.equipItems[slot]:destroy();
    --        self.equipItems[slot] = nil;
    --    end
    --end
    local embedEquips = self.model.EmbedEquips[id];
    if embedEquips then
        embedEquips.summon = false;
    end
    self:HandleMaxSummon();
    self:HandleSummonBtnStatus();

    self:CalcScore(self.items[data.id])
end

--@ling autofun
function BeastInfoPanel:HandleEquipBag(go, x, y)
    local bagui = lua_panelMgr:GetPanel(BeastEquipPanel);
    if bagui then
        bagui:Close();
    end
    self.model.currentBeastEquip = self.preSelectItem.data.id;

    local slot = self.model:GetCurrentDefaultSlot();
    lua_panelMgr:GetPanelOrCreate(BeastEquipPanel):Open(slot);
end

--@ling autofun
function BeastInfoPanel:HandleSummon(go, x, y)
    if self.summon.interactable then
        local embedEquips = self.model.EmbedEquips[self.preSelectItemIndex];
        if embedEquips then
            if embedEquips.summon then
                BeastCtrl:GetInstance():RequestUnSummon(self.preSelectItemIndex);
            else
                BeastCtrl:GetInstance():RequestSummon(self.preSelectItemIndex);
            end
        else
        end
    else

    end
end

--@ling autofun
function BeastInfoPanel:HandleSkillTip(go, x, y, id)
    local tipsPanel = lua_panelMgr:GetPanelOrCreate(TipsSkillPanel)
    tipsPanel:Open();
    tipsPanel:SetId(id, self.skills)
end

function BeastInfoPanel:StopAllSchedules()
    for i = 1, #self.schedules, 1 do
        GlobalSchedule:Stop(self.schedules[i]);
    end
    self.schedules = {};
end

function BeastInfoPanel:TakeOff(param)
    local equipCfg = Config.db_beast_equip[param[1].id]
    BeastCtrl:GetInstance():RequestEquipUnLoad(self.model.currentBeastEquip, equipCfg.slot)
    GlobalEvent:Brocast(GoodsEvent.CloseTipView)
end

function BeastInfoPanel:Strong(param)
    if self.strength.enabled then
        lua_panelMgr:GetPanelOrCreate(BeastStrengthPanel):Open(param[1].uid);
    else
        Notify.ShowText("You can only enhance gear of deployed beasts");
    end
end


--@ling autofun
function BeastInfoPanel:HandleSummonChange(id)
    local embedEquips = self.model.EmbedEquips[self.preSelectItemIndex];

    self:HandleMaxSummon();
    self:RefreshImage();
    if self.items and self.items[self.model.currentBeastEquip] then
        self:CalcScore(self.items[self.model.currentBeastEquip]);
    end
    --self:RefreshEquipProp();
    if embedEquips then
        if embedEquips.summon then
            self.summonText.text = "Recall";
            self.summon.interactable = true;
            ShaderManager:GetInstance():SetImageNormal(self.summonImg);
            self.preSelectItem:SetIsAssist(embedEquips.summon);
            self.preSelectItem:SetGray(not embedEquips.summon)
            return ;
        end
    end
    self:HandleSummonBtnStatus();

end

--@ling autofun
function BeastInfoPanel:HandleMaxSummon()
    local index = 0;
    local flag = false;
    for k, v in pairs(self.model.EmbedEquips) do
        if v.summon then
            index = index + 1;
            if self.items[k] then
                self.items[k]:SetIsAssist(true);
            end
            flag = true;
        end
    end
    if flag then
        local img = GetImage(self.strength.gameObject);
        ShaderManager:GetInstance():SetImageNormal(img);
        self.strength.enabled = true;
        self.model.strengthEnable = true;
    else
        local img = GetImage(self.strength.gameObject);
        ShaderManager:GetInstance():SetImageGray(img);
        self.strength.enabled = false;
        self.model.strengthEnable = false;
    end
    self.assistNum.text = "Assisting Divine Beast: <color=#56BF3E>" .. index .. "/" .. self.model.max_summon .. "</color>";
end

--@ling autofun
function BeastInfoPanel:HandleOpenBuyTip(go, x, y)
    local tab = Config.db_beast_summon[self.model.max_summon + 1];

    if tab then
        local panel = lua_panelMgr:GetPanel(BeastBuyTip);
        if panel then
            panel:Close();
        end
        lua_panelMgr:GetPanelOrCreate(BeastBuyTip):Open(tab);


    else
        Notify.ShowText("You can't deploy anymore");
    end


end

--@ling autofun
function BeastInfoPanel:HandleEquipSort(go, x, y, i)
    local panel = lua_panelMgr:GetPanel(BeastEquipPanel);
    if panel then
        panel:Close();
    end
    lua_panelMgr:GetPanelOrCreate(BeastEquipPanel):Open(i);
end
function BeastInfoPanel:UpdateReddot()
    local red_dot_list = self.model.red_dot_list;
    if self.summon_reddot then
        if self.model:GetSummonReddot() then
            self.summon_reddot:SetRedDotParam(true);
        else
            self.summon_reddot:SetRedDotParam(false);
        end
    end
    if self.strength_reddot then
        self.strength_reddot:SetRedDotParam(red_dot_list[2] and self.strength.enabled);
    end

    if self.bag_reddot then
        --if red_dot_list[4][self.model.currentBeastEquip] then
        --    local flag = false;
        --    for k, v in pairs(red_dot_list[4][self.model.currentBeastEquip]) do
        --        if v then
        --            flag = true;
        --        end
        --    end
        --    if flag then
        --        self.bag_reddot:SetRedDotParam(true);
        --    else
        --        self.bag_reddot:SetRedDotParam(false);
        --    end
        --end
        if self.model:GetCanUpdateReddot(self.model.currentBeastEquip) or self.model:GetCanEquipReddot(self.model.currentBeastEquip) then
            self.bag_reddot:SetRedDotParam(true);
        else
            self.bag_reddot:SetRedDotParam(false);
        end
    end
    if self.items then
        for i = 1, #self.items do
            if self.model:GetSummonReddot(i) or self.model:GetCanUpdateReddot(i) or self.model:GetCanEquipReddot(i) then
                self.items[i]:ShowReddot(true);
            else
                self.items[i]:ShowReddot(false);
            end
        end
    end

end
function BeastInfoPanel:CalcScore(item)
    if item and item.data then
        local beastID = item.data.id;
        local score = item.data.score or 0;
        local beastData = self.model.EmbedEquips[beastID];
        if beastData then
            if beastData.summon then
                item:SetIsAssist(true);
                item:SetGray(false);
            else
                item:SetIsAssist(false);
                item:SetGray(true);
            end

            local propTab = {};
            if beastData.equips then
                --for k,v in pairs(beastData.equips) do
                --    score = score + v.score;
                --end
                local equips = beastData.equips;
                local index = 1;
                for i = 1, 5, 1 do
                    if equips[i] then
                        score = score + equips[i].score;
                        index = index + 1
                        local p_item = equips[i];
                        local equipConfig = Config.db_beast_equip[p_item.id];
                        --if equipConfig then
                        --    local prop = String2Table(equipConfig.base);
                        --    for j = 1, #prop, 1 do
                        --        local tab2 = prop[j];
                        --        local k = tab2[1];
                        --        local v = tab2[2];
                        --        if not propTab[k] then
                        --            propTab[k] = 0;
                        --        end
                        --        propTab[k] = propTab[k] + v;
                        --    end
                        --end
                        local strengthConfig = Config.db_beast_reinforce[i .. "@" .. (equips[i].extra or 0)];
                        if strengthConfig then
                            local prop = String2Table(strengthConfig.base);
                            for j = 1, #prop, 1 do
                                local tab = prop[j];
                                local k = tab[1];
                                local v = tab[2];
                                if not propTab[k] then
                                    propTab[k] = 0;
                                end
                                propTab[k] = propTab[k] + v;
                            end
                        end
                    end
                end
                for k, v in pairs(propTab) do
                    local tab3 = Config.db_beast_equip_score[k];
                    if tab3 then
                        score = score + v * tonumber(tab3.ratio);
                    else
                        print2("k = " .. k);
                    end
                end
                if index > 5 then
                    self.defaultSelectedIndex = beastID;
                end
            end
            if beastData.summon then
                item:SetScoreText("Rating: " .. math.ceil(score));
            else
                item:SetScoreText("<color=#" .. ColorUtil.GetColor(ColorUtil.ColorType.GrayWhite) .. ">" .. "Rating: " .. score .. "</color>");
            end

        else
            item:SetIsAssist(false);
            item:SetScoreText("<color=#" .. ColorUtil.GetColor(ColorUtil.ColorType.GrayWhite) .. ">" .. "Rating: " .. score .. "</color>");
            item:SetGray(true);
        end
    end
end