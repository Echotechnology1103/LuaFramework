---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by win 10.
--- DateTime: 19/01/02 15:05
---
BeastPanel = BeastPanel or class("BeastPanel", WindowPanel)
local this = BeastPanel
local ConfigLanguage = require('game.config.language.CnLanguage');



function BeastPanel:ctor()
    self.abName = "beast";
    self.image_ab = "beast_image";
    self.assetName = "BeastPanel"
    self.layer = "UI"
    self.panel_type = 2;
    self.model = BeastModel.GetInstance()
    self.events = {};
    self.schedules = {};

    self.beastInfoPanel = nil
    self.illustrationPanel = nil

    self.sidebar_data = {
        { text = ConfigLanguage.Beast.BEAST_PANEL, id = 1, icon = "bag:bag_icon_bag_s", dark_icon = "bag:bag_icon_bag_n",
        show_lv = GetSysOpenDataById("300@1"), 
        show_task = GetSysOpenTaskById("300@1"),
        open_lv = GetSysOpenDataById("300@1"), 
        open_task = GetSysOpenTaskById("300@1"),
        },
        { text = ConfigLanguage.Beast.BEAST_ILLUSTRATION, id = 2,img_title = "illustration:title_ill", icon = "bag:bag_icon_bag_s", dark_icon = "bag:bag_icon_bag_n",
        show_lv = GetSysOpenDataById("1600@1"), 
        show_task = GetSysOpenTaskById("1600@1"),
        open_lv = GetSysOpenDataById("1600@1"), 
        open_task = GetSysOpenTaskById("1600@1"),
        },
            
        --{ text = ConfigLanguage.Beast.OTHER, id = 2, icon = "bag:bag_icon_ware_s", dark_icon = "bag:bag_icon_ware_n", },
    }
end

function BeastPanel:dctor()
    self.model = nil;
    GlobalEvent:RemoveTabListener(self.events);
    self:StopAllSchedules()
    --[[ if self.currentView then
        self.currentView:destroy();
    end ]]
    if self.beastInfoPanel then
        self.beastInfoPanel:destroy()
        self.beastInfoPanel = nil
    end
    if self.illustrationPanel then
        self.illustrationPanel:destroy()
        self.illustrationPanel = nil
    end
    destroyTab(self.items);
    self.items = {};

    --GlobalEvent:Brocast(GoodsEvent.CloseTipView)
end

function BeastPanel:Open(data)
    self.data = data;
    WindowPanel.Open(self)
end

function BeastPanel:OpenCallBack()
    if self.data.openPanelIndex then
        self:SetTabIndex(self.data.openPanelIndex)
    end
end

function BeastPanel:LoadCallBack()
    self.nodes = {

    }
    self:GetChildren(self.nodes)

    SetLocalPosition(self.transform, 0, 0, 0)

    self:SetTileTextImage(self.image_ab, "beast_title_text");
    self:InitUI();

    self:AddEvent();

    BeastCtrl:GetInstance():RequestBeastList();
    BagController:GetInstance():RequestBagInfo(BagModel.beast);
    self:SetSidebarLast();
    self:UpdateReddot();
end

function BeastPanel:InitUI()

end

function BeastPanel:AddEvent()
    AddEventListenerInTab(BeastEvent.UpdateRedDot, handler(self, self.UpdateReddot), self.events);
end

function BeastPanel:StopAllSchedules()
    for i = 1, #self.schedules, 1 do
        GlobalSchedule:Stop(self.schedules[i]);
    end
    self.schedules = {};
end

function BeastPanel:SwitchCallBack(index, toggle_id, update_toggle)
    if self.child_node then
        self.child_node:SetVisible(false)
    end
    --self.currentView = nil;
    if index == 1 then
      --[[   if self.currentView then
            self.currentView:destroy();
        end
        self.currentView = BeastInfoPanel(self.child_transform); ]]
        self.beastInfoPanel = self.beastInfoPanel or BeastInfoPanel(self.child_transform)
        self.selectedIndex = 1;
        self:PopUpChild(self.beastInfoPanel);

        self.is_show_money = { Constant.GoldType.Gold, Constant.GoldType.BGold, Constant.GoldType.Coin } 
        self.bg_win:SetMoney(self.is_show_money)

    elseif index == 2 then
       --[[  if self.currentView then
            self.currentView:destroy();
        end
        self.currentView = illustrationPanel(self.child_transform); ]]
        self.illustrationPanel = self.illustrationPanel or illustrationPanel(self.child_transform)
        self.selectedIndex = 2;
        self:PopUpChild(self.illustrationPanel);

        self.is_show_money = { Constant.GoldType.Gold, Constant.GoldType.BGold, Constant.GoldType.illusEssence } 
        self.bg_win:SetMoney(self.is_show_money)


        local function call_back(  )
            --隐藏图鉴精华后的加号
            SetVisible(self.bg_win.money_list[3].btn_add,false)
        end
        GlobalSchedule:StartOnce(call_back,0)
       

    elseif index == 3 then

        self.selectedIndex = 3;

    elseif index == 4 then
        self.selectedIndex = 4;
    end
  
end

function BeastPanel:UpdateReddot()
    local tab = BeastModel:GetInstance().red_dot_list;
    local flag = self.model:IsMainReddot()
    if self.model:IsMainReddot() then
        self:SetIndexRedDotParam(1, true);
    else
        self:SetIndexRedDotParam(1, false);
    end

    local flag = illustrationModel.GetInstance():CheckReddotByAll()
    local flag2 = illustrationModel.GetInstance():CheckDecomposeReddot()
    self:SetIndexRedDotParam(2, flag or flag2);
end