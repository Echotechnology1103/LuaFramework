CurrentSceneScript = {}

CurrentSceneScript.SmallBoss = {					--小BOSS坐标
	{x = -445, y = -544, dir = 0},
    {x = 525, y = -430, dir = 0},
    {x = 440, y = 450, dir = 0},
    {x = -468, y = 308, dir = 0},
}

CurrentSceneScript.BigBoss = {						--大BOSS坐标
	x = -60, y = -81, dir = 0
}

CurrentSceneScript.Treasure = {						--宝箱坐标
{x=-611,y=-543,dir=0},
{x=-547,y=-560,dir=0},
{x=-532,y=-644,dir=0},
{x=-574,y=-472,dir=0},
{x=-524,y=-503,dir=0},
{x=-433,y=-626,dir=0},
{x=-323,y=-621,dir=0},
{x=-316,y=-489,dir=0},
{x=-385,y=-561,dir=0},
{x=-692,y=-225,dir=0},
{x=-534,y=-423,dir=0},
{x=-737,y=-137,dir=0},
{x=-755,y=-205,dir=0},
{x=-639,y=-88,dir=0},
{x=-720,y=-61,dir=0},
{x=-668,y=-155,dir=0},
{x=-327,y=-438,dir=0},
{x=-263,y=-618,dir=0},
{x=-311,y=-560,dir=0},
{x=-125,y=-677,dir=0},
{x=-42,y=-740,dir=0},
{x=-196,y=-620,dir=0},
{x=-15,y=-602,dir=0},
{x=-75,y=-667,dir=0},
{x=-89,y=-727,dir=0},
{x=29,y=-742,dir=0},
{x=119,y=-735,dir=0},
{x=67,y=-729,dir=0},
{x=4,y=-696,dir=0},
{x=20,y=-591,dir=0},
{x=86,y=-612,dir=0},
{x=124,y=-691,dir=0},
{x=44,y=-664,dir=0},
{x=126,y=-657,dir=0},
{x=-6,y=-662,dir=0},
{x=165,y=-649,dir=0},
{x=287,y=-580,dir=0},
{x=384,y=-617,dir=0},
{x=288,y=-514,dir=0},
{x=436,y=-600,dir=0},
{x=327,y=-555,dir=0},
{x=378,y=-425,dir=0},
{x=282,y=-476,dir=0},
{x=476,y=-532,dir=0},
{x=392,y=-553,dir=0},
{x=391,y=-471,dir=0},
{x=580,y=-515,dir=0},
{x=653,y=-544,dir=0},
{x=636,y=-464,dir=0},
{x=597,y=-465,dir=0},
{x=618,y=-526,dir=0},
{x=538,y=-398,dir=0},
{x=514,y=-489,dir=0},
{x=460,y=-458,dir=0},
{x=491,y=-376,dir=0},
{x=429,y=-428,dir=0},
{x=308,y=-451,dir=0},
{x=538,y=-268,dir=0},
{x=509,y=-333,dir=0},
{x=608,y=-176,dir=0},
{x=689,y=-143,dir=0},
{x=589,y=-84,dir=0},
{x=735,y=-87,dir=0},
{x=726,y=80,dir=0},
{x=641,y=-19,dir=0},
{x=703,y=128,dir=0},
{x=661,y=181,dir=0},
{x=651,y=45,dir=0},
{x=613,y=-126,dir=0},
{x=658,y=98,dir=0},
{x=400,y=310,dir=0},
{x=443,y=277,dir=0},
{x=334,y=252,dir=0},
{x=348,y=488,dir=0},
{x=375,y=422,dir=0},
{x=668,y=556,dir=0},
{x=647,y=615,dir=0},
{x=610,y=550,dir=0},
{x=533,y=538,dir=0},
{x=451,y=563,dir=0},
{x=500,y=450,dir=0},
{x=429,y=406,dir=0},
{x=421,y=500,dir=0},
{x=58,y=85,dir=0},
{x=-90,y=-175,dir=0},
{x=-179,y=-183,dir=0},
{x=77,y=-195,dir=0},
{x=-77,y=-129,dir=0},
{x=-180,y=75,dir=0},
{x=-64,y=53,dir=0},
{x=-46,y=-18,dir=0},
{x=29,y=-104,dir=0},
{x=-264,y=-339,dir=0},
{x=-242,y=19,dir=0},
{x=-625,y=61,dir=0},
{x=-671,y=46,dir=0},
{x=-589,y=178,dir=0},
{x=-618,y=121,dir=0},
{x=-537,y=423,dir=0},
{x=-460,y=358,dir=0},
{x=-552,y=374,dir=0},
{x=-466,y=295,dir=0},
{x=-539,y=273,dir=0},
{x=-432,y=351,dir=0},
{x=-306,y=471,dir=0},
{x=-252,y=488,dir=0},
{x=-363,y=195,dir=0},
{x=-208,y=556,dir=0},
{x=-142,y=517,dir=0},
{x=-181,y=645,dir=0},
{x=-131,y=605,dir=0},
{x=-35,y=571,dir=0},
{x=-25,y=638,dir=0},
{x=-18,y=703,dir=0},
{x=-90,y=577,dir=0},
{x=-113,y=643,dir=0},
{x=25,y=567,dir=0},
{x=17,y=632,dir=0},
{x=75,y=562,dir=0},
{x=25,y=693,dir=0},
{x=58,y=660,dir=0},
{x=40,y=601,dir=0},
{x=104,y=567,dir=0},
{x=195,y=542,dir=0},
{x=235,y=506,dir=0},
{x=466,y=345,dir=0},
{x=-669,y=-51,dir=0},

}

CurrentSceneScript.Statue = {
	[10000082] = {x = 658, y = 130, dir = 0, owner = 0, buff = 1013014},--4个buff柱子
	[10000083] = {x = 365, y = -539, dir = 0, owner = 0, buff = 1013015},
	[10000084] = {x = -612, y = 131, dir = 0, owner = 0, buff = 1013016},
	[10000085] = {x = -207, y = 534, dir = 0, owner = 0, buff = 1013017},
}


CurrentSceneScript.LastTime = 3600					--活动持续时间
CurrentSceneScript.StartTime = 10 					--准备时间
CurrentSceneScript.TreasureTime = 5 * 60			--宝箱活动持续时间
CurrentSceneScript.TreasureId = 704					--宝箱采集物ID
CurrentSceneScript.TreasureInteral = 60				--宝箱刷新间隔
CurrentSceneScript.TreasureNum = 100				--宝箱数量
CurrentSceneScript.TreasureRobbPerc = 0.2			--宝箱抢夺百分比


CurrentSceneScript.status = 0
CurrentSceneScript.BossStatus = {
	0,
	0,
	0,
	0,
	0,
}

CurrentSceneScript.BossKiller = {
	0,
	0,
	0,
	0,
	0,
}

CurrentSceneScript.LastTid = nil
CurrentSceneScript.StartTid = nil
CurrentSceneScript.AvgLv = "1"
CurrentSceneScript.CurTreasurePos = {}
CurrentSceneScript.Remain = CurrentSceneScript.LastTime
CurrentSceneScript.TreasureRemain = 0
CurrentSceneScript.ModScript = nil
CurrentSceneScript.Close = false
CurrentSceneScript.Lv = 1
CurrentSceneScript.Mems = {}


function CurrentSceneScript:Startup()
	_RegSceneEventHandler(SceneEvents.HumanEnterWorld, "OnHumanEnter")
	_RegSceneEventHandler(SceneEvents.HumanKilled,"OnHumanKilled")
	_RegSceneEventHandler(SceneEvents.HumanLeaveWorld, "OnHumanLeave")
	_RegSceneEventHandler(SceneEvents.MonsterKilled,"OnMonsterKilled")
	_RegSceneEventHandler(SceneEvents.CrossBossGather, "OnHumanGater")
	_RegSceneEventHandler(SceneEvents.MonsterEnterWorld, "OnMonsterEnter")

	self.ModScript = self.Scene:GetModScript()
	self.LastTid = self.ModScript:CreateTimer(self.LastTime, "OnEndTimer");
	self.StartTid = self.ModScript:CreateTimer(self.StartTime, "OnStartTimer")
	self.ModScript:CreatePeriodTimer(1, 1, "OnSecondsTimer")
end

function CurrentSceneScript:Cleanup() 
	self.ModScript = nil
	self.Treasure = nil
	self.CurTreasurePos = nil
	self.Mems = nil
end

function CurrentSceneScript:OnHumanEnter(human)
	human:GetModCrossBoss():OnEnter()

	self.ModScript:BcCrossBossStatus(self:GetStatus(), human:GetID())

	local groupId = human:GetGroupId()
	for k,v in pairs(self.Statue) do
		if groupId == v.owner then
			self.ModScript:AddAura(human, v.buff)
		end
	end

	if self.Mems[groupId] == nil then
		self.Mems[groupId] = {}
	end

	self.Mems[groupId][human:GetID()] = human

end

function CurrentSceneScript:OnHumanLeave(human)
	human:GetModCrossBoss():OnLeave()

	local groupId = human:GetGroupId()
	if self.Mems[groupId] ~= nil then
		self.Mems[groupId][human:GetID()] = nil
	end
end

function CurrentSceneScript:OnHumanKilled(human, killer)
	if self.status ~= 3 or self.Close then return end

	local killerPlayer = self.ModScript:Unit2Human(killer)
	if killerPlayer == nil then return end

	local curscore = human:GetModCrossBoss():GetScore()
	local killscore = killerPlayer:GetModCrossBoss():GetScore()

	local nRobScore = math.ceil(self.TreasureRobbPerc * curscore)

	killerPlayer:GetModCrossBoss():SetScore(killscore + nRobScore)
	human:GetModCrossBoss():SetScore(curscore - nRobScore)
end

function CurrentSceneScript:OnMonsterKilled(monster, killer)
	local cfgId		= monster:GetMonId()
	local cfgInfo	= self.Statue[cfgId]
	if cfgInfo ~= nil then
		local killerPlayer = self.ModScript:Unit2Human(killer)
		if killerPlayer then
			if cfgInfo.owner ~= nil and cfgInfo.owner ~= 0 then
				for id,human in pairs(self.Mems[cfgInfo.owner]) do
					self.ModScript:DelAura(human, cfgInfo.buff)
				end
			end
			cfgInfo.owner = killerPlayer:GetGroupId()	
			for id,human in pairs(self.Mems[cfgInfo.owner]) do
				self.ModScript:AddAura(human, cfgInfo.buff)
			end
			self.ModScript:BcCrossBossStatus(self:GetStatus(), 0)
		end
	else
		local idx = monster:GetSpawnParam()
		self.BossStatus[idx] = 2
		self.BossKiller[idx] = killer:GetID()

		if idx == 5 then
			self.ModScript:CrossSendNotice(11632, "5," .. killer:GetName())
		else
			self.ModScript:CrossSendNotice(11631, "5," .. killer:GetName() .. "#8," .. monster:GetMonId())
		end

		if self:IsAllBossKilled() then
			self:OnTreasure()
		elseif self:IsAllSmallBossKilled() then
			self:OnBigBoss()
		end

		self.ModScript:OnCrossBossKilled(monster, killer)
		self.ModScript:BcCrossBossStatus(self:GetStatus(), 0)
	end

end

function CurrentSceneScript:OnMonsterEnter(monster)
	local cfgId		= monster:GetMonId()
	local cfgInfo	= self.Statue[cfgId]
	if cfgInfo == nil then return end

	if cfgInfo.owner ~= nil and cfgInfo.owner ~= 0 then
		monster:SetBelong(MonsterBelongType.Belong_Server, cfgInfo.owner, true)
	end

end

function CurrentSceneScript:OnEndTimer(tid)
	self:OnEnd()
end

function CurrentSceneScript:OnStartTimer(tid)
	self.status = 1

	self.Lv = self.ModScript:GetCrossBossParam()
	self.AvgLv = tostring(self.Lv)
	local cfg = KuafubossConfig[self.AvgLv]

	self.Scene:GetModSpawn():SpawnExt(cfg['monster1'], self.SmallBoss[1].x, self.SmallBoss[1].y, self.SmallBoss[1].dir, 1)
	self.Scene:GetModSpawn():SpawnExt(cfg['monster2'], self.SmallBoss[2].x, self.SmallBoss[2].y, self.SmallBoss[2].dir, 2)
	self.Scene:GetModSpawn():SpawnExt(cfg['monster3'], self.SmallBoss[3].x, self.SmallBoss[3].y, self.SmallBoss[3].dir, 3)
	self.Scene:GetModSpawn():SpawnExt(cfg['monster4'], self.SmallBoss[4].x, self.SmallBoss[4].y, self.SmallBoss[4].dir, 4)

	self.BossStatus[1] = 1
	self.BossStatus[2] = 1
	self.BossStatus[3] = 1
	self.BossStatus[4] = 1

	self.ModScript:BcCrossBossStatus(self:GetStatus(), 0)

	self.ModScript:CrossSendNotice(11629, "")

	for k, v in pairs(self.Statue) do
		self.Scene:GetModSpawn():NewMonster(k, v.x, v.y, v.dir, 0)
	end
end

function CurrentSceneScript:OnEnd()
	if self.Close then return end

	self.ModScript:OnCrossBossEnd()

	self.ModScript:CreateTimer(30, "OnLeaveTimer")

	self.Close = true
end

function CurrentSceneScript:OnBigBoss()
	self.status = 2

	local cfg = KuafubossConfig[self.AvgLv]

	self.Scene:GetModSpawn():SpawnExt(cfg['boss'], self.BigBoss.x, self.BigBoss.y, self.BigBoss.dir, 5)
	self.BossStatus[5] = 1

	self.ModScript:CrossSendNotice(11630, "")
end

function CurrentSceneScript:OnTreasure()
	self.status = 3

	self.ModScript:CreateTimer(self.TreasureTime, "OnTreasureEnd");
	self.ModScript:CreatePeriodTimer(self.TreasureInteral, self.TreasureInteral, "RefreshTreasure")

	self:RefreshTreasure(0)
end

function CurrentSceneScript:OnTreasureEnd(tid)
	self:OnEnd()
end

function CurrentSceneScript:RefreshTreasure(tid)

	self.Scene:RemoveAllCollections()

	self.CurTreasurePos = {}
	for k, v in pairs(self.Treasure) do
		table.insert(self.CurTreasurePos, v)
	end

	local getGatherPos = function()
			if #self.CurTreasurePos <=0 then return nil end
			local idx = math.random(1, #self.CurTreasurePos)
			local pos = self.CurTreasurePos[idx]
			table.remove(self.CurTreasurePos, idx)
			return pos
	end

	local modSpawn = self.Scene:GetModSpawn()
	for i = 1, self.TreasureNum do
		local pos = getGatherPos()
		if pos ~= nil then
			modSpawn:SpawnCollection(
				self.TreasureId, 
				pos.x, 
				pos.y,
				pos.dir)
		end
	end

	self.ModScript:CrossSendNotice(11634, "")

	self.TreasureRemain = self.TreasureInteral
end

function CurrentSceneScript:OnSecondsTimer(tid)
	self.Remain = self.Remain - 1
	self.ModScript:BcCrossBossRank(0)

	if self.status == 3 then
		self.TreasureRemain = self.TreasureRemain - 1
	end
end

function CurrentSceneScript:OnLeaveTimer(tid)
	self.ModScript:OnCrossLeave()
end

function CurrentSceneScript:OnHumanGater(human, id)
	if self.status ~= 3 or self.Close then return end

	local nCruScore = human:GetModCrossBoss():GetScore()
	nCruScore = nCruScore + 1

	human:GetModCrossBoss():SetScore(nCruScore)
end

function CurrentSceneScript:IsAllSmallBossKilled()
	for i = 1, 4 do
		if self.BossStatus[i] ~= 2 then
			return false
		end
	end

	return true
end

function CurrentSceneScript:IsAllBossKilled()
	for i = 1, 5 do
		if self.BossStatus[i] ~= 2 then
			return false
		end
	end

	return true
end

function CurrentSceneScript:GetStatus()
	local retInfo = {}
	retInfo.remain = self.Remain
	retInfo.status = self.status
	retInfo.lv = self.Lv
	retInfo.bossStatus = {}
	retInfo.bossKiller = {}
	retInfo.statue = {}
	for i = 0, 5 do
		table.insert(retInfo.bossStatus, self.BossStatus[i])
		table.insert(retInfo.bossKiller, self.BossKiller[i])
	end

	table.insert(retInfo.statue, self.Statue[10000082].owner)
	table.insert(retInfo.statue, self.Statue[10000083].owner)
	table.insert(retInfo.statue, self.Statue[10000084].owner)
	table.insert(retInfo.statue, self.Statue[10000085].owner)

	return retInfo
end
